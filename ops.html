<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Configuring Merino (Operations) - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">General Documentation</li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item expanded "><a href="firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="ops.html" class="active"><strong aria-hidden="true">3.</strong> Configuring Merino (Operations)</a></li><li class="chapter-item expanded "><a href="data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="dev/index.html"><strong aria-hidden="true">5.</strong> Working on the code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/dependencies.html"><strong aria-hidden="true">5.1.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="dev/logging-and-metrics.html"><strong aria-hidden="true">5.2.</strong> Logging and Metrics</a></li><li class="chapter-item expanded "><a href="dev/testing.html"><strong aria-hidden="true">5.3.</strong> Testing Strategies</a></li><li class="chapter-item expanded "><a href="dev/release-process.html"><strong aria-hidden="true">5.4.</strong> Release Process</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="configuring-merino-operations"><a class="header" href="#configuring-merino-operations">Configuring Merino (Operations)</a></h1>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<p>Merino's settings are managed via Dynaconf and can be specified in two ways: by a
TOML file in the <code>merino/configs/</code> directory, or via environment variables. Environment
variables take precedence over the values set in the TOML files. TOML files set with the
same environment name that is currently activated also automatically override defaults.
Any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.
Read below for more specific details.</p>
<h3 id="file-organization"><a class="header" href="#file-organization"><a href="#file-organization">File organization</a></a></h3>
<p>These are the settings sources, with later sources overriding earlier ones.</p>
<ul>
<li>
<p>A <code>config.py</code> file establishes a Dynaconf instance and environment-specific values
are pulled in from the corresponding TOML files and environment variables. Other
configurations are established by files that are prefixed with <code>config_*.py</code>,
such as <code>config_sentry.py</code> or <code>config_logging.py</code>.</p>
</li>
<li>
<p>Per-environment configuration files are in the <code>configs</code> directory. The environment
is selected using the environment variable <code>MERINO_ENV</code>. The settings for
that environment are then loaded from <code>configs/${env}.toml</code>, if the file/env exists. The
default environment is &quot;development&quot;. A &quot;production&quot; environment is also
provided.</p>
</li>
<li>
<p>Local configuration files are not checked into the repository, but if created should be named
<code>configs/development.local.toml</code>, following the format of <code>&lt;environment&gt;.local.toml</code>.
This file is listed in the <code>.gitignore</code> file and is safe to use for local configuration.
One may secrets here if desired, though it is advised to exercise great caution.</p>
</li>
</ul>
<h3 id="general"><a class="header" href="#general">General</a></h3>
<ul>
<li>
<p>All environments are prefixed with <code>MERINO_</code>. This is established in the
<code>config.py</code> file by setting the <code>envvar_prefix=&quot;MERINO&quot;</code> for the Dynaconf
instance. The first level following <code>MERINO_</code> is accessed with a single underscore <code>_</code>
and any subsequent levels require two underscores <code>__</code>. For example,
the logging format can be controlled from the environment variable
<code>MERINO_LOGGING__FORMAT</code>.</p>
</li>
<li>
<p>Production environment variables are set by SRE and stored in the
cloudops project in the <code>configmap.yml</code> file. Contact SRE if you require
information or access on this file, or request access to the cloudops infra
repo.</p>
</li>
<li>
<p>You can set these environment variables in your setup by modifying the <code>.toml</code> files.
Conversely, when using <code>make</code>, you can prefix <code>make run</code> with overrides to the
desired environment variables using CLI flags.</p>
<p>Example:
<code>MERINO_ENV=production MERINO_LOGGING__FORMAT=pretty make dev</code></p>
</li>
<li>
<p><code>env</code> (<code>MERINO_ENV</code>) - Only settable from environment variables. Controls
which environment configuration is loaded, as described above.</p>
</li>
<li>
<p><code>debug</code> (<code>MERINO_DEBUG</code>) - Boolean that enables additional features to debug
the application. This should not be set to true in public environments, as it
reveals all configuration, including any configured secrets.</p>
</li>
<li>
<p><code>format</code> (<code>MERINO_LOGGING__FORMAT</code>) - Controls the format of outputted logs in
either <code>pretty</code> or <code>mozlog</code> format. See <a href="../merino/config_logging.py">../config_logging.py</a>.</p>
</li>
</ul>
<h3 id="logging"><a class="header" href="#logging">Logging</a></h3>
<p>Settings to control the format and amount of logs generated.</p>
<ul>
<li>
<p><code>logging.format</code> (<code>MERINO_LOGGING__FORMAT</code>) - The format to emit logs in. One of</p>
<ul>
<li><code>pretty</code> (default in development) - Multiple lines per event, human-oriented
formatting and color.</li>
<li><code>mozlog</code> (default in production) - A single line per event, formatted as
JSON in <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a> format.</li>
</ul>
</li>
<li>
<p><code>logging.level</code> (<code>MERINO_LOGGING__LEVEL</code>) - Minimum level of logs that should
be reported. This should be a number of <em>entries</em> separated by commas (for
environment variables) or specified as list (TOML).</p>
<p>Each entry can be one of <code>CRITICAL</code>, <code>ERROR</code>, <code>WARN</code>, <code>INFO</code>,  or <code>DEBUG</code> (in
increasing verbosity).</p>
</li>
</ul>
<h3 id="metrics"><a class="header" href="#metrics">Metrics</a></h3>
<p>Settings for Statsd/Datadog style metrics reporting.</p>
<ul>
<li>
<p><code>metrics.host</code> (<code>MERINO_METRICS__HOST</code>) - The IP or hostname to send metrics
to over UDP. Defaults to localhost.</p>
</li>
<li>
<p><code>metrics.port</code> (<code>MERINO_METRICS__PORT</code>) - The port to send metrics to over
UDP. Defaults to 8092.</p>
</li>
<li>
<p><code>metrics.dev_logger</code> (<code>MERINO_METRICS__DEV_LOGGER</code>) - Whether or not to send
metrics over to the logger. Should only be used for non-production environments.</p>
</li>
</ul>
<h3 id="sentry"><a class="header" href="#sentry">Sentry</a></h3>
<p>Error reporting via Sentry.</p>
<ul>
<li><code>sentry.mode</code> (<code>MERINO_SENTRY__MODE</code>) - The type of Sentry integration to
enable. One of <code>release</code>, <code>debug</code>, or <code>disabled</code>. The <code>debug</code> setting
should only be used for local development.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>release</code>, then the following two settings are
required:</p>
<ul>
<li><code>sentry.dsn</code> (<code>MERINO_SENTRY__DSN</code>) - Configuration to connect to the Sentry project.</li>
<li><code>sentry.env</code> (<code>MERINO_SENTRY__ENV</code>) - The environment to report to Sentry.
Probably &quot;prod&quot;, &quot;stage&quot;, or &quot;dev&quot;.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>disabled</code>, no Sentry integration will be activated.
If it is set to <code>debug</code>, the DSN will be set to a testing value
recommended by Sentry, and extra output will be included in the logs.</p>
<h3 id="remote_settings"><a class="header" href="#remote_settings">Remote_settings</a></h3>
<p>Connection to Remote Settings. This is used by the Remote Settings suggestion
provider below.</p>
<ul>
<li>
<p><code>remote_settings.server</code> (<code>MERINO_REMOTE_SETTINGS__SERVER</code>) - The server to
sync from. Example: <code>https://firefox.settings.services.mozilla.com</code>.</p>
</li>
<li>
<p><code>remote_settings.bucket</code> (<code>MERINO_REMOTE_SETTINGS__BUCKET</code>) -
The bucket to use for Remote Settings providers if not specified in the
provider config. Example: &quot;main&quot;.</p>
</li>
<li>
<p><code>remote_settings.collection</code>
(<code>MERINO_REMOTE_SETTINGS__COLLECTION</code>) - The collection to use for
Remote Settings providers if not specified in the provider config. Example:
&quot;quicksuggest&quot;.</p>
</li>
</ul>
<h3 id="location"><a class="header" href="#location">Location</a></h3>
<p>Configuration for determining the location of users.</p>
<ul>
<li><code>location.maxmind_database</code> (<code>MERINO_LOCATION__MAXMIND_DATABASE</code>) - Path to a
MaxMind GeoIP database file.</li>
</ul>
<h3 id="provider-configuration"><a class="header" href="#provider-configuration">Provider Configuration</a></h3>
<p>The configuration for suggestion providers.</p>
<h4 id="adm-provider"><a class="header" href="#adm-provider">Adm Provider</a></h4>
<p>These are production providers that generate suggestions.</p>
<ul>
<li>Remote Settings - Provides suggestions from a RS collection, such as the
suggestions provided by adM. See also the top level configuration for Remote
Settings above.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__ADM__ENABLED_BY_DEFAULT</code>) - Whether
or not this provider is enabled by default.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__ADM__backend</code>) - The backend of the provider.
Either <code>remote-settings</code> or <code>test</code>.</li>
<li><code>resync_interval_sec</code> (<code>MERINO_PROVIDERS__ADM__RESYNC_INTERVAL_SEC</code>) - The time
between re-syncs of Remote Settings data, in seconds. Defaults to 3 hours.</li>
<li><code>cron_interval_sec</code>
(<code>MERINO_PROVIDERS__ADM__CRON_INTERVAL_SEC</code>) - The interval of the Remote
Settings cron job (in seconds). Following tasks are done in this cron job:
<ul>
<li>Resync with Remote Settings if needed. The resync interval is configured
separately by the provider. Note that this interval should be set smaller
than <code>resync_interval_sec</code> of the Remote Settings leaf provider.</li>
<li>Retry if the regular resync fails.</li>
</ul>
</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__ADM__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
</ul>
</li>
</ul>
<h4 id="wiki-fruit-provider"><a class="header" href="#wiki-fruit-provider">Wiki Fruit Provider</a></h4>
<ul>
<li>Wiki Fruit - Provides suggestions from a test provider. Should not be used
in production.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__WIKI_FRUIT__ENABLED_BY_DEFAULT</code>) - Whether
or not this provider is enabled by default.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="firefox.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="data.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="firefox.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="data.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
