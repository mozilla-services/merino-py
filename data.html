<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Data collection - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="data.html" class="active"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item "><a href="social-contract.html"><strong aria-hidden="true">4.</strong> Social contract</a></li><li class="chapter-item "><a href="dev/index.html"><strong aria-hidden="true">5.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="dev/content-moderation.html"><strong aria-hidden="true">5.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="dev/dependencies.html"><strong aria-hidden="true">5.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="dev/logging-and-metrics.html"><strong aria-hidden="true">5.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="dev/middlewares.html"><strong aria-hidden="true">5.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="dev/feature_flags.html"><strong aria-hidden="true">5.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="dev/release-process.html"><strong aria-hidden="true">5.6.</strong> Release Process</a></li><li class="chapter-item "><a href="dev/profiling.html"><strong aria-hidden="true">5.7.</strong> Profiling</a></li><li class="chapter-item "><a href="testing/index.html"><strong aria-hidden="true">5.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="testing/unit-tests.html"><strong aria-hidden="true">5.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="testing/integration-tests.html"><strong aria-hidden="true">5.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="testing/load-tests.html"><strong aria-hidden="true">5.8.3.</strong> Load Tests</a></li><li class="chapter-item "><a href="testing/contract-tests/index.html"><strong aria-hidden="true">5.8.4.</strong> Contract Tests</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="testing/contract-tests/kinto-setup.html"><strong aria-hidden="true">5.8.4.1.</strong> Kinto Setup</a></li><li class="chapter-item "><a href="testing/contract-tests/client.html"><strong aria-hidden="true">5.8.4.2.</strong> Client</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="operations/index.html"><strong aria-hidden="true">6.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/rollback.html"><strong aria-hidden="true">6.1.</strong> Rollback</a></li><li class="chapter-item "><a href="operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">6.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="operations/blocklist-wikipedia.html"><strong aria-hidden="true">6.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="operations/testfailures.html"><strong aria-hidden="true">6.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="operations/configs.html"><strong aria-hidden="true">6.5.</strong> Configs</a></li><li class="chapter-item "><a href="operations/elasticsearch.html"><strong aria-hidden="true">6.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="operations/jobs.html"><strong aria-hidden="true">6.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">6.7.1.</strong> Navigational Suggestions</a></li><li class="chapter-item "><a href="operations/jobs/dynamic-wiki-indexer.html"><strong aria-hidden="true">6.7.2.</strong> Dynamic Wikipedia Indexer</a></li><li class="chapter-item "><a href="operations/jobs/csv-remote-settings.html"><strong aria-hidden="true">6.7.3.</strong> Remote Settings CSV Uploader</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="adr/index.html"><strong aria-hidden="true">7.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">7.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="adr/0002-merino-general-response.html"><strong aria-hidden="true">7.2.</strong> General API Response</a></li><li class="chapter-item "><a href="adr/0003-test-containers.html"><strong aria-hidden="true">7.3.</strong> Adopt Testcontainers for Integration Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="data-collection"><a class="header" href="#data-collection">Data collection</a></h1>
<p>This page should list all metrics and logs that Merino is expected to emit in
production, including what should be done about them, if anything.</p>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>This list does not include any <code>DEBUG</code> level events, since those are not logged
by default in production. The level and type of the log is listed.</p>
<p>Any log containing sensitive data must include a boolean field <code>sensitive</code>
that is set to <code>true</code> to exempt it from flowing to the generally accessible
log inspection interfaces.</p>
<h3 id="merino-apis"><a class="header" href="#merino-apis">Merino APIs</a></h3>
<ul>
<li>
<p><code>INFO web.suggest.request</code> - A suggestion request is being processed. This
event will include fields for all relevant details of the request. <strong>Fields:</strong></p>
<ul>
<li><code>sensitive</code> - Always set to true to ensure proper routing.</li>
<li><code>query</code> - If query logging is enabled, the text the user typed. Otherwise an
empty string.</li>
<li><code>country</code> - The country the request came from.</li>
<li><code>region</code> - The first country subdivision the request came from.</li>
<li><code>city</code> - The city the request came from.</li>
<li><code>dma</code> - A US-only location description that is larger than city and smaller
than states, but does not align to political borders.</li>
<li><code>agent</code> - The original user agent.</li>
<li><code>os_family</code> - Parsed from the user agent. One of &quot;windows&quot;, &quot;macos&quot;,
&quot;linux&quot;, &quot;ios&quot;, &quot;android&quot;, &quot;chrome os&quot;, &quot;blackberry&quot;, or &quot;other&quot;.</li>
<li><code>form_factor</code> - Parsed from the user agent. One of &quot;desktop&quot;, &quot;phone&quot;,
&quot;tablet&quot;, or &quot;other&quot;</li>
<li><code>browser</code> - The browser and possibly version detected. Either &quot;Firefox(XX)&quot;
where XX is the version, or &quot;Other&quot;.</li>
<li><code>rid</code> - The request ID.</li>
<li>WIP <code>accepts_english</code> - True if the user's Accept-Language header includes an
English locale, false otherwise.</li>
<li><code>requested_providers</code> - A comma separated list of providers requested via
the query string, or an empty string if none were requested (in which case
the default values would be used).</li>
<li><code>client_variants</code> - Any client variants sent to Merino in the query string.</li>
<li><code>session_id</code> - A UUID generated by the client for each search session.</li>
<li><code>sequence_no</code> -  A client-side event counter (0-based) that records the query
sequence within each search session.</li>
</ul>
</li>
<li>
<p><code>INFO request.summary</code> - The application request summary that follows the <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a>
convention. This log is recorded for all incoming HTTP requests except for the
suggest API endpoint.</p>
</li>
</ul>
<ul>
<li><code>ERROR dockerflow.error_endpoint</code> - The <code>__error__</code> endpoint of the server was
called. This is used to test our error reporting system. It is not a cause for
concern, unless we receive a large amount of these records, in which case some
outside service is likely malicious or misconfigured.</li>
</ul>
<h3 id="merino-middleware-logs"><a class="header" href="#merino-middleware-logs">Merino Middleware Logs</a></h3>
<h4 id="geolocation"><a class="header" href="#geolocation">Geolocation</a></h4>
<ul>
<li><code>WARNING merino.middleware.geolocation</code> - There was an error with a geolocation lookup.</li>
</ul>
<h3 id="merino-cron-tasks"><a class="header" href="#merino-cron-tasks">Merino Cron Tasks</a></h3>
<ul>
<li><code>WARNING merino.cron</code> - There was an error while executing a cron task.</li>
</ul>
<h3 id="merino-feature-flags"><a class="header" href="#merino-feature-flags">Merino Feature Flags</a></h3>
<ul>
<li><code>ERROR merino.featureflags</code> - There was an error while attempting to assign a
feature flag for a suggest API request.</li>
</ul>
<h3 id="curated-recommendations"><a class="header" href="#curated-recommendations">Curated Recommendations</a></h3>
<ul>
<li><code>ERROR merino.curated_recommendations.corpus_backends.corpus_api_backend</code> -
Failed to get timezone for scheduled surface.</li>
<li><code>WARNING merino.curated_recommendations.corpus_backends.corpus_api_backend</code> -
Retrying CorpusApiBackend after an http client exception was raised.</li>
<li><code>ERROR GcsEngagement failed to update cache: {e}</code> - unexpected exception when updating engagement.</li>
<li><code>ERROR Curated recommendations engagement size {blob.size} &gt; {self.max_size}</code> -
Max engagement blob size is exceeded. The backend will gracefully fall back to cached data or 0's.</li>
<li><code>INFO Curated recommendations engagement unchanged since {self.last_updated}.</code> -
The engagement blob was not updated since the last check. <code>last_updated</code> is expected to be
between 0 and 30 minutes.</li>
</ul>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<blockquote>
<p>A note on timers: Statsd timers are measured in milliseconds, and are reported
as integers (at least in Cadence). Milliseconds are often not precise enough
for the tasks we want to measure in Merino. Instead, we use generic histograms
to record microsecond times. Metrics recorded in this way should have <code>-us</code>
appended to their name, to mark the units used (since we shouldn't put the
proper unit μs in metric names).</p>
</blockquote>
<ul>
<li>
<p><code>merino.providers.initialize</code> - A timer to measure the overall initialization
duration (in ms) for <em>all</em> providers.</p>
</li>
<li>
<p><code>merino.providers.initialize.&lt;provider&gt;</code> - A timer to measure the initialization
duration (in ms) for the given <code>&lt;provider&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.providers.initialize.adm</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.status_codes.&lt;status_code&gt;</code> - A counter to measure
the status codes of an HTTP method for the <code>&lt;url_path&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.status_codes.200</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.timing</code> - A timer to measure the duration (in ms)
of an HTTP method for a URL path.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.timing</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query</code> - A timer to measure the query duration (in ms) of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.adm.query</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query.timeout</code> - A counter to measure the query timeouts of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.wikipedia.query.timeout</code></p>
</li>
<li>
<p><code>merino.suggestions-per.request</code> - A histogram metric to get the distribution of
suggestions per request.</p>
</li>
<li>
<p><code>merino.suggestions-per.provider.&lt;provider_module&gt;</code> - A histogram metric to get the distribution of
suggestions returned per provider (per request).</p>
<p><strong>Example</strong>:
<code>merino.suggestions-per.provider.wikipedia</code></p>
</li>
</ul>
<h3 id="accuweather"><a class="header" href="#accuweather">AccuWeather</a></h3>
<p>The weather provider records additional metrics.</p>
<ul>
<li><code>accuweather.upstream.request.&lt;request_type&gt;.get</code> - A counter to measure the number of times an upstream request to Accuweather was made.</li>
<li><code>accuweather.request.location.not_provided</code> - A counter to measure the number of times a query was send without a location being provided, and therefore unable to process a weather request. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.fetch</code> - A timer to measure the duration (in ms) of
looking up a weather report in the cache. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.fetch.miss.locations</code> - A counter to measure the number of times weather location was not in the cache. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.fetch.miss.currentconditions</code> - A counter to measure the number of times a current conditions was not in the cache. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.fetch.miss.forecasts</code> - A counter to measure the number of times a forecast for a location was not in the cache. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.fetch.hit.{locations | currentconditions | forecasts}</code> - A counter to measure the number of times a
requested value like a location or forecast is in the cache. We don't count TTL hits explicitly, just misses. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.backend.get</code> - A timer to measure the duration (in ms) of a
request for a weather report from the backend. This metric isn't recorded for cache hits. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.store</code> - A timer to measure the duration (in ms) of
saving a weather report from the backend to the cache. This metric isn't recorded for cache hits. Sampled at 75%.</li>
<li><code>merino.providers.accuweather.query.cache.error</code> - A counter to measure the number of times the
cache store returned an error when fetching or storing a weather report. This should be 0 in
normal operation. In case of an error, the logs will include a <code>WARNING</code> with the full error
message.</li>
</ul>
<h3 id="curated-recommendations-1"><a class="header" href="#curated-recommendations-1">Curated Recommendations</a></h3>
<p>The following additional metrics are recorded when curated recommendations are requested.</p>
<ul>
<li><code>corpus_api.request.timing</code> -
A timer to measure the duration (in ms) of looking up a list of scheduled corpus items.</li>
<li><code>corpus_api.request.status_codes.{res.status_code}</code> -
A counter to measure the status codes of an HTTP request to the curated-corpus-api.</li>
<li><code>corpus_api.request.graphql_error</code> -
A counter to measure the number of GraphQL errors from the curated-corpus-api.</li>
<li><code>recommendation.engagement.update.timing</code> -
A timer to measure the duration (in ms) of updating the engagement data from GCS.</li>
<li><code>recommendation.engagement.size</code> - A gauge to track the size of the engagement blob on GCS.</li>
<li><code>recommendation.engagement.count</code> - A gauge to measure the total number of engagement records.</li>
<li><code>recommendation.engagement.{country}.count</code> - A gauge to measure the number of scheduled corpus 
items with engagement data per country.</li>
<li><code>recommendation.engagement.{country}.clicks</code> - A gauge to measure the number of clicks per country 
in our GCS engagement blob.</li>
<li><code>recommendation.engagement.{country}.impressions</code> - A gauge to measure the number of impressions
per country in our GCS engagement blob.</li>
<li><code>recommendation.engagement.last_updated</code> -
A gauge for the staleness (in seconds) of the engagement data, measured between when the data was
updated in GCS and the current time.</li>
<li><code>recommendation.prior.update.timing</code> -
A timer to measure the duration (in ms) of updating the prior data from GCS.</li>
<li><code>recommendation.prior.size</code> - A gauge to track the size of the Thompson sampling priors blob on GCS.</li>
<li><code>recommendation.prior.last_updated</code> -
A gauge for the staleness (in seconds) of the prior data, measured between when the data was
updated in GCS and the current time.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="firefox.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="social-contract.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="firefox.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="social-contract.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </body>
</html>
