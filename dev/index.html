<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Working on the code - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">General Documentation</li><li class="chapter-item expanded "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item expanded "><a href="../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="../data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="../dev/index.html" class="active"><strong aria-hidden="true">4.</strong> Working on the code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/content-moderation.html"><strong aria-hidden="true">4.1.</strong> Content Moderation</a></li><li class="chapter-item expanded "><a href="../dev/dependencies.html"><strong aria-hidden="true">4.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">4.3.</strong> Logging and Metrics</a></li><li class="chapter-item expanded "><a href="../dev/middlewares.html"><strong aria-hidden="true">4.4.</strong> Middlewares</a></li><li class="chapter-item expanded "><a href="../dev/feature_flags.html"><strong aria-hidden="true">4.5.</strong> Feature Flags</a></li><li class="chapter-item expanded "><a href="../dev/testing.html"><strong aria-hidden="true">4.6.</strong> Testing Strategies</a></li><li class="chapter-item expanded "><a href="../dev/release-process.html"><strong aria-hidden="true">4.7.</strong> Release Process</a></li><li class="chapter-item expanded "><a href="../dev/profiling.html"><strong aria-hidden="true">4.8.</strong> Profiling</a></li></ol></li><li class="chapter-item expanded "><a href="../operations/index.html"><strong aria-hidden="true">5.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operations/configs.html"><strong aria-hidden="true">5.1.</strong> Configs</a></li><li class="chapter-item expanded "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">5.2.</strong> Elasticsearch</a></li><li class="chapter-item expanded "><a href="../operations/jobs.html"><strong aria-hidden="true">5.3.</strong> Jobs</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="developer-documentation-for-working-on-merino"><a class="header" href="#developer-documentation-for-working-on-merino">Developer documentation for working on Merino</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">tl;dr</a></h2>
<p>Here are some useful commands when working on Merino.</p>
<h3 id="run-the-main-app"><a class="header" href="#run-the-main-app">Run the main app</a></h3>
<p>This project uses <a href="https://python-poetry.org/">Poetry</a> for dependency management.
See <a href="./dependencies.html">dependencies</a> for how to install Poetry on your machine.</p>
<p>Install all the dependencies:</p>
<pre><code>$ poetry install
</code></pre>
<p>Run Merino:</p>
<pre><code>$ poetry run uvicorn merino.main:app --reload

# Or you can use a shortcut
$ make run
</code></pre>
<h3 id="general-commands"><a class="header" href="#general-commands">General commands</a></h3>
<pre><code class="language-shell"># List all available make commands with descriptions
$ make help

# Just like `poetry install`
$ make install

# Run isort
$ make isort

# Run black
$ make black

# Run flake8
$ make flake8

# Run bandit
$ make bandit

# Run pydocstyle
$ make pydocstyle

# Run mypy
$ make mypy

# Run all linting checks
$ make -k lint

# Run all formatters
$ make format

# Run merino-py with the auto code reloading
$ make dev

# Run merino-py without the auto code reloading
$ make run

# Run unit and integration tests and evaluate combined coverage
$ make test

# Evaluate combined unit and integration test coverage
$ make test-coverage-check

# Run unit tests
$ make unit-tests

# List fixtures in use per unit test
$ make unit-test-fixtures

# Run integration tests
$ make integration-tests

# List fixtures in use per integration test
$ make integration-test-fixtures

# Build the docker image for Merino named &quot;app:build&quot;
$ make docker-build

# Run contract tests on existing merino-py docker image
$ make run-contract-tests

# Run contract tests, with build step
$ make contract-tests

# Run contract tests cleanup
$ make contract-tests-clean

# Run local execution of (Locust) load tests using existing merino-py docker image
$ make run-load-tests

# Run local execution of (Locust) load tests, with merino-py docker build step
$ make load-tests

# Stop and remove containers and networks for load tests
$ make load-tests-clean

# Generate documents
$ make doc

# Preview the generated documents
$ make doc-preview

# Profile Merino with Scalene
$ make profile

# Run the Wikipedia CLI job
$ make wikipedia-indexer job=$JOB   
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>You can generate documentation, both code level and book level, for Merino and
all related crates by running <code>./dev/make-all-docs.sh</code>. You'll need <a href="https://rust-lang.github.io/mdBook/">mdBook</a>,
which you can get with <code>cargo install mdbook</code>.</p>
<h2 id="local-configuration"><a class="header" href="#local-configuration">Local configuration</a></h2>
<p>The default configuration of Merino is <code>development</code>, which has human-oriented
pretty-print logging and debugging enabled. For settings that you wish to change in the
development configuration, you have two options, listed below.</p>
<blockquote>
<p>For full details, make sure to check out the documentation for
<a href="../operations/configs.html">Merino's setting system (operations/configs.md)</a>.</p>
</blockquote>
<h3 id="update-the-defaults"><a class="header" href="#update-the-defaults">Update the defaults</a></h3>
<p>Dynaconf is used for all configuration management in Merino, where
values are specified in the <code>merino/configs/</code> directory in <code>.toml</code> files. Environment variables
are set for each environment as well and can be set when using the cli to launch the
Merino service.
Environment variables take precedence over the values set in the <code>.toml</code> files, so
any environment variable set will automatically override defaults. By the same token,
any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.</p>
<p>If the change you want to make makes the system better for most development
tasks, consider adding it to <code>merino/configs/development.toml</code>, so that other developers
can take advantage of it. If you do so, you likely want to add validation to those settings
which needs to be added in <code>merino/config.py</code>, where the Dynaconf instance exists along
with its validators. For examples of the various config settings, look at <code>configs/default.toml</code>
and <code>merino/config.py</code> to see an example of the structure.</p>
<p>It is not advisable to put secrets in <code>configs/secrets.toml</code>.</p>
<h3 id="create-a-local-override"><a class="header" href="#create-a-local-override">Create a local override</a></h3>
<p>Dynaconf will use the specified values and environment variables in the
<code>merino/configs/default.toml</code> file. You can change the environment you
want to use as mentioned above, but for local changes to adapt to your
machine or tastes, you can put the configuration in <code>merino/configs/development.local.toml</code>.
This file doesn't exist by default, so you will have to create it.
Then simply copy from the other config files and make the adjustments
that you require. These files should however not be checked into source
control and are configured to be ignored, so long as they follow the <code>*.local.toml</code>
format. Please follow this convention and take extra care to not check them in
and only use them locally.</p>
<p>See the <a href="https://www.dynaconf.com/">Dynaconf Documentation</a> for more details.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../data.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../dev/content-moderation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../data.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../dev/content-moderation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
