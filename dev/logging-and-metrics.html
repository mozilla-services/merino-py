<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Logging and Metrics - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="../dev/index.html"><strong aria-hidden="true">4.</strong> Working on the code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">4.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">4.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../dev/logging-and-metrics.html" class="active"><strong aria-hidden="true">4.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">4.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">4.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/testing.html"><strong aria-hidden="true">4.6.</strong> Test Strategy</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">4.7.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">4.8.</strong> Profiling</a></li></ol></li><li class="chapter-item "><a href="../operations/index.html"><strong aria-hidden="true">5.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">5.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">5.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">5.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">5.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">5.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">5.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../operations/jobs.html"><strong aria-hidden="true">5.7.</strong> Jobs</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="../adr/index.html"><strong aria-hidden="true">6.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">6.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">6.2.</strong> General API Response</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="logging-and-metrics"><a class="header" href="#logging-and-metrics">Logging and Metrics</a></h1>
<p>To get data out of Merino and into observable systems, we use <em>metrics</em> and
<em>logging</em>. Each has a unique use case. Note that in general, because of the scale
we work at, adding a metric or log event in production is not free, and if we
are careless can end up costing quite a bit. Record what is needed, but don't go
over board.</p>
<p>All data collection that happens in production (logging at INFO, WARN, or ERROR
levels; and metrics) should be documented in <a href="../data.html"><code>docs/data.md</code></a>.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>Merino uses <a href="https://firefox-source-docs.mozilla.org/mozbase/mozlog.html">MozLog</a> for structured logging. Logs can be recorded through the
standard Python <code>logging</code> module. Merino can output logs in various formats,
including a JSON format (MozLog) for production. A pretty, human readable format
is also provided for development and other use cases.</p>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>MozLog requires that all messages have a <code>type</code> value. By convention, we use
the name of the Python module, where the log record get issued, to populate this
field. For example:</p>
<pre><code class="language-py">import logging

logger = logging.getLogger(__name__)

# The `type` field of the log record will be the same as `__name__`.
logger.info(&quot;A new log message&quot;, data=extra_fields)
</code></pre>
<p>In general, the log <em>message</em> (&quot;An empty MultiProvider was created&quot;) and the log
<em>type</em> should both tell the reader what has happened. The difference is that the
message is for humans and the type is for machines.</p>
<h3 id="levels"><a class="header" href="#levels">Levels</a></h3>
<p>Tracing provides five log levels that should be familiar. This is what we mean
by them in Merino:</p>
<ul>
<li>
<p><code>CRITICAL</code> - There was a serious error indicating that the program itself may
be unable to continue running.</p>
</li>
<li>
<p><code>ERROR</code> - There was a problem, and the task was not completable. This usually
results in a 500 being sent to the user. All error logs encountered in
production are reported to Sentry and should be considered a bug. If it isn't
a bug, it shouldn't be logged as an error.</p>
</li>
<li>
<p><code>WARNING</code> - There was a problem, but the task was able to recover. This
doesn't usually affect what the user sees. Warnings are suitable for
unexpected but &quot;in-spec&quot; issues, like a sync job not returning an empty set or
using a deprecated function. These are not reported to Sentry.</p>
</li>
<li>
<p><code>INFO</code> - This is the default level of the production service. Use for logging
that something happened that isn't a problem and we care about in production.
This is the level that Merino uses for it's one-per-request logs and sync
status messages. Be careful adding new per-request logs at this level, as they
can be expensive.</p>
</li>
<li>
<p><code>DEBUG</code> - This is the default level for developers running code locally. Use
this to give insight into how the system is working, but keep in mind that
this will be on by default, so don't be too noisy. Generally this should
summarize what's happening, but not give the small details like a log line for
every iteration of a loop. Since this is off in production, there are no cost
concerns.</p>
</li>
</ul>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>Merino metrics are reported as <a href="https://www.datadoghq.com/blog/statsd/.">Statsd</a> metrics.</p>
<p>Unlike logging, the primary way that metrics reporting can cost a lot is in
<em>cardinality</em>. The number of metric IDs we have and the combination of tag
values that we supply. Often the number of individual events doesn't matter as
much, since multiple events are aggregated together.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev/dependencies.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../dev/middlewares.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev/dependencies.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../dev/middlewares.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
