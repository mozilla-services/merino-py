version: "3"
services:
  merino:
    image: app:build
    container_name: merino
    environment:
      MERINO__ENV: "ci"
    volumes:
      - ../../dev:/tmp/dev

  locust_master:
    image: locust
    build:
      context: ../../
      dockerfile: ./tests/load/Dockerfile
    container_name: locust_master
    depends_on:
      - merino
    ports:
      - "8089:8089"
    environment:
      # Set environment variables, see https://docs.locust.io/en/stable/configuration.html#environment-variables
      LOCUST_HOST: http://merino:8000
    command: >
      --master

  locust_worker:
    image: locust
    build:
      context: ../../
      dockerfile: ./tests/load/Dockerfile
    depends_on:
      - merino
    environment:
      # Set environment variables, see https://docs.locust.io/en/stable/configuration.html#environment-variables
      LOCUST_MASTER_NODE_HOST: locust_master
      RS_QUERIES_FILE: /tmp/rs_queries.json
    volumes:
      - ./rs_queries.json:/tmp/rs_queries.json
    command: >
      --worker
