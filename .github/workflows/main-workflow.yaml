name: main-workflow # The ETE Pipeline integration depends on this name

on:
  push:
    branches:
      - main

jobs:
  run-checks:
    uses: ./.github/workflows/checks.yaml
  run-tests:
    uses: ./.github/workflows/tests.yaml
  upload-test-artifacts:
    needs: run-tests
    if: always() # Ensure the job runs even if previous jobs, like test runs, fail
    uses: ./.github/workflows/upload-test-artifacts-to-gcs.yaml
    with:
      destination: "gs://ecosystem-test-eng-metrics/merino-py/junit"
      extension: "xml"
  upload-coverage-artifacts:
    needs: run-tests
    if: always() # Ensure the job runs even if previous jobs, like test runs, fail
    uses: ./.github/workflows/upload-test-artifacts-to-gcs.yaml
    with:
      destination: "gs://ecosystem-test-eng-metrics/merino-py/coverage"
      extension: "json"
  run-docs-build:
    uses: ./.github/workflows/docs-build.yaml
  run-docs-publish-github-pages:
    needs: run-docs-build
    uses: ./.github/workflows/docs-publish-github-pages.yaml
  run-docker-image-build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Get info
        run: |
          uname -v
          docker info
      - name: Create version.json
        run: |
          printf '{"commit":"%s","version":"%s","source":"%s","build":"%s"}\n' \
          "$GITHUB_SHA" \
          "$GITHUB_REF_NAME" \
          "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" \
          "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" > version.json
      - name: Output version.json
        run: cat version.json
      - name: Build docker image
        run: make docker-build
      - name: Set docker image tag to "latest" for updates of the main branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo IMAGE_TAG=latest >> "$GITHUB_ENV"
          echo DEPLOYMENT_ENV=stage >> "$GITHUB_ENV"
      - name: Set docker image tag to the git tag for tagged builds
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo IMAGE_TAG="$GITHUB_REF_NAME" >> "$GITHUB_ENV"
          echo DEPLOYMENT_ENV=prod >> "$GITHUB_ENV"
      - name: Push the docker image to GAR
        if: env.IMAGE_TAG != ''
        uses: mozilla-it/deploy-actions/docker-push@v3.11.1
        with:
          local_image: eliot:build
          image_repo_path: ${{ secrets.DOCKER_IMAGE_PATH }}
          image_tag: ${{ env.IMAGE_TAG }}
          workload_identity_pool_project_number: ${{ vars.GCPV2_WORKLOAD_IDENTITY_POOL_PROJECT_NUMBER }}
          project_id: ${{ env.GCP_PROJECT_ID }}
          deployment_env: ${{ env.DEPLOYMENT_ENV }}
