<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Contract Tests - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../../data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="../../dev/index.html"><strong aria-hidden="true">4.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/content-moderation.html"><strong aria-hidden="true">4.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../../dev/dependencies.html"><strong aria-hidden="true">4.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../../dev/logging-and-metrics.html"><strong aria-hidden="true">4.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../../dev/middlewares.html"><strong aria-hidden="true">4.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../../dev/feature_flags.html"><strong aria-hidden="true">4.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../../dev/release-process.html"><strong aria-hidden="true">4.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../../dev/profiling.html"><strong aria-hidden="true">4.7.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../../testing/index.html"><strong aria-hidden="true">4.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../testing/unit-tests.html"><strong aria-hidden="true">4.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../../testing/integration-tests.html"><strong aria-hidden="true">4.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="../../testing/load-tests.html"><strong aria-hidden="true">4.8.3.</strong> Load Tests</a></li><li class="chapter-item expanded "><a href="../../testing/contract-tests/index.html" class="active"><strong aria-hidden="true">4.8.4.</strong> Contract Tests</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../testing/contract-tests/kinto-setup.html"><strong aria-hidden="true">4.8.4.1.</strong> Kinto Setup</a></li><li class="chapter-item "><a href="../../testing/contract-tests/client.html"><strong aria-hidden="true">4.8.4.2.</strong> Client</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../operations/index.html"><strong aria-hidden="true">5.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../operations/rollback.html"><strong aria-hidden="true">5.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">5.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../../operations/blocklist-wikipedia.html"><strong aria-hidden="true">5.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../../operations/testfailures.html"><strong aria-hidden="true">5.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../../operations/configs.html"><strong aria-hidden="true">5.5.</strong> Configs</a></li><li class="chapter-item "><a href="../../operations/elasticsearch.html"><strong aria-hidden="true">5.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../../operations/jobs.html"><strong aria-hidden="true">5.7.</strong> Jobs</a></li><li class="chapter-item "><a href="../../operations/jobs.html"><strong aria-hidden="true">5.8.</strong> Updating Remote Settings</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="../../adr/index.html"><strong aria-hidden="true">6.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">6.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../../adr/0002-merino-general-response.html"><strong aria-hidden="true">6.2.</strong> General API Response</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino-contract-tests"><a class="header" href="#merino-contract-tests">Merino Contract Tests</a></h1>
<p>This documentation describes the automated contract tests for Merino.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The tests in the <code>tests/contract</code> directory consume Merino's APIs using more opaque techniques.
These tests run against a Docker container of the service, specify settings via environment variables,
and operate on the HTTP API layer only and as such are more concerned with external contracts and behavior.
The contract tests cannot configure the server per-test.</p>
<p>The contract test suite is designed to be set up as a docker-compose CI workflow.
To simulate common use cases, the suite utilizes 6 docker containers: <code>client</code>,
<code>merino</code>, <code>kinto-setup</code>, <code>kinto</code>, <code>kinto-attachments</code>, and <code>redis</code>.</p>
<p>The following sequence diagram depicts container interactions during the
<code>remote_settings__coffee</code> test scenario.</p>
<p><strong>Test Scenario: remote_settings__coffee</strong>
<img src="./sequence_diagram.jpg" alt="Sequence diagram of the integration tests" />
<strong>Notes:</strong></p>
<ul>
<li>The interactions between <code>kinto</code> and <code>kinto-attachments</code> are not depicted.</li>
<li>The diagram was composed using <a href="https://miro.com/app/board/uXjVOje8DN4=/">Miro</a>,</li>
</ul>
<h3 id="client"><a class="header" href="#client">client</a></h3>
<p>The <code>client</code> container consists of a Python-based test framework that executes the
contract tests. The HTTP client used in the framework can be instructed to prepare
Remote Settings data through requests to kinto and can verify Merino functionality
through requests to the Merino service.</p>
<p>For more details, see the client <a href="./client.html">documentation</a>.</p>
<h3 id="merino"><a class="header" href="#merino">merino</a></h3>
<p>The <code>merino</code> container encapsulates the Merino service under test.</p>
<p>For more details, see the Merino <a href="../../intro.html">documentation</a>.</p>
<h3 id="kinto-setup"><a class="header" href="#kinto-setup">kinto-setup</a></h3>
<p>The <code>kinto-setup</code> container consists of a Python-based program responsible for
defining the Remote Settings bucket, &quot;main&quot;, and collection, &quot;quicksuggest&quot;, prior
to the <code>merino</code> container startup, a pre-requisite.</p>
<p>For more details, see the kinto-setup <a href="./kinto-setup.html">documentation</a>.</p>
<h3 id="kinto--kinto-attachments"><a class="header" href="#kinto--kinto-attachments">kinto &amp; kinto-attachments</a></h3>
<p>The <code>kinto</code> container holds a minimalist storage service with synchronisation and
sharing abilities. It uses the <code>kinto-attachments</code> container to store data locally.</p>
<p>For more details, see the Remote Settings <a href="https://remote-settings.readthedocs.io/en/latest/">documentation</a>.</p>
<h2 id="local-execution"><a class="header" href="#local-execution">Local Execution</a></h2>
<p>Local execution can be expedited by simply running <code>make contract-tests</code>, from the 
repository root. This creates the Docker containers with kinto, Merino and the test 
client and runs the test scenarios against them.</p>
<pre><code class="language-shell">make contract-tests
</code></pre>
<p>To remove contract test containers and network artifacts, execute the following from
the repository root:</p>
<pre><code class="language-shell">make contract-tests-clean
</code></pre>
<p>Failing to run this clean command between code changes may result in your changes not 
being reflected.</p>
<p>See <a href="https://github.com/mozilla-services/merino-py/blob/main/Makefile">Makefile</a> for details.</p>
<h2 id="maintenance"><a class="header" href="#maintenance">Maintenance</a></h2>
<p>The contract test maintenance schedule cadence is once a quarter and should include
updating the following:</p>
<ol>
<li><a href="https://python-poetry.org/docs/">poetry</a> version and python dependencies
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/contract/pyproject.toml">pyproject.toml</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/contract/poetry.lock">poetry.lock</a></li>
</ul>
</li>
<li><a href="https://docs.docker.com/">Docker</a> artifacts
<ul>
<li><input disabled="" type="checkbox"/>
client <a href="https://github.com/mozilla-services/merino-py/blob/main/tests/contract/client/Dockerfile">Dockerfile</a></li>
<li><input disabled="" type="checkbox"/>
kinto-setup <a href="https://github.com/mozilla-services/merino-py/blob/main/tests/contract/kinto-setup/Dockerfile">Dockerfile</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/contract/docker-compose.yml">docker-compose.yml</a></li>
</ul>
</li>
<li><a href="https://circleci.com/docs/">CircleCI</a> contract test jobs
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/.circleci/config.yml">config.yml</a></li>
</ul>
</li>
<li>Documentation
<ul>
<li><input disabled="" type="checkbox"/>
client <a href="./client.html">documentation</a></li>
<li><input disabled="" type="checkbox"/>
kinto-setup <a href="./kinto-setup.html">documentation</a></li>
<li><input disabled="" type="checkbox"/>
contract test <a href="./index.html">documentation</a></li>
</ul>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../testing/load-tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../testing/contract-tests/kinto-setup.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../testing/load-tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../testing/contract-tests/kinto-setup.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </body>
</html>
