<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Load Tests - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../manifest.html"><strong aria-hidden="true">2.</strong> Working with the Manifest file</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">3.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item "><a href="../social-contract.html"><strong aria-hidden="true">5.</strong> Social contract</a></li><li class="chapter-item expanded "><a href="../dev/index.html"><strong aria-hidden="true">6.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">6.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">6.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">6.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">6.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">6.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">6.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">6.7.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../testing/index.html"><strong aria-hidden="true">6.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/unit-tests.html"><strong aria-hidden="true">6.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../testing/integration-tests.html"><strong aria-hidden="true">6.8.2.</strong> Integration Tests</a></li><li class="chapter-item expanded "><a href="../testing/load-tests.html" class="active"><strong aria-hidden="true">6.8.3.</strong> Load Tests</a></li></ol></li></ol></li><li class="chapter-item "><a href="../operations/index.html"><strong aria-hidden="true">7.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">7.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">7.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">7.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">7.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">7.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">7.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../operations/jobs.html"><strong aria-hidden="true">7.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">7.7.1.</strong> Navigational Suggestions</a></li><li class="chapter-item "><a href="../operations/jobs/dynamic-wiki-indexer.html"><strong aria-hidden="true">7.7.2.</strong> Dynamic Wikipedia Indexer</a></li><li class="chapter-item "><a href="../operations/jobs/csv-remote-settings.html"><strong aria-hidden="true">7.7.3.</strong> Remote Settings CSV Uploader</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="../adr/index.html"><strong aria-hidden="true">8.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">8.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">8.2.</strong> General API Response</a></li><li class="chapter-item "><a href="../adr/0003-test-containers.html"><strong aria-hidden="true">8.3.</strong> Adopt Testcontainers for Integration Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino-load-locust-tests"><a class="header" href="#merino-load-locust-tests">Merino Load (Locust) Tests</a></h1>
<p>This documentation describes the load tests for Merino.
This test framework uses IP2Location LITE data available from https://lite.ip2location.com</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The tests in the <code>tests/load</code> directory spawn multiple HTTP clients that consume Merino's API,
in order to simulate real-world load on the Merino infrastructure.
These tests use the Locust framework and are triggered at the discretion of the Merino Engineering Team.</p>
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><a href="https://docs.google.com/document/d/1v7LDXENPZg37KXeNcznEZKNZ8rQlOhNbsHprFyMXHhs/edit?usp=sharing">Merino Load Test Plan</a></li>
<li><a href="https://docs.google.com/document/d/1BGNhKuclUH40Bit9KxYWLiv_N_VnE66uxi9pBFbRWbg/edit">Merino Load Test History</a></li>
<li><a href="https://docs.google.com/spreadsheets/d/1SAO3QYIrbxDRxzmYIab-ebZXA1dF06W1lT4I1h2R3a8/edit?usp=sharing">Merino Load Test Spreadsheet</a></li>
</ul>
<h2 id="local-execution"><a class="header" href="#local-execution">Local Execution</a></h2>
<p>Note that if you make changes to the load test code, you must stop and remove the Docker containers and networks for changes to reflect.
Do this by running <code>make load-tests-clean</code>.</p>
<p>Follow the steps bellow to execute the load tests locally:</p>
<h3 id="setup-environment"><a class="header" href="#setup-environment">Setup Environment</a></h3>
<h4 id="1-configure-environment-variables"><a class="header" href="#1-configure-environment-variables">1. Configure Environment Variables</a></h4>
<p>The following environment variables as well as
<a href="https://docs.locust.io/en/stable/configuration.html#environment-variables">Locust environment variables</a> can be set in
<code>tests\load\docker-compose.yml</code>.
Make sure any required API key is added but then not checked into source control.</p>
<p><strong>WARNING</strong>: if the <code>WIKIPEDIA__ES_API_KEY</code> is missing, the load tests will not execute.</p>
<div class="table-wrapper"><table><thead><tr><th>Environment Variable</th><th>Node(s)</th><th>Description</th></tr></thead><tbody>
<tr><td>LOAD_TESTS__LOGGING_LEVEL</td><td>master &amp; worker</td><td>Level for the logger in the load tests as an int (<code>10</code> for <code>DEBUG</code>, <code>20</code> for <code>INFO</code> etc.)</td></tr>
<tr><td>MERINO_REMOTE_SETTINGS__SERVER</td><td>master &amp; worker</td><td>Server URL of the Kinto instance containing suggestions</td></tr>
<tr><td>MERINO_REMOTE_SETTINGS__BUCKET</td><td>master &amp; worker</td><td>Kinto bucket with the suggestions</td></tr>
<tr><td>MERINO_REMOTE_SETTINGS__COLLECTION</td><td>master &amp; worker</td><td>Kinto collection with the suggestions</td></tr>
<tr><td>MERINO_PROVIDERS__TOP_PICKS__TOP_PICKS_FILE_PATH</td><td>master &amp; worker</td><td>The minimum character limit set for long domain suggestion indexing</td></tr>
<tr><td>MERINO_PROVIDERS__TOP_PICKS__QUERY_CHAR_LIMIT</td><td>master &amp; worker</td><td>The minimum character limit set for short domain suggestion indexing</td></tr>
<tr><td>MERINO_PROVIDERS__TOP_PICKS__FIREFOX_CHAR_LIMIT</td><td>master &amp; worker</td><td>File path to the json file of domains</td></tr>
<tr><td>MERINO_PROVIDERS__WIKIPEDIA__ES_API_KEY</td><td>master &amp; worker</td><td>The base64 key used to authenticate on the Elasticsearch cluster specified by es_cloud_id</td></tr>
<tr><td>MERINO_PROVIDERS__WIKIPEDIA__ES_URL</td><td>master &amp; worker</td><td>The Cloud ID of the Elasticsearch cluster</td></tr>
<tr><td>MERINO_PROVIDERS__WIKIPEDIA__ES_INDEX</td><td>master &amp; worker</td><td>The index identifier of Wikipedia in Elasticsearch</td></tr>
</tbody></table>
</div>
<h4 id="2-host-locust-via-docker"><a class="header" href="#2-host-locust-via-docker">2. Host Locust via Docker</a></h4>
<p>Execute the following from the repository root:</p>
<pre><code class="language-shell">make load-tests
</code></pre>
<h4 id="3-optional-host-merino-locally"><a class="header" href="#3-optional-host-merino-locally">3. (Optional) Host Merino Locally</a></h4>
<p>Use one of the following commands to host Merino locally. Execute the following from the
repository root:</p>
<ul>
<li>Option 1: Use the local development instance
<pre><code class="language-shell">make dev
</code></pre>
</li>
<li>Option 2: Use the profiler instance
<pre><code class="language-shell">make profile
</code></pre>
</li>
<li>Option 3: Use the Docker instance
<pre><code class="language-shell">make docker-build &amp;&amp; docker run -p 8000:8000 app:build
</code></pre>
</li>
</ul>
<h3 id="run-test-session"><a class="header" href="#run-test-session">Run Test Session</a></h3>
<h4 id="1-start-load-test"><a class="header" href="#1-start-load-test">1. Start Load Test</a></h4>
<ul>
<li>In a browser navigate to <code>http://localhost:8089/</code></li>
<li>Set up the load test parameters:
<ul>
<li>Option 1: Select the <code>MerinoSmokeLoadTestShape</code> or <code>MerinoAverageLoadTestShape</code>
<ul>
<li>These options have pre-defined settings</li>
</ul>
</li>
<li>Option 2: Select the <code>Default</code> load test shape with the following recommended settings:
<ul>
<li>Number of users: 25</li>
<li>Spawn rate: 1</li>
<li>Host: 'https://stagepy.merino.nonprod.cloudops.mozgcp.net'
<ul>
<li>Set host to 'http://host.docker.internal:8000' to test against a local instance of Merino</li>
</ul>
</li>
<li>Duration (Optional): 10m</li>
</ul>
</li>
</ul>
</li>
<li>Select &quot;Start Swarming&quot;</li>
</ul>
<h4 id="2-stop-load-test"><a class="header" href="#2-stop-load-test">2. Stop Load Test</a></h4>
<p>Select the 'Stop' button in the top right hand corner of the Locust UI, after the
desired test duration has elapsed. If the 'Run time' is set in step 1, the load test
will stop automatically.</p>
<h4 id="3-analyse-results"><a class="header" href="#3-analyse-results">3. Analyse Results</a></h4>
<ul>
<li>See <a href="#3-analyse-results-1">Distributed GCP Execution (Manual Trigger) - Analyse Results</a></li>
<li>Only client-side measures, provided by Locust, are available when executing against a
local instance of Merino.</li>
</ul>
<h3 id="clean-up-environment"><a class="header" href="#clean-up-environment">Clean-up Environment</a></h3>
<h4 id="1-remove-load-test-docker-containers"><a class="header" href="#1-remove-load-test-docker-containers">1. Remove Load Test Docker Containers</a></h4>
<p>Execute the following from the repository root:</p>
<pre><code class="language-shell">make load-tests-clean
</code></pre>
<h2 id="distributed-gcp-execution---manual-trigger"><a class="header" href="#distributed-gcp-execution---manual-trigger">Distributed GCP Execution - Manual Trigger</a></h2>
<p>Follow the steps bellow to execute the distributed load tests on GCP with a manual trigger:</p>
<h3 id="setup-environment-1"><a class="header" href="#setup-environment-1">Setup Environment</a></h3>
<h4 id="1-start-a-gcp-cloud-shell"><a class="header" href="#1-start-a-gcp-cloud-shell">1. Start a GCP Cloud Shell</a></h4>
<p>The load tests can be executed from the <a href="https://console.cloud.google.com/home/dashboard?q=search&amp;referrer=search&amp;project=spheric-keel-331521&amp;cloudshell=false">contextual-services-test-eng cloud shell</a>.</p>
<h4 id="2-configure-the-bash-script"><a class="header" href="#2-configure-the-bash-script">2. Configure the Bash Script</a></h4>
<ul>
<li>The <code>setup_k8s.sh</code> file, located in the <code>tests\load</code> directory, contains shell
commands to <strong>create</strong> a GKE cluster, <strong>setup</strong> an existing GKE cluster or <strong>delete</strong>
a GKE cluster
<ul>
<li>Modify the script to include the MERINO_PROVIDERS__WIKIPEDIA__ES_API_KEY
environment variables</li>
<li>Execute the following from the root directory, to make the file executable:
<pre><code class="language-shell">chmod +x tests/load/setup_k8s.sh
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 id="3-create-the-gcp-cluster"><a class="header" href="#3-create-the-gcp-cluster">3. Create the GCP Cluster</a></h4>
<ul>
<li>Execute the <code>setup_k8s.sh</code> file and select the <strong>create</strong> option, in order to
initiate the process of creating a cluster, setting up the env variables and
building the docker image. Choose smoke or average depending on the type
of load test required.
<pre><code class="language-shell">./tests/load/setup_k8s.sh create [smoke|average]
</code></pre>
<ul>
<li>Smoke - The smoke load test verifies the system's performance under minimal load. The test is
run for a short period, possibly in CD, to ensure the system is working correctly.</li>
<li>Average - The average load test measures the system's performance under standard operational conditions.
The test is meant to reflect an ordinary day in production.</li>
</ul>
</li>
<li>The cluster creation process will take some time. It is considered complete, once
an external IP is assigned to the <code>locust_master</code> node. Monitor the assignment via
a watch loop:
<pre><code class="language-bash">kubectl get svc locust-master --watch
</code></pre>
</li>
<li>The number of workers is defaulted to 5, but can be modified with the
<code>kubectl scale</code> command. Example (10 workers):
<pre><code class="language-bash">kubectl scale deployment/locust-worker --replicas=10
</code></pre>
</li>
<li>To apply new changes to an existing GCP Cluster, execute the <code>setup_k8s.sh</code> file and select the
<strong>setup</strong> option.
<ul>
<li>This option will consider the local commit history, creating new containers and
deploying them (see <a href="https://console.cloud.google.com/artifacts/docker/spheric-keel-331521/us-west1/locust-merino?project=spheric-keel-331521">Artifact Registry</a>)</li>
</ul>
</li>
</ul>
<h3 id="run-test-session-1"><a class="header" href="#run-test-session-1">Run Test Session</a></h3>
<h4 id="1-start-load-test-1"><a class="header" href="#1-start-load-test-1">1. Start Load Test</a></h4>
<ul>
<li>
<p>In a browser navigate to <code>http://$EXTERNAL_IP:8089</code></p>
<p>This url can be generated via command</p>
<pre><code class="language-bash">EXTERNAL_IP=$(kubectl get svc locust-master -o jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;)
echo http://$EXTERNAL_IP:8089
</code></pre>
</li>
<li>
<p>Select the <code>MerinoSmokeLoadTestShape</code>, this option has pre-defined settings and will last 5 minutes</p>
</li>
<li>
<p>Select &quot;Start Swarming&quot;</p>
</li>
</ul>
<h4 id="2-stop-load-test-1"><a class="header" href="#2-stop-load-test-1">2. Stop Load Test</a></h4>
<p>Select the 'Stop' button in the top right hand corner of the Locust UI, after the
desired test duration has elapsed. If the 'Run time' is set in step 1, the load test
will stop automatically.</p>
<h4 id="3-analyse-results-1"><a class="header" href="#3-analyse-results-1">3. Analyse Results</a></h4>
<p><strong>RPS</strong></p>
<ul>
<li>The request-per-second load target for Merino is <code>1500</code></li>
<li>Locust reports client-side RPS via the &quot;merino_stats.csv&quot; file and the UI
(under the &quot;Statistics&quot; tab or the &quot;Charts&quot; tab)</li>
<li><a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a> reports the server-side RPS via the
&quot;HTTP requests per second per country&quot; chart</li>
</ul>
<p><strong>HTTP Request Failures</strong></p>
<ul>
<li>The number of responses with errors (5xx response codes) should be <code>0</code></li>
<li>Locust reports Failures via the &quot;merino_failures.csv&quot; file and the UI
(under the &quot;Failures&quot; tab or the &quot;Charts&quot; tab)</li>
<li><a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a> reports Failures via the &quot;HTTP Response codes&quot; chart and the
&quot;HTTP 5xx error rate&quot; chart</li>
</ul>
<p><strong>Exceptions</strong></p>
<ul>
<li>The number of exceptions raised by the test framework should be <code>0</code></li>
<li>Locust reports Exceptions via the &quot;merino_exceptions.csv&quot; file and the UI
(under the &quot;Exceptions&quot; tab)</li>
</ul>
<p><strong>Latency</strong></p>
<ul>
<li>The HTTP client-side response time (aka request duration) for 95 percent of users
is required to be 200ms or less (<code>p95 &lt;= 200ms</code>), excluding weather requests</li>
<li>Locust reports client-side latency via the &quot;merino_stats.csv&quot; file and the UI
(under the &quot;Statistics&quot; tab or the &quot;Charts&quot; tab)
<ul>
<li><em>Warning!</em> A Locust worker with too many users will bottleneck RPS and inflate
client-side latency measures. Locust reports worker CPU and memory usage metrics via
the UI (under the &quot;Workers&quot; tab)</li>
</ul>
</li>
<li><a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a> reports server-side latency via the &quot;p95 latency&quot; chart</li>
</ul>
<p><strong>Resource Consumption</strong></p>
<ul>
<li>To conserve costs, resource allocation must be kept to a minimum. It is expected that
container, CPU and memory usage should trend consistently between load test runs.</li>
<li><a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a> reports metrics on resources via the &quot;Container Count&quot;,
&quot;CPU usage time sum&quot; and &quot;Memory usage sum&quot; charts</li>
</ul>
<h4 id="4-report-results"><a class="header" href="#4-report-results">4. Report Results</a></h4>
<ul>
<li>Results should be recorded in the <a href="https://docs.google.com/spreadsheets/d/1SAO3QYIrbxDRxzmYIab-ebZXA1dF06W1lT4I1h2R3a8/edit?usp=sharing">Merino Load Test Spreadsheet</a></li>
<li>Optionally, the Locust reports can be saved and linked in the spreadsheet:
<ul>
<li>Download the results via the Locust UI or via command:
<pre><code class="language-bash">kubectl cp &lt;master-pod-name&gt;:/home/locust/merino_stats.csv merino_stats.csv
kubectl cp &lt;master-pod-name&gt;:/home/locust/merino_exceptions.csv merino_exceptions.csv
kubectl cp &lt;master-pod-name&gt;:/home/locust/merino_failures.csv merino_failures.csv
</code></pre>
The <code>master-pod-name</code> can be found at the top of the pod list:
<pre><code class="language-bash">kubectl get pods -o wide
</code></pre>
</li>
<li>Upload the files to the <a href="https://drive.google.com/drive/folders/1rvCpmwGuLt4COH6Zw6vSyu_019_sB3Ux">ConServ</a> drive and record the links in the
spreadsheet</li>
</ul>
</li>
</ul>
<h3 id="clean-up-environment-1"><a class="header" href="#clean-up-environment-1">Clean-up Environment</a></h3>
<h4 id="1-delete-the-gcp-cluster"><a class="header" href="#1-delete-the-gcp-cluster">1. Delete the GCP Cluster</a></h4>
<p>Execute the <code>setup_k8s.sh</code> file and select the <strong>delete</strong> option</p>
<pre><code class="language-shell">./tests/load/setup_k8s.sh
</code></pre>
<h2 id="distributed-gcp-execution---ci-trigger"><a class="header" href="#distributed-gcp-execution---ci-trigger">Distributed GCP Execution - CI Trigger</a></h2>
<p>The load tests are triggered in CI via <a href="https://github.com/mozilla-services/cloudops-infra/blob/master/projects/merino/Jenkinsfile-stage-py">Jenkins</a>, which has a command overriding
the load test Dockerfile entrypoint.</p>
<p>Follow the steps below to execute the distributed load tests on GCP with a CI trigger:</p>
<h3 id="run-test-session-2"><a class="header" href="#run-test-session-2">Run Test Session</a></h3>
<h4 id="1-execute-load-test"><a class="header" href="#1-execute-load-test">1. Execute Load Test</a></h4>
<p>To modify the load testing behavior, you must include a label in your Git commit. This must be the
merge commit on the main branch, since only the most recent commit is checked for the label. The
label format is: <code>[load test: (abort|skip|warn)]</code>. Take careful note of correct syntax and spacing
within the label. There are three options for load tests: <code>abort</code>, <code>skip</code>, and <code>warn</code>:</p>
<ul>
<li>The <code>abort</code> label will prevent a prod deployment if the load test fails<br />
Ex. <code>feat: Add feature ABC [load test: abort].</code></li>
<li>The <code>skip</code> label will bypass load testing entirely during deployment<br />
Ex. <code>feat: Add feature LMN [load test: skip].</code></li>
<li>The <code>warn</code> label will output a Slack warning if the load test fails but still allow for the
production deployment<br />
Ex. <code>feat: Add feature XYZ [load test: warn].</code></li>
</ul>
<p>If no label is included in the commit message, the load test will be executed with the <code>warn</code>
action.</p>
<p>The commit tag signals load test instructions to Jenkins by modifying the Docker image tag. The
Jenkins deployment workflow first deploys to <code>stage</code> and then runs load tests if requested. The
Docker image tag passed to Jenkins appears as follows:
<code>^(?P&lt;environment&gt;stage|prod)(?:-(?P&lt;task&gt;\w+)-(?P&lt;action&gt;abort|skip|warn))?-(?P&lt;commit&gt;[a-z0-9]+)$</code></p>
<h4 id="2-analyse-results"><a class="header" href="#2-analyse-results">2. Analyse Results</a></h4>
<p>See <a href="#3-analyse-results-1">Distributed GCP Execution (Manual Trigger) - Analyse Results</a></p>
<h4 id="3-report-results"><a class="header" href="#3-report-results">3. Report Results</a></h4>
<ul>
<li>Optionally, results can be recorded in the <a href="https://docs.google.com/spreadsheets/d/1SAO3QYIrbxDRxzmYIab-ebZXA1dF06W1lT4I1h2R3a8/edit?usp=sharing">Merino Load Test Spreadsheet</a>. It
is recommended to do so if unusual behavior is observed during load test execution or if the load
tests fail.</li>
<li>The Locust reports can be saved and linked in the spreadsheet. The results are persisted in the
<code>/data</code> directory of the <code>locust-master-0</code> pod in the <code>locust-master</code> k8s cluster in the GCP
project of <code>merino-nonprod</code>. To access the Locust logs:
<ul>
<li>Open a cloud shell in the <a href="https://console.cloud.google.com/kubernetes/list/overview?project=moz-fx-merino-nonprod-ee93">Merino stage environment</a></li>
<li>Authenticate by executing the following command:
<pre><code class="language-shell">  gcloud container clusters get-credentials merino-nonprod-v1 \
    --region us-west1 --project moz-fx-merino-nonprod-ee93
</code></pre>
</li>
<li>Identify the log files needed in the Kubernetes pod by executing the following command, which
lists the log files along with file creation timestamp when the test was performed. The
<code>{run-id}</code> uniquely identifies each load test run:
<pre><code class="language-bash">  kubectl exec -n locust-merino locust-master-0 -- ls -al /data/
</code></pre>
</li>
<li>Download the results via the Locust UI or via command:
<pre><code class="language-bash">kubectl -n locust-merino cp locust-master-0:/data/{run-id}-merino_stats.csv merino_stats.csv
kubectl -n locust-merino cp locust-master-0:/data/{run-id}-merino_exceptions.csv merino_exceptions.csv
kubectl -n locust-merino cp locust-master-0:/data/{run-id}-merino_failures.csv merino_failures.csv
</code></pre>
</li>
<li>Upload the files to the <a href="https://drive.google.com/drive/folders/1rvCpmwGuLt4COH6Zw6vSyu_019_sB3Ux">ConServ</a> drive and record the links in the
spreadsheet</li>
</ul>
</li>
</ul>
<h2 id="calibration"><a class="header" href="#calibration">Calibration</a></h2>
<p>Following the addition of new features, such as a Locust Task or Locust User, or
environmental changes, such as node size or the upgrade of a major dependency like the
python version image, it may be necessary to re-establish the recommended parameters of
the performance test.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td><code>WAIT TIME</code></td><td>- Changing this cadence will increase or decrease the number of channel subscriptions and notifications sent by a MerinoUser. <br/>- The default is currently in use for the MerinoUser class.</td></tr>
<tr><td><code>TASK WEIGHT</code></td><td>- Changing this weight impacts the probability of a task being chosen for execution. <br/>- This value is hardcoded in the task decorators of the MerinoUser class.</td></tr>
<tr><td><code>USERS_PER_WORKER</code></td><td>- This value should be set to the maximum number of users a Locust worker can support given CPU and memory constraints. <br/>- This value is hardcoded in the LoadTestShape classes.</td></tr>
<tr><td><code>WORKER_COUNT</code></td><td>- This value is derived by dividing the total number of users needed for the performance test by the <code>USERS_PER_WORKER</code>. <br>- This value is hardcoded in the LoadTestShape classes and the setup_k8s.sh script.</td></tr>
</tbody></table>
</div>
<ul>
<li>Locust documentation is available for [WAIT TIME][13] and [TASK WEIGHT][14]</li>
</ul>
<h2 id="calibrating-for-users_per_worker"><a class="header" href="#calibrating-for-users_per_worker">Calibrating for USERS_PER_WORKER</a></h2>
<p>This process is used to determine the number of users that a Locust worker can support.</p>
<h3 id="setup-environment-2"><a class="header" href="#setup-environment-2">Setup Environment</a></h3>
<h4 id="1-start-a-gcp-cloud-shell-1"><a class="header" href="#1-start-a-gcp-cloud-shell-1">1. Start a GCP Cloud Shell</a></h4>
<p>The load tests can be executed from the <a href="https://console.cloud.google.com/home/dashboard?q=search&amp;referrer=search&amp;project=spheric-keel-331521&amp;cloudshell=false">contextual-services-test-eng cloud shell</a>.
If executing a load test for the first time, the git merino-py repository will need to
be cloned locally.</p>
<h4 id="2-configure-the-bash-script-1"><a class="header" href="#2-configure-the-bash-script-1">2. Configure the Bash Script</a></h4>
<ul>
<li>The <code>setup_k8s.sh</code> file, located in the <code>tests\load</code> directory, contains
shell commands to <strong>create</strong> a GKE cluster, <strong>setup</strong> an existing GKE cluster or
<strong>delete</strong> a GKE cluster
<ul>
<li>Execute the following from the root directory, to make the file executable:
<pre><code class="language-shell">chmod +x tests/load/setup_k8s.sh
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 id="3-create-the-gcp-cluster-1"><a class="header" href="#3-create-the-gcp-cluster-1">3. Create the GCP Cluster</a></h4>
<ul>
<li>In the <code>setup_k8s.sh</code> script, modify the <code>WORKER_COUNT</code> variable to equal <code>1</code></li>
<li>Execute the <code>setup_k8s.sh</code> file from the root directory and select the <strong>create</strong>
option, in order to initiate the process of creating a cluster, setting up the env
variables and building the docker image. Choose smoke or average depending on the type
of load test required.
<pre><code class="language-shell">./tests/load/setup_k8s.sh create [smoke|average]
</code></pre>
</li>
<li>The cluster creation process will take some time. It is considered complete, once
an external IP is assigned to the <code>locust_master</code> node. Monitor the assignment via
a watch loop:
<pre><code class="language-bash">kubectl get svc locust-master --watch
</code></pre>
</li>
</ul>
<h3 id="calibrate"><a class="header" href="#calibrate">Calibrate</a></h3>
<p>Repeat steps 1 to 3, using a process of elimination, such as the bisection method, to
determine the maximum <code>USERS_PER_WORKER</code>. The load tests are considered optimized when
CPU and memory resources are maximally utilized. This step is meant to determine the
maximum user count that a node can accommodate by observing CPU and memory usage while
steadily increasing or decreasing the user count. You can monitor the CPU percentage in
the Locust UI but also in the Kubernetes engine Workloads tab where both memory and CPU
are visualized on charts.</p>
<h4 id="1-start-load-test-2"><a class="header" href="#1-start-load-test-2">1. Start Load Test</a></h4>
<ul>
<li>In a browser navigate to <code>http://$EXTERNAL_IP:8089</code>
This url can be generated via command
<pre><code class="language-bash">EXTERNAL_IP=$(kubectl get svc locust-master -o jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;)
echo http://$EXTERNAL_IP:8089
</code></pre>
</li>
<li>Set up the load test parameters:
<ul>
<li>ShapeClass: Default</li>
<li>UserClasses: MerinoUser</li>
<li>Number of users: USERS_PER_WORKER (Consult the <a href="https://docs.google.com/spreadsheets/d/1SAO3QYIrbxDRxzmYIab-ebZXA1dF06W1lT4I1h2R3a8/edit?usp=sharing">Merino_spreadsheet</a> to determine a starting point)</li>
<li>Ramp up: RAMP_UP (RAMP_UP = 5/USERS_PER_WORKER)</li>
<li>Host: 'https://stagepy.merino.nonprod.cloudops.mozgcp.net'</li>
<li>Duration (Optional): 600s</li>
</ul>
</li>
<li>Select &quot;Start Swarm&quot;</li>
</ul>
<h4 id="2-stop-load-test-2"><a class="header" href="#2-stop-load-test-2">2. Stop Load Test</a></h4>
<p>Select the 'Stop' button in the top right hand corner of the Locust UI, after the
desired test duration has elapsed. If the 'Run time' or 'Duration' is set in step 1,
the load test will stop automatically.</p>
<h4 id="3-analyse-results-2"><a class="header" href="#3-analyse-results-2">3. Analyse Results</a></h4>
<p><strong>CPU and Memory Resource Graphs</strong></p>
<ul>
<li>CPU and Memory usage should be less than 90% of the available capacity
<ul>
<li>CPU and Memory Resources can be observed in
<a href="https://console.cloud.google.com/kubernetes/list/overview?cloudshell=false&amp;project=spheric-keel-331521">Google Cloud &gt; Kubernetes Engine &gt; Workloads</a></li>
</ul>
</li>
</ul>
<p><strong>Log Errors or Warnings</strong></p>
<ul>
<li>Locust will emit errors or warnings if high CPU or memory usage occurs during the
execution of a load test. The presence of these logs is a strong indication that the
<code>USERS_PER_WORKER</code> count is too high</li>
</ul>
<h4 id="4-report-results-1"><a class="header" href="#4-report-results-1">4. Report Results</a></h4>
<p>See <a href="#3-analyse-results-1">Distributed GCP Execution (Manual Trigger) - Analyse Results</a></p>
<h4 id="5-update-shape-and-script-values"><a class="header" href="#5-update-shape-and-script-values">5. Update Shape and Script Values</a></h4>
<ul>
<li><code>WORKER_COUNT = MAX_USERS/USERS_PER_WORKER</code>
<ul>
<li>If <code>MAX_USERS</code> is unknown, calibrate to determine <code>WORKER_COUNT</code></li>
</ul>
</li>
<li>Update the <code>USERS_PER_WORKER</code> and <code>WORKER_COUNT</code> values in the following files:
<ul>
<li><code>\tests\load\locustfiles\smoke_load.py</code> or <code>\tests\load\locustfiles\average_load.py</code></li>
<li>\tests\load\setup_k8s.sh</li>
</ul>
</li>
</ul>
<h3 id="clean-up-environment-2"><a class="header" href="#clean-up-environment-2">Clean-up Environment</a></h3>
<p>See <a href="#clean-up-environment">Distributed GCP Execution (Manual Trigger) - Clean-up Environment</a></p>
<h2 id="calibrating-for-worker_count"><a class="header" href="#calibrating-for-worker_count">Calibrating for WORKER_COUNT</a></h2>
<p>This process is used to determine the number of Locust workers required in order to
generate sufficient load for a test given a SHAPE_CLASS.</p>
<h3 id="setup-environment-3"><a class="header" href="#setup-environment-3">Setup Environment</a></h3>
<ul>
<li>See <a href="#setup-environment-1">Distributed GCP Execution (Manual Trigger) - Setup Environment</a></li>
<li>Note that in the <code>setup_k8s.sh</code> the maximum number of nodes is set using the
<code>total-max-nodes</code> google cloud option. It may need to be increased if the number of
workers can't be supported by the cluster.</li>
</ul>
<h3 id="calibrate-1"><a class="header" href="#calibrate-1">Calibrate</a></h3>
<p>Repeat steps 1 to 4, using a process of elimination, such as the bisection method, to
determine the maximum <code>WORKER_COUNT</code>. The tests are considered optimized when they
generate the minimum load required to cause node scaling in the the Merino-py Stage
environment. You can monitor the Merino-py pod counts on <a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a>.</p>
<h4 id="1-update-shape-and-script-values"><a class="header" href="#1-update-shape-and-script-values">1. Update Shape and Script Values</a></h4>
<ul>
<li>Update the <code>WORKER_COUNT</code> values in the following files:
<ul>
<li><code>\tests\load\locustfiles\smoke_load.py</code> or <code>\tests\load\locustfiles\average_load.py</code></li>
<li>\tests\load\setup_k8s.sh</li>
</ul>
</li>
<li>Using Git, commit the changes locally</li>
</ul>
<h4 id="2-start-load-test"><a class="header" href="#2-start-load-test">2. Start Load Test</a></h4>
<ul>
<li>In a browser navigate to <code>http://$EXTERNAL_IP:8089</code>
This url can be generated via command
<pre><code class="language-bash">EXTERNAL_IP=$(kubectl get svc locust-master -o jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;)
echo http://$EXTERNAL_IP:8089
</code></pre>
</li>
<li>Set up the load test parameters:
<ul>
<li>ShapeClass: SHAPE_CLASS</li>
<li>Host: 'https://stagepy.merino.nonprod.cloudops.mozgcp.net'</li>
</ul>
</li>
<li>Select &quot;Start Swarm&quot;</li>
</ul>
<h4 id="3-stop-load-test"><a class="header" href="#3-stop-load-test">3. Stop Load Test</a></h4>
<p>Select the 'Stop' button in the top right hand corner of the Locust UI, after the
desired test duration has elapsed. If the 'Run time', 'Duration' or 'ShapeClass'
are set in step 1, the load test will stop automatically.</p>
<h4 id="4-analyse-results"><a class="header" href="#4-analyse-results">4. Analyse Results</a></h4>
<p><strong>Stage Environment Pod Counts</strong></p>
<ul>
<li>The 'Merino-py Pod Count' should demonstrate scaling during the execution of the load test
<ul>
<li>The pod counts can be observed in <a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/merino-py-application-and-infrastructure?orgId=1&amp;refresh=1m&amp;var-environment=stagepy">Grafana</a></li>
</ul>
</li>
</ul>
<p><strong>CPU and Memory Resources</strong></p>
<ul>
<li>CPU and Memory usage should be less than 90% of the available capacity in the cluster
<ul>
<li>CPU and Memory Resources can be observed in
<a href="https://console.cloud.google.com/kubernetes/list/overview?cloudshell=false&amp;project=spheric-keel-331521">Google Cloud &gt; Kubernetes Engine &gt; Workloads</a></li>
</ul>
</li>
</ul>
<h4 id="5-report-results"><a class="header" href="#5-report-results">5. Report Results</a></h4>
<ul>
<li>See <a href="#4-report-results">Distributed GCP Execution (Manual Trigger) - Report Results</a></li>
</ul>
<h3 id="clean-up-environment-3"><a class="header" href="#clean-up-environment-3">Clean-up Environment</a></h3>
<ul>
<li>See <a href="#clean-up-environment-1">Distributed GCP Execution (Manual Trigger) - Clean-up Environment</a></li>
</ul>
<h2 id="maintenance"><a class="header" href="#maintenance">Maintenance</a></h2>
<p>The load test maintenance schedule cadence is once a quarter and should include
updating the following:</p>
<ol>
<li><a href="https://python-poetry.org/docs/">poetry</a> version and python dependencies
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/pyproject.toml">pyproject.toml</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/poetry.lock">poetry.lock</a></li>
</ul>
</li>
<li><a href="https://docs.docker.com/">Docker</a> artifacts
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/Dockerfile">Dockerfile</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/docker-compose.yml">docker-compose.yml</a></li>
</ul>
</li>
<li>Distributed GCP execution scripts and Kubernetes configurations
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/setup_k8s.sh">setup_k8s.sh</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/kubernetes-config/locust-master-controller.yml">locust-master-controller.yml</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/kubernetes-config/locust-master-service.yml">locust-master-service.yml</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/kubernetes-config/locust-worker-controller.yml">locust-worker-controller.yml</a></li>
</ul>
</li>
<li>Documentation
<ul>
<li><input disabled="" type="checkbox"/>
<a href="./load-tests.html">load test docs</a></li>
</ul>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../testing/integration-tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../operations/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../testing/integration-tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../operations/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
