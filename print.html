<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Merino Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">General Documentation</li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item expanded "><a href="firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="ops.html"><strong aria-hidden="true">3.</strong> Configuring Merino (Operations)</a></li><li class="chapter-item expanded "><a href="data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="dev/index.html"><strong aria-hidden="true">5.</strong> Working on the code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/dependencies.html"><strong aria-hidden="true">5.1.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="dev/logging-and-metrics.html"><strong aria-hidden="true">5.2.</strong> Logging and Metrics</a></li><li class="chapter-item expanded "><a href="dev/middlewares.html"><strong aria-hidden="true">5.3.</strong> Middlewares</a></li><li class="chapter-item expanded "><a href="dev/feature_flags.html"><strong aria-hidden="true">5.4.</strong> Feature Flags</a></li><li class="chapter-item expanded "><a href="dev/testing.html"><strong aria-hidden="true">5.5.</strong> Testing Strategies</a></li><li class="chapter-item expanded "><a href="dev/release-process.html"><strong aria-hidden="true">5.6.</strong> Release Process</a></li><li class="chapter-item expanded "><a href="dev/profiling.html"><strong aria-hidden="true">5.7.</strong> Profiling</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino"><a class="header" href="#merino">Merino</a></h1>
<p>Merino is a service that provides address bar suggestions to Firefox. Some of this content
comes from third party providers. In this case, Merino serves as a privacy preserving
buffer. User input in the address bar is handled by Merino and any clicked impression
will be delegated to a Mozilla-controlled service which will then send an interaction
ping if defined in the request and not to a provider directly. See API documentation
for more details.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<p><a href="./api.html">api.md - API Documentation</a> describes endpoints, query parameters, request and response headers, response objects and details on the suggestion objects.</p>
<p><a href="./firefox.html">firefox.md - Firefox and Merino Environments</a> describes how to enable
Merino in Firefox and lists the endpoints for the service in Production,
State and Dev.</p>
<p><a href="./ops.html">ops.md - Configuring Merino - Operations</a> describes configuration management
of the project, Dynaconf setup, and the configuration of the HTTP server, logging, metrics, Remote Settings, and Sentry.</p>
<p><a href="./data.html">data.md - Data, Metrics, Logging</a> describes all metrics and logs.</p>
<p><a href="./dev/index.html">dev/index.md - Basic Developer Docs</a> describes basics of working on Merino.</p>
<p><a href="./dev/dependencies.html">dev/dependencies.md - Development Dependencies</a> describes the development
dependencies required for Merino.</p>
<p><a href="./dev/logging-and-metrics.html">dev/logging-and-metrics.md - Logging and Metrics</a> describes metrics, logging, and telemetry.</p>
<p><a href="./dev/release-process.html">dev/release-process.md - Release Process</a> describes the release process of Merino in detail.</p>
<p><a href="./dev/testing.html">dev/testing.md - Testing</a> describes unit, integration, contract and load tests for Merino.</p>
<p><a href="./dev/profiling.html">dev/profiling.md - Profiling</a> describes how to profile Merino to address performance issues.</p>
<h2 id="about-the-name"><a class="header" href="#about-the-name">About the Name</a></h2>
<p>This project drives an important part of Firefox's &quot;felt experience&quot;. That is,
the feeling of using Firefox, hopefully in a delightful way. The word &quot;felt&quot; in
this phrase refers to feeling, but it can be punned to refer to the
<a href="https://en.wikipedia.org/wiki/Felt">textile</a>. Felt is often made of wool, and
Merino wool (from Merino sheep) produces exceptionally smooth felt.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-api-documentation"><a class="header" href="#merino-api-documentation">Merino API documentation</a></h1>
<p>This page describes the API endpoints available on Merino.</p>
<h2 id="suggest"><a class="header" href="#suggest">Suggest</a></h2>
<p>Endpoint: <code>/api/v1/suggest</code></p>
<p>Example: <code>/api/v1/suggest?q=nelson%20mand&amp;client_variants=one,two</code></p>
<p>This is the primary endpoint that consumes user input and suggests 
pages the user may want to visit. The expectation is that
this is shown alongside other content the browser suggests 
to the user, such as bookmarks and history.</p>
<p>This endpoint accepts GET requests and takes parameters as query string values
and headers.</p>
<h3 id="query-parameters"><a class="header" href="#query-parameters">Query Parameters</a></h3>
<ul>
<li>
<p><code>q</code> - The query that the user has typed. This is expected to be a partial
input, sent as fast as once per keystroke, though a slower period may be
appropriate for the user agent.</p>
</li>
<li>
<p><code>client_variants</code> - Optional. A comma-separated list of any experiments or
rollouts that are affecting the client's Suggest experience. If Merino
recognizes any of them it will modify its behavior accordingly.</p>
</li>
<li>
<p><code>providers</code> - Optional. A comma-separated list of providers to use for this
request. See the <code>/providers</code> endpoint below for valid options. If provided,
only suggestions from the listed providers will be returned. If not provided,
Merino will use a built-in default set of providers. The default set of
providers can be seen in the <code>/providers</code> endpoint.</p>
</li>
</ul>
<h3 id="headers"><a class="header" href="#headers">Headers</a></h3>
<ul>
<li>
<p><code>Accept-Language</code> - The locale preferences expressed in this header in
accordance with <a href="https://datatracker.ietf.org/doc/html/rfc2616/#section-14.4">RFC 2616 section 14.4</a> will be used to
determine suggestions. Merino maintains a list of supported locales. Merino
will choose the locale from it's list that has the highest <code>q</code> (quality) value
in the user's <code>Accept-Language</code> header. Locales with <code>q=0</code> will not be used.</p>
<p>If no locales match, Merino will not return any suggestions. If the header is
not included or empty, Merino will default to the <code>en-US</code> locale.</p>
<p>If the highest quality, compatible language produces no suggestion results,
Merino will return an empty list instead of attempting to query other
languages.</p>
</li>
<li>
<p><code>User-Agent</code> - A user's device form factor, operating system, and
browser/Firefox version are detected from the <code>User-Agent</code> header included in
the request.</p>
</li>
</ul>
<h3 id="other-derived-inputs"><a class="header" href="#other-derived-inputs">Other derived inputs</a></h3>
<ul>
<li>
<p>Location - The IP address of the user or nearest proxy will be used to
determine location. This location may be as granular as city level, depending
on server configuration.</p>
<p>Users that use VPN services will be identified according to the VPN exit node
they use, allowing them to change Merino's understanding of their location.
VPN exit nodes are often mis-identified in geolocation databases, and may
produce unreliable results.</p>
</li>
</ul>
<h3 id="response"><a class="header" href="#response">Response</a></h3>
<h4 id="response-object"><a class="header" href="#response-object">Response object</a></h4>
<p>The response will be a JSON object containing the following keys:</p>
<ul>
<li><code>client_variants</code> - A list of strings specified from the <code>client_variants</code>
parameter in the request.</li>
<li><code>server_variants</code> - A list of strings indicating the server variants.</li>
<li><code>request_id</code> - A string identifier identifying every API request sent from Firefox.</li>
<li><code>suggestions</code> - A list of suggestion objects described as below.</li>
</ul>
<h4 id="suggestion-object"><a class="header" href="#suggestion-object">Suggestion object</a></h4>
<ul>
<li>
<p><code>block_id</code> - A number that can be used, along with the <code>provider</code> field below,
to uniquely identify this suggestion. Two suggestions with the same <code>provider</code>
and <code>block_id</code> should be treated as the same suggestion, even if other fields,
such as <code>click_url</code> change. Merino will enforce that they are equivalent from
a user's point of view.</p>
</li>
<li>
<p><code>full_keyword</code> - In the case that the query was a partial match to the
suggestion, this is the completed query that would also match this query. For
example, if the user was searching for fruit and typed &quot;appl&quot;, this field
might contain the string &quot;apples&quot;. This is suitable to show as a completion of
the user's input. This field should be treated as plain text.</p>
</li>
<li>
<p><code>title</code> - The full title of the suggestion resulting from the query. Using the
example of apples above, this might be &quot;Types of Apples in the Pacific
Northwest&quot;. This field should be treated as plain text.</p>
</li>
<li>
<p><code>url</code> - The URL of the page that should be navigated to if the user selects
this suggestion. This will be a resource with the title specified in the
<code>title</code> field.</p>
</li>
<li>
<p><code>impression_url</code> - A provider specified telemetry URL that should be notified
if the browser shows this suggestion to the user. This is used along with
<code>click_url</code> to monitor the relevancy of suggestions. For more details see
<a href="api.html#interaction-pings">Interaction Pings</a>, below. This field may be null, in
which case no impression ping is required for this suggestion provider.</p>
</li>
<li>
<p><code>click_url</code> - A provider specified telemetry URL that should be notified if
the user selects this suggestion. This should only be notified as the result
of positive user action, and only if the user has navigated to the page
specified in the <code>url</code> field. For more details see
<a href="api.html#interaction-pings">Interaction Pings</a>, below. This field may be null, in
which case no click ping is required for this suggestion provider.</p>
</li>
<li>
<p><code>provider</code> - A string that identifies the provider of this suggestion, such as
&quot;adM&quot;. In general, this field is not intended to be directly displayed to the user.</p>
</li>
<li>
<p><code>advertiser</code> - The name of the advertiser, such as &quot;Nike&quot;. Note that a <code>provider</code>
could have multiple <code>advertiser</code>s.</p>
</li>
<li>
<p><code>is_sponsored</code> - A boolean indicating if this suggestion is sponsored content.
If this is true, the UI must indicate to the user that the suggestion is
sponsored.</p>
</li>
<li>
<p><code>icon</code> - A URL of an image to display alongside the suggestion. This will be a
small square image, suitable to be included inline with the text, such as a
site's favicon.</p>
</li>
<li>
<p><code>score</code> - A value between 0.0 and 1.0 used to compare suggestions. When
choosing a suggestion to show the user, higher scored suggestions are
preferred.</p>
</li>
</ul>
<h3 id="response-headers"><a class="header" href="#response-headers">Response Headers</a></h3>
<p>Responses will carry standard HTTP caching headers that indicate the validity of
the suggestions. User agents should prefer to provide the user with cached
results as indicated by these headers.</p>
<h3 id="response-status-codes"><a class="header" href="#response-status-codes">Response Status Codes</a></h3>
<ul>
<li>200 OK - Suggestions provided normally.</li>
<li>4xx - Client error. See response for details.</li>
<li>5xx - Internal server error. Try again later.</li>
</ul>
<p><a id="interaction-pings"></a></p>
<h2 id="interaction-pings"><a class="header" href="#interaction-pings">Interaction Pings</a></h2>
<p>When a Firefox user views or selects a suggestion from Merino, Firefox will send
an impression or a click ping to a Mozilla-controlled service indicating this
user interaction. Some suggestion providers may also need that interaction data
for reporting and relevancy optimization. Firefox will not send the pings to
those providers directly, rather, it will delegate those to a Mozilla-controlled
service, by which the interaction pings will be sent to the <code>impression_url</code> or
<code>click_url</code> specified by the providers.</p>
<p>If the URL for an interaction ping is not specified (for example, <code>click_url</code> is
<code>null</code>), then no ping should be sent to the provider for that action. However,
this interaction ping is always sent to the Mozilla-controlled service unless
the user opts out the telemetry collection of Firefox.</p>
<p>The required behavior for interaction pings is TBD.</p>
<h2 id="providers"><a class="header" href="#providers">Providers</a></h2>
<p>Endpoint: <code>/api/v1/providers</code></p>
<p>This endpoint gives a list of available providers, along with their
<em>availability</em>. It accepts GET requests and takes no parameters.</p>
<h3 id="response-1"><a class="header" href="#response-1">Response</a></h3>
<p>The response will be a JSON object containing the key <code>providers</code>, which is a
map where the keys to this map are the IDs of the provider, and the values are
provider metadata object. Each provider metadata object will have the following
format:</p>
<ul>
<li>
<p><code>id</code> - A string that can be used to identify this provider. This ID can be
used for the <code>providers</code> field of the suggest API.</p>
</li>
<li>
<p><code>availability</code> - A string describing how this provider is used in Merino. It
will be one of:</p>
<ul>
<li><code>&quot;enabled_by_default&quot;</code> - This provider will be used for requests that don't
specify providers, and it should be provided to the user as a selection that
can be turned off.</li>
<li><code>&quot;disabled_by_default&quot;</code> - This provider is not used automatically. It should
be provided to the user as a selection that could be turned on.</li>
<li><code>&quot;hidden&quot;</code> - This provider is not used automatically. It should not be
provided to the user as an option to turn on. It may be used for debugging
or other internal uses. */</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-firefox-and-merino-environments"><a class="header" href="#configuring-firefox-and-merino-environments">Configuring Firefox and Merino Environments</a></h1>
<p>Merino has been enabled by default in Firefox. Though, you will need to enable
the data sharing for Firefox Suggest to fully enable the feature. To enable it,
type <code>about:config</code> in the URL bar set the Firefox preference
<code>browser.urlbar.quicksuggest.dataCollection.enabled</code> to <code>true</code>. By default,
Merino will connect to the production environments. This is controlled with the
<code>browser.urlbar.merino.endpointURL</code> preference. See below for other options.</p>
<p>You can also query any of the endpoint URLs below with something like:</p>
<pre><code class="language-sh">curl 'https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest?q=your+query'
</code></pre>
<h2 id="environments"><a class="header" href="#environments">Environments</a></h2>
<h3 id="production"><a class="header" href="#production">Production</a></h3>
<p><em>Endpoint URL</em>: <a href="https://merino.services.mozilla.com/api/v1/suggest">https://merino.services.mozilla.com/api/v1/suggest</a></p>
<p>The primary environment for end users. Firefox is configured to use this by
default.</p>
<h3 id="stage"><a class="header" href="#stage">Stage</a></h3>
<p><em>Endpoint URL</em>: <a href="https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest">https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest</a></p>
<p>This environment is used for manual and load testing of the server. It is not
guaranteed to be stable or available. It is used as a part of the deploy process
to verify new releases before they got to production.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-merino-operations"><a class="header" href="#configuring-merino-operations">Configuring Merino (Operations)</a></h1>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<p>Merino's settings are managed via Dynaconf and can be specified in two ways: by a
TOML file in the <code>merino/configs/</code> directory, or via environment variables. Environment
variables take precedence over the values set in the TOML files. TOML files set with the
same environment name that is currently activated also automatically override defaults.
Any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.
Read below for more specific details.</p>
<h3 id="file-organization"><a class="header" href="#file-organization"><a href="ops.html#file-organization">File organization</a></a></h3>
<p>These are the settings sources, with later sources overriding earlier ones.</p>
<ul>
<li>
<p>A <code>config.py</code> file establishes a Dynaconf instance and environment-specific values
are pulled in from the corresponding TOML files and environment variables. Other
configurations are established by files that are prefixed with <code>config_*.py</code>,
such as <code>config_sentry.py</code> or <code>config_logging.py</code>.</p>
</li>
<li>
<p>Per-environment configuration files are in the <code>configs</code> directory. The environment
is selected using the environment variable <code>MERINO_ENV</code>. The settings for
that environment are then loaded from <code>configs/${env}.toml</code>, if the file/env exists. The
default environment is &quot;development&quot;. A &quot;production&quot; environment is also
provided.</p>
</li>
<li>
<p>Local configuration files are not checked into the repository, but if created should be named
<code>configs/development.local.toml</code>, following the format of <code>&lt;environment&gt;.local.toml</code>.
This file is listed in the <code>.gitignore</code> file and is safe to use for local configuration.
One may add secrets here if desired, though it is advised to exercise great caution.</p>
</li>
</ul>
<h3 id="general"><a class="header" href="#general">General</a></h3>
<ul>
<li>
<p>All environments are prefixed with <code>MERINO_</code>. This is established in the
<code>config.py</code> file by setting the <code>envvar_prefix=&quot;MERINO&quot;</code> for the Dynaconf
instance. The first level following <code>MERINO_</code> is accessed with a single underscore <code>_</code>
and any subsequent levels require two underscores <code>__</code>. For example,
the logging format can be controlled from the environment variable
<code>MERINO_LOGGING__FORMAT</code>.</p>
</li>
<li>
<p>Production environment variables are set by SRE and stored in the
cloudops project in the <code>configmap.yml</code> file. Contact SRE if you require
information or access on this file, or request access to the cloudops infra
repo.</p>
</li>
<li>
<p>You can set these environment variables in your setup by modifying the <code>.toml</code> files.
Conversely, when using <code>make</code>, you can prefix <code>make run</code> with overrides to the
desired environment variables using CLI flags.</p>
<p>Example:
<code>MERINO_ENV=production MERINO_LOGGING__FORMAT=pretty make dev</code></p>
</li>
<li>
<p><code>env</code> (<code>MERINO_ENV</code>) - Only settable from environment variables. Controls
which environment configuration is loaded, as described above.</p>
</li>
<li>
<p><code>debug</code> (<code>MERINO_DEBUG</code>) - Boolean that enables additional features to debug
the application. This should not be set to true in public environments, as it
reveals all configuration, including any configured secrets.</p>
</li>
<li>
<p><code>format</code> (<code>MERINO_LOGGING__FORMAT</code>) - Controls the format of outputted logs in
either <code>pretty</code> or <code>mozlog</code> format. See <a href="../merino/config_logging.py">../config_logging.py</a>.</p>
</li>
</ul>
<h3 id="caveat"><a class="header" href="#caveat">Caveat</a></h3>
<p>Be extra careful whenever you need to reference those deeply nested settings
(e.g. <code>settings.foo.bar.baz</code>) in the hot paths of the code base, such as middlewares
or route handlers. Under the hood, Dynaconf will perform a dictionary lookup
for each level of the configuration hierarchy. While it's harmless to do those
lookups once or twice, it comes a surprisingly high overhead if accessing them
repeatedly in the hot paths. You can cache those settings somewhere to mitigate
this issue.</p>
<h3 id="deployment"><a class="header" href="#deployment">Deployment</a></h3>
<p>This group currently features a single setting:</p>
<ul>
<li><code>deployment.canary</code> (<code>MERINO_DEPLOYMENT__CANARY</code>) - a boolean that represents
whether the pod running this application is deployed as a canary. The value is
added as a constant tag <code>deployment.canary</code> with type <code>int</code> to emitted metrics.
Note that this setting is supposed to be controlled exclusively by deployment
tooling.</li>
</ul>
<h3 id="runtime-configurations"><a class="header" href="#runtime-configurations">Runtime configurations</a></h3>
<ul>
<li><code>runtime.query_timeout_sec</code> (<code>MERINO_RUNTIME__QUERY_TIMEOUT_SEC</code>) - A floating
point (in seconds) indicating the maximum waiting period for queries issued within
the handler of the <code>suggest</code> endpoint. All the unfinished query tasks will be
cancelled once the timeout gets triggered. Note that this timeout can also be
configured by specific providers. The provider timeout takes precedence over this
value.</li>
</ul>
<h3 id="logging"><a class="header" href="#logging">Logging</a></h3>
<p>Settings to control the format and amount of logs generated.</p>
<ul>
<li>
<p><code>logging.format</code> (<code>MERINO_LOGGING__FORMAT</code>) - The format to emit logs in. One of</p>
<ul>
<li><code>pretty</code> (default in development) - Multiple lines per event, human-oriented
formatting and color.</li>
<li><code>mozlog</code> (default in production) - A single line per event, formatted as
JSON in <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a> format.</li>
</ul>
</li>
<li>
<p><code>logging.level</code> (<code>MERINO_LOGGING__LEVEL</code>) - Minimum level of logs that should
be reported. This should be a number of <em>entries</em> separated by commas (for
environment variables) or specified as list (TOML).</p>
<p>Each entry can be one of <code>CRITICAL</code>, <code>ERROR</code>, <code>WARN</code>, <code>INFO</code>,  or <code>DEBUG</code> (in
increasing verbosity).</p>
</li>
</ul>
<h3 id="metrics"><a class="header" href="#metrics">Metrics</a></h3>
<p>Settings for Statsd/Datadog style metrics reporting.</p>
<ul>
<li>
<p><code>metrics.host</code> (<code>MERINO_METRICS__HOST</code>) - The IP or hostname to send metrics
to over UDP. Defaults to localhost.</p>
</li>
<li>
<p><code>metrics.port</code> (<code>MERINO_METRICS__PORT</code>) - The port to send metrics to over
UDP. Defaults to 8092.</p>
</li>
<li>
<p><code>metrics.dev_logger</code> (<code>MERINO_METRICS__DEV_LOGGER</code>) - Whether or not to send
metrics over to the logger. Should only be used for non-production environments.</p>
</li>
</ul>
<h3 id="sentry"><a class="header" href="#sentry">Sentry</a></h3>
<p>Error reporting via Sentry.</p>
<ul>
<li><code>sentry.mode</code> (<code>MERINO_SENTRY__MODE</code>) - The type of Sentry integration to
enable. One of <code>release</code>, <code>debug</code>, or <code>disabled</code>. The <code>debug</code> setting
should only be used for local development.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>release</code>, then the following two settings are
required:</p>
<ul>
<li><code>sentry.dsn</code> (<code>MERINO_SENTRY__DSN</code>) - Configuration to connect to the Sentry project.</li>
<li><code>sentry.env</code> (<code>MERINO_SENTRY__ENV</code>) - The environment to report to Sentry.
Probably &quot;prod&quot;, &quot;stage&quot;, or &quot;dev&quot;.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>disabled</code>, no Sentry integration will be activated.
If it is set to <code>debug</code>, the DSN will be set to a testing value
recommended by Sentry, and extra output will be included in the logs.</p>
<h3 id="remote_settings"><a class="header" href="#remote_settings">Remote_settings</a></h3>
<p>Connection to Remote Settings. This is used by the Remote Settings suggestion
provider below.</p>
<ul>
<li>
<p><code>remote_settings.server</code> (<code>MERINO_REMOTE_SETTINGS__SERVER</code>) - The server to
sync from. Example: <code>https://firefox.settings.services.mozilla.com</code>.</p>
</li>
<li>
<p><code>remote_settings.bucket</code> (<code>MERINO_REMOTE_SETTINGS__BUCKET</code>) -
The bucket to use for Remote Settings providers if not specified in the
provider config. Example: &quot;main&quot;.</p>
</li>
<li>
<p><code>remote_settings.collection</code>
(<code>MERINO_REMOTE_SETTINGS__COLLECTION</code>) - The collection to use for
Remote Settings providers if not specified in the provider config. Example:
&quot;quicksuggest&quot;.</p>
</li>
</ul>
<h3 id="location"><a class="header" href="#location">Location</a></h3>
<p>Configuration for determining the location of users.</p>
<ul>
<li><code>location.maxmind_database</code> (<code>MERINO_LOCATION__MAXMIND_DATABASE</code>) - Path to a
MaxMind GeoIP database file.</li>
</ul>
<h3 id="provider-configuration"><a class="header" href="#provider-configuration">Provider Configuration</a></h3>
<p>The configuration for suggestion providers.</p>
<h4 id="adm-provider"><a class="header" href="#adm-provider">Adm Provider</a></h4>
<p>These are production providers that generate suggestions.</p>
<ul>
<li>Remote Settings - Provides suggestions from a RS collection, such as the
suggestions provided by adM. See also the top level configuration for Remote
Settings above.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__ADM__ENABLED_BY_DEFAULT</code>) - Whether
or not this provider is enabled by default.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__ADM__backend</code>) - The backend of the provider.
Either <code>remote-settings</code> or <code>test</code>.</li>
<li><code>resync_interval_sec</code> (<code>MERINO_PROVIDERS__ADM__RESYNC_INTERVAL_SEC</code>) - The time
between re-syncs of Remote Settings data, in seconds. Defaults to 3 hours.</li>
<li><code>cron_interval_sec</code>
(<code>MERINO_PROVIDERS__ADM__CRON_INTERVAL_SEC</code>) - The interval of the Remote
Settings cron job (in seconds). Following tasks are done in this cron job:
<ul>
<li>Resync with Remote Settings if needed. The resync interval is configured
separately by the provider. Note that this interval should be set smaller
than <code>resync_interval_sec</code> of the Remote Settings leaf provider.</li>
<li>Retry if the regular resync fails.</li>
</ul>
</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__ADM__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
<li><code>score_wikipedia</code> (<code>MERINO_PROVIDERS__ADM__SCORE_WIKIPEDIA</code>) - The ranking score
of Wikipedia suggestions for this provider as a floating point number.
Defaults to 0.2.</li>
</ul>
</li>
</ul>
<h4 id="accuweather-provider"><a class="header" href="#accuweather-provider">Accuweather Provider</a></h4>
<ul>
<li>Accuweather - Providers weather suggestions &amp; forecasts from Accuweather.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__ENABLED_BY_DEFAULT</code>) - Whether
or not this provider is enabled by default.</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
<li><code>query_timeout_sec</code> (<code>MERINO_PROVIDERS_ACCUWEATHER__QUERY_TIMEOUT_SEC</code>) - A floating
point (in seconds) indicating the maximum waiting period when Merino queries Accuweather
for weather forecasts. This will override the default query timeout
<code>merino.runtime.query_timeout_sec</code> for this provider.</li>
<li><code>api_key</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__API_KEY</code>) - The API key to Accuweather's API
endpoint. In production, this should be set via environment variable as a secret.</li>
<li><code>url_base</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_BASE</code>) - The base URL of Accuweather's
API endpoint.</li>
<li><code>url_param_api_key</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_PARAM_API_KEY</code>) - The parameter
of the API key for Accuweather's API endpoint.</li>
<li><code>url_current_conditions_path</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_CURRENT_CONDITIONS_PATH</code>) -
The URL path for current conditions.</li>
<li><code>url_forecasts_path</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_FORECASTS_PATH</code>) - The URL path
for forecasts.</li>
<li><code>url_postalcodes_path</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_POSTALCODES_PATH</code>) - The URL path
for postal codes.</li>
<li><code>url_postalcodes_param_query</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__URL_POSTALCODES_PARAM_QUERY</code>) -
The query parameter for postal codes.</li>
</ul>
</li>
</ul>
<h4 id="wiki-fruit-provider"><a class="header" href="#wiki-fruit-provider">Wiki Fruit Provider</a></h4>
<ul>
<li>Wiki Fruit - Provides suggestions from a test provider. Should not be used
in production.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__WIKI_FRUIT__ENABLED_BY_DEFAULT</code>) - Whether
or not this provider is enabled by default.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collection"><a class="header" href="#data-collection">Data collection</a></h1>
<p>This page should list all metrics and logs that Merino is expected to emit in
production, including what should be done about them, if anything.</p>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>This list does not include any <code>DEBUG</code> level events, since those are not logged
by default in production. The level and type of the log is listed.</p>
<p>Any log containing sensitive data must include a boolean field <code>sensitive</code>
that is set to <code>true</code> to exempt it from flowing to the generally accessible
log inspection interfaces.</p>
<h3 id="merino-apis"><a class="header" href="#merino-apis">Merino APIs</a></h3>
<ul>
<li>
<p><code>INFO web.suggest.request</code> - A suggestion request is being processed. This
event will include fields for all relevant details of the request. <strong>Fields:</strong></p>
<ul>
<li><code>sensitive</code> - Always set to true to ensure proper routing.</li>
<li><code>query</code> - If query logging is enabled, the text the user typed. Otherwise an
empty string.</li>
<li><code>country</code> - The country the request came from.</li>
<li><code>region</code> - The first country subdivision the request came from.</li>
<li><code>city</code> - The city the request came from.</li>
<li><code>dma</code> - A US-only location description that is larger than city and smaller
than states, but does not align to political borders.</li>
<li><code>agent</code> - The original user agent.</li>
<li><code>os_family</code> - Parsed from the user agent. One of &quot;windows&quot;, &quot;macos&quot;,
&quot;linux&quot;, &quot;ios&quot;, &quot;android&quot;, &quot;chrome os&quot;, &quot;blackberry&quot;, or &quot;other&quot;.</li>
<li><code>form_factor</code> - Parsed from the user agent. One of &quot;desktop&quot;, &quot;phone&quot;,
&quot;tablet&quot;, or &quot;other&quot;</li>
<li><code>browser</code> - The browser and possibly version detected. Either &quot;Firefox(XX)&quot;
where XX is the version, or &quot;Other&quot;.</li>
<li><code>rid</code> - The request ID.</li>
<li>WIP <code>accepts_english</code> - True if the user's Accept-Language header includes an
English locale, false otherwise.</li>
<li><code>requested_providers</code> - A comma separated list of providers requested via
the query string, or an empty string if none were requested (in which case
the default values would be used).</li>
<li><code>client_variants</code> - Any client variants sent to Merino in the query string.</li>
<li><code>session_id</code> - A UUID generated by the client for each search session.</li>
<li><code>sequence_no</code> -  A client-side event counter (0-based) that records the query
sequence within each search session.</li>
</ul>
</li>
<li>
<p><code>INFO request.summary</code> - The application request summary that follows the <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a>
convention. This log is recorded for all incoming HTTP requests except for the
suggest API endpoint.</p>
</li>
</ul>
<ul>
<li><code>ERROR dockerflow.error_endpoint</code> - The <code>__error__</code> endpoint of the server was
called. This is used to test our error reporting system. It is not a cause for
concern, unless we receive a large amount of these records, in which case some
outside service is likely malicious or misconfigured.</li>
</ul>
<h3 id="merino-middleware-logs"><a class="header" href="#merino-middleware-logs">Merino Middleware Logs</a></h3>
<h4 id="geolocation"><a class="header" href="#geolocation">Geolocation</a></h4>
<ul>
<li><code>WARNING merino.middleware.geolocation</code> - There was an error with a geolocation lookup.</li>
</ul>
<h3 id="merino-cron-tasks"><a class="header" href="#merino-cron-tasks">Merino Cron Tasks</a></h3>
<ul>
<li><code>WARNING merino.cron</code> - There was an error while executing a cron task.</li>
</ul>
<h3 id="merino-feature-flags"><a class="header" href="#merino-feature-flags">Merino Feature Flags</a></h3>
<ul>
<li><code>ERROR merino.featureflags</code> - There was an error while attempting to assign a
feature flag for a suggest API request.</li>
</ul>
<h2 id="metrics-1"><a class="header" href="#metrics-1">Metrics</a></h2>
<blockquote>
<p>A note on timers: Statsd timers are measured in milliseconds, and are reported
as integers (at least in Cadence). Milliseconds are often not precise enough
for the tasks we want to measure in Merino. Instead, we use generic histograms
to record microsecond times. Metrics recorded in this way should have <code>-us</code>
appended to their name, to mark the units used (since we shouldn't put the
proper unit μs in metric names).</p>
</blockquote>
<ul>
<li>
<p><code>merino.providers.initialize</code> - A timer to measure the overall initialization
duration (in ms) for <em>all</em> providers.</p>
</li>
<li>
<p><code>merino.providers.initialize.&lt;provider&gt;</code> - A timer to measure the initialization
duration (in ms) for the given <code>&lt;provider&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.providers.initialize.adm</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.status_codes.&lt;status_code&gt;</code> - A counter to measure
the status codes of an HTTP method for the <code>&lt;url_path&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.status_codes.200</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.timing</code> - A timer to measure the duration (in ms)
of an HTTP method for a URL path.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.timing</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query</code> - A timer to measure the query duration (in ms) of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.adm.query</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query.timeout</code> - A counter to measure the query timeouts of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.wikipedia.query.timeout</code></p>
</li>
<li>
<p><code>merino.suggestions-per.request</code> - A histogram metric to get the distribution of
suggestions per request.</p>
</li>
<li>
<p><code>merino.suggestions-per.provider.&lt;provider_module&gt;</code> - A histogram metric to get the distribution of
suggestions returned per provider (per request).</p>
<p><strong>Example</strong>:
<code>merino.suggestions-per.provider.wikipedia</code></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation-for-working-on-merino"><a class="header" href="#developer-documentation-for-working-on-merino">Developer documentation for working on Merino</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">tl;dr</a></h2>
<p>Here are some useful commands when working on Merino.</p>
<h3 id="run-the-main-app"><a class="header" href="#run-the-main-app">Run the main app</a></h3>
<p>This project uses <a href="https://python-poetry.org/">Poetry</a> for dependency management.
See <a href="dev/./dependencies.html">dependencies</a> for how to install Poetry on your machine.</p>
<p>Install all the dependencies:</p>
<pre><code>$ poetry install
</code></pre>
<p>Run Merino:</p>
<pre><code>$ poetry run uvicorn merino.main:app --reload

# Or you can use a shortcut
$ make run
</code></pre>
<h3 id="general-commands"><a class="header" href="#general-commands">General commands</a></h3>
<pre><code class="language-shell"># List all available make commands with descriptions
$ make help

# Just like `poetry install`
$ make install

# Run all linting checks
$ make lint

# Run all formatters
$ make format

# Run merino-py with the auto code reloading
$ make dev

# Run merino-py without the auto code reloading
$ make run

# Run unit and integration tests and evaluate combined coverage
$ make test

# Evaluate combined unit and integration test coverage
$ make test-coverage-check

# Run unit tests
$ make unit-tests

# List fixtures in use per unit test
$ make unit-test-fixtures

# Run integration tests
$ make integration-tests

# List fixtures in use per integration test
$ make integration-test-fixtures

# Run contract tests
$ make contract-tests

# Run contract tests cleanup
$ make contract-tests-clean

# Generate documents
$ make doc

# Preview the generated documents
$ make doc-preview

# Profile Merino with Scalene
$ make profile
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>You can generate documentation, both code level and book level, for Merino and
all related crates by running <code>./dev/make-all-docs.sh</code>. You'll need <a href="https://rust-lang.github.io/mdBook/">mdBook</a>,
which you can get with <code>cargo install mdbook</code>.</p>
<h2 id="local-configuration"><a class="header" href="#local-configuration">Local configuration</a></h2>
<p>The default configuration of Merino is <code>development</code>, which has human-oriented
pretty-print logging and debugging enabled. For settings that you wish to change in the
development configuration, you have two options, listed below.</p>
<blockquote>
<p>For full details, make sure to check out the documentation for
<a href="dev/../ops.html">Merino's setting system (ops.md)</a>.</p>
</blockquote>
<h3 id="update-the-defaults"><a class="header" href="#update-the-defaults">Update the defaults</a></h3>
<p>Dynaconf is used for all configuration management in Merino, where
values are specified in the <code>merino/configs/</code> directory in <code>.toml</code> files. Environment variables
are set for each environment as well and can be set when using the cli to launch the
Merino service.
Environment variables take precedence over the values set in the <code>.toml</code> files, so
any environment variable set will automatically override defaults. By the same token,
any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.</p>
<p>If the change you want to make makes the system better for most development
tasks, consider adding it to <code>merino/configs/development.toml</code>, so that other developers
can take advantage of it. If you do so, you likely want to add validation to those settings
which needs to be added in <code>merino/config.py</code>, where the Dynaconf instance exists along
with its validators. For examples of the various config settings, look at <code>configs/default.toml</code>
and <code>merino/config.py</code> to see an example of the structure.</p>
<p>It is not advisable to put secrets in <code>configs/secrets.toml</code>.</p>
<h3 id="create-a-local-override"><a class="header" href="#create-a-local-override">Create a local override</a></h3>
<p>Dynaconf will use the specified values and environment variables in the
<code>merino/configs/default.toml</code> file. You can change the environment you
want to use as mentioned above, but for local changes to adapt to your
machine or tastes, you can put the configuration in <code>merino/configs/development.local.toml</code>.
This file doesn't exist by default, so you will have to create it.
Then simply copy from the other config files and make the adjustments
that you require. These files should however not be checked into source
control and are configured to be ignored, so long as they follow the <code>*.local.toml</code>
format. Please follow this convention and take extra care to not check them in
and only use them locally.</p>
<p>See the <a href="https://www.dynaconf.com/">Dynaconf Documentation</a> for more details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-dependencies"><a class="header" href="#development-dependencies">Development Dependencies</a></h1>
<p>This project uses <a href="https://python-poetry.org/">Poetry</a> for dependency management. While you can use the
vanilla virtualenv to set up the dev environment, we highly recommend to check
out <a href="https://github.com/pyenv/pyenv">pyenv</a> and <a href="https://github.com/pyenv/pyenv-virtualenv">pyenv-virtualenv</a>, as they work nicely with Poetry.
Follow the instructions to install <a href="https://github.com/pyenv/pyenv#installation">pyenv</a>, <a href="https://github.com/pyenv/pyenv-virtualenv#installation">pyenv-virtualenv</a>, and
<a href="https://python-poetry.org/docs/#installation">poetry</a>.</p>
<p>Feel free to browse the <a href="dev//pyproject.toml">pyproject.toml</a> file for a listing of dependencies
and their versions.</p>
<p>Once Poetry is installed, install all the dependencies:</p>
<pre><code>$ poetry install
</code></pre>
<p>Add packages to project via poetry</p>
<pre><code>$ poetry add &lt;package_name&gt;
</code></pre>
<p>After that you should be to run Merino as follows:</p>
<pre><code>$ poetry run uvicorn merino.main:app --reload

# Or you can fire up a poetry shell to make it shorter
$ poetry shell
$ uvicorn merino.main:app --reload
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-and-metrics"><a class="header" href="#logging-and-metrics">Logging and Metrics</a></h1>
<p>To get data out of Merino and into observable systems, we use <em>metrics</em> and
<em>logging</em>. Each has a unique use case. Note that in general, because of the scale
we work at, adding a metric or log event in production is not free, and if we
are careless can end up costing quite a bit. Record what is needed, but don't go
over board.</p>
<p>All data collection that happens in production (logging at INFO, WARN, or ERROR
levels; and metrics) should be documented in <a href="dev/../data.html"><code>docs/data.md</code></a>.</p>
<h2 id="logging-1"><a class="header" href="#logging-1">Logging</a></h2>
<p>Merino uses <a href="https://firefox-source-docs.mozilla.org/mozbase/mozlog.html">MozLog</a> for structured logging. Logs can be recorded through the
standard Python <code>logging</code> module. Merino can output logs in various formats,
including a JSON format (MozLog) for production. A pretty, human readable format
is also provided for development and other use cases.</p>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>MozLog requires that all messages have a <code>type</code> value. By convention, we use
the name of the Python module, where the log record get issued, to populate this
field. For example:</p>
<pre><code class="language-py">import logging

logger = logging.getLogger(__name__)

# The `type` field of the log record will be the same as `__name__`.
logger.info(&quot;A new log message&quot;, data=extra_fields)
</code></pre>
<p>In general, the log <em>message</em> (&quot;An empty MultiProvider was created&quot;) and the log
<em>type</em> should both tell the reader what has happened. The difference is that the
message is for humans and the type is for machines.</p>
<h3 id="levels"><a class="header" href="#levels">Levels</a></h3>
<p>Tracing provides five log levels that should be familiar. This is what we mean
by them in Merino:</p>
<ul>
<li>
<p><code>CRITICAL</code> - There was a serious error indicating that the program itself may
be unable to continue running.</p>
</li>
<li>
<p><code>ERROR</code> - There was a problem, and the task was not completable. This usually
results in a 500 being sent to the user. All error logs encountered in
production are reported to Sentry and should be considered a bug. If it isn't
a bug, it shouldn't be logged as an error.</p>
</li>
<li>
<p><code>WARNING</code> - There was a problem, but the task was able to recover. This
doesn't usually affect what the user sees. Warnings are suitable for
unexpected but &quot;in-spec&quot; issues, like a sync job not returning an empty set or
using a deprecated function. These are not reported to Sentry.</p>
</li>
<li>
<p><code>INFO</code> - This is the default level of the production service. Use for logging
that something happened that isn't a problem and we care about in production.
This is the level that Merino uses for it's one-per-request logs and sync
status messages. Be careful adding new per-request logs at this level, as they
can be expensive.</p>
</li>
<li>
<p><code>DEBUG</code> - This is the default level for developers running code locally. Use
this to give insight into how the system is working, but keep in mind that
this will be on by default, so don't be too noisy. Generally this should
summarize what's happening, but not give the small details like a log line for
every iteration of a loop. Since this is off in production, there are no cost
concerns.</p>
</li>
</ul>
<h2 id="metrics-2"><a class="header" href="#metrics-2">Metrics</a></h2>
<p>Merino metrics are reported as <a href="https://www.datadoghq.com/blog/statsd/.">Statsd</a> metrics.</p>
<p>Unlike logging, the primary way that metrics reporting can cost a lot is in
<em>cardinality</em>. The number of metric IDs we have and the combination of tag
values that we supply. Often the number of individual events doesn't matter as
much, since multiple events are aggregated together.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="middlwares"><a class="header" href="#middlwares">Middlwares</a></h1>
<p>Merino leverages middleware for various functionalities such as logging, metrics,
parsing for geolocation &amp; user agent, feature flags etc. Middleware is defined
in the <code>merino/middleware</code> directory.</p>
<h2 id="caveat-1"><a class="header" href="#caveat-1">Caveat</a></h2>
<p>We currently don't implement middleware using the middleware facilities provided
by FastAPI/Starlette as they've shown significant performance overhead, preventing
Merino from achieving the SLOs required by Firefox Suggest.</p>
<p>Before those performance issues get resolved in the upstream, we will be implementing
middleware for Merino through the <a href="https://asgi.readthedocs.io/en/latest/specs/www.html">ASGI protocol</a>. You can also reference this
<a href="https://florimond.dev/en/posts/2019/08/introduction-to-asgi-async-python-web/">tutorial</a> to learn more about ASGI. See Starlette's <a href="https://www.starlette.io/middleware/">middleware</a> document
for more details about how to write pure ASGI middlewares. Specifically, we can reuse
Starlette's data structures (<code>Request</code>, <code>Headers</code>, <code>QueryParams</code> etc.) to facilitate
the implementation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="feature-flags"><a class="header" href="#feature-flags">Feature Flags</a></h1>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>Do you plan to release code behind a feature flag? Great! 😃</p>
<p>Your feature flag needs to be defined first. If it's already defined, go ahead.
Otherwise check the configuration section <a href="dev/feature_flags.html#configuration">below</a> before you
continue.</p>
<p>Use the following line in API endpoint code to gain access to the feature flags
object:</p>
<pre><code class="language-python">feature_flags: FeatureFlags = request.scope[ScopeKey.FEATURE_FLAGS]
</code></pre>
<p>Then check whether a certain feature flag, such as <code>example</code>, is enabled by calling:</p>
<pre><code class="language-python">if feature_flags.is_enabled(&quot;example&quot;):
    print(&quot;feature flag 'example' is enabled! 🚀&quot;)
</code></pre>
<p>When you do that, the decision (whether the feature flag is enabled or not) is
recorded and stored in a <code>dict</code> on the <code>decisions</code> attribute of the feature
flags object.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>The feature flags system in Merino consists of three components:</p>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Location</th></tr></thead><tbody>
<tr><td>A FastAPI middleware that reads the query parameter <code>sid</code> sent by the client application and sets a session ID for the current request based on that.</td><td><code>merino/middleware/featureflags.py</code></td></tr>
<tr><td>A <code>FeatureFlags</code> class which you can use to check if a certain feature flag is enabled.</td><td><code>merino/featureflags.py</code></td></tr>
<tr><td>A local directory containing static files that define and configure feature flags for Merino.</td><td><code>merino/configs/flags/</code></td></tr>
</tbody></table>
</div>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Currently two bucketing schemes are supported: <code>random</code> and <code>session</code>.</p>
<h3 id="random"><a class="header" href="#random">Random</a></h3>
<p>Random does what it says on the tin. It generates a random bucketing ID for
every flag check.</p>
<h3 id="session"><a class="header" href="#session">Session</a></h3>
<p>Session bucketing uses the session ID of the request as the bucketing key so
that feature checks within a given search session would be consistent.</p>
<h3 id="fields"><a class="header" href="#fields">Fields</a></h3>
<p>Each flag defines the following fields:</p>
<pre><code class="language-toml">[default.flags.&lt;flag_name&gt;]
scheme = 'session'
enabled = 0.5
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>scheme</code></td><td>This is the bucketing scheme for the flag. Allowed values are <code>'random'</code> and <code>'session'</code></td></tr>
<tr><td><code>enabled</code></td><td>This represents the % enabled for the flag and must be a float between <code>0</code> and <code>1</code></td></tr>
</tbody></table>
</div>
<h2 id="metrics-3"><a class="header" href="#metrics-3">Metrics</a></h2>
<p>When submitting application metrics, feature flag decisions that were made while
processing the current request up to this point are <strong>automatically</strong> added as
tags to the emitted metrics.</p>
<p>The format of these tags is:</p>
<pre><code>feature_flag.&lt;feature_flag_name&gt;
</code></pre>
<p>For more information about this see the <code>ClientMeta</code> meta class and the
<code>add_feature_flags</code> decorator in <code>merino/metrics.py</code>.</p>
<h2 id="monitoring-in-grafana"><a class="header" href="#monitoring-in-grafana">Monitoring in Grafana</a></h2>
<p>Because feature flag decisions are automatically added as tags to emitted
metrics, you can use them in your queries in Grafana. 📈</p>
<p>For example, if you want to group by decisions for a feature flag with name
<code>hello_world</code>, you can use <code>tag(feature_flag.hello_world)</code> in <code>GROUP BY</code> in
Grafana. You can also use <code>[[tag_feature_flag.hello_world]]</code> in the <code>ALIAS</code> for
panel legends.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-strategies"><a class="header" href="#testing-strategies">Testing strategies</a></h1>
<p>Merino is tested using a four tier strategy composed of unit, integration, contract
and load testing.</p>
<p>Test code resides in the <code>tests</code> directory.</p>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h2>
<p>The unit layer is suitable for testing complex behavior at a small scale, with
fine-grained control over the inputs. Due to their narrow scope, unit tests are
fundamental to thorough test coverage.</p>
<p>To execute unit tests, use: <code>make unit-tests</code></p>
<p>Unit tests are written and executed with pytest and are located in the <code>tests/unit</code>
directory, using the same organizational structure as the source code of the merino
service. Type aliases dedicated for test should be stored in the <code>types.py</code> module.
The <code>conftest.py</code> modules contain common utilities in fixtures.</p>
<p>For a breakdown of fixtures in use per test, use: <code>make unit-test-fixtures</code></p>
<p>Available fixtures include:</p>
<h4 id="filtercaplogfixture"><a class="header" href="#filtercaplogfixture">FilterCaplogFixture</a></h4>
<p>Useful when verifying log messages, this fixture filters log records captured with
pytest's caplog by a given <code>logger_name</code>.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_filter_caplog(
    caplog: LogCaptureFixture, filter_caplog: FilterCaplogFixture
) -&gt; None:
    records: list[LogRecord] = filter_caplog(caplog.records, &quot;merino.providers.adm&quot;)
</code></pre>
<p>Note: This fixture is shared with integration tests.</p>
<h4 id="suggestionrequestfixture"><a class="header" href="#suggestionrequestfixture">SuggestionRequestFixture</a></h4>
<p>For use when querying providers, this fixture creates a SuggestionRequest object with
a given <code>query</code></p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_suggestion_request(srequest: SuggestionRequestFixture) -&gt; None:
    request: SuggestionRequest = srequest(&quot;example&quot;)
    result: list[BaseSuggestion] = await provider.query(request)
</code></pre>
<h4 id="scopefixture-receivemockfixture--sendmockfixture"><a class="header" href="#scopefixture-receivemockfixture--sendmockfixture">ScopeFixture, ReceiveMockFixture &amp; SendMockFixture</a></h4>
<p>For use when testing middleware, these fixtures initialize or mock the common Scope,
Receive and Send object dependencies.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_middleware(scope: Scope, receive_mock: Receive, send_mock: Send) -&gt; None:
    pass
</code></pre>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h2>
<p>The integration layer of testing allows for verification of interactions between
service components, with lower development, maintenance and execution costs compared
with higher level tests, such as contract tests.</p>
<p>To execute integration tests, use: <code>make integration-tests</code></p>
<p>Integration tests are located in the <code>tests/integration</code> directory. They use pytest and
the FastAPI <code>TestClient</code> to send requests to specific merino endpoints and verify
responses as well as other outputs, such as logs. Tests are organized according to the
API path under test. Type aliases dedicated for test should be stored in the <code>types.py</code>
module. Fake providers created for test should be stored in the <code>fake_providers.py</code>
module. The <code>conftest.py</code> modules contain common utilities in fixtures.</p>
<p>For a breakdown of fixtures in use per test, use: <code>make integration-test-fixtures</code></p>
<p>Available fixtures include:</p>
<h4 id="filtercaplogfixture-1"><a class="header" href="#filtercaplogfixture-1">FilterCaplogFixture</a></h4>
<p><a href="dev/testing.html#FilterCaplogFixture">Details</a> available in Unit Tests section</p>
<h4 id="testclientfixture"><a class="header" href="#testclientfixture">TestClientFixture</a></h4>
<p>This fixture creates an instance of the TestClient to be used in testing API calls.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_test_client(client: TestClient):
    response: Response = client.get(&quot;/api/v1/endpoint&quot;)
</code></pre>
<h4 id="testclientwitheventsfixture"><a class="header" href="#testclientwitheventsfixture">TestClientWithEventsFixture</a></h4>
<p>This fixture creates an instance of the TestClient, that will trigger event handlers
(i.e. <code>startup</code> and <code>shutdown</code>) to be used in testing API calls.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_test_client_with_event(client_with_events: TestClient):
    response: Response = client_with_events.get(&quot;/api/v1/endpoint&quot;)
</code></pre>
<h4 id="requestsummarylogdatafixture"><a class="header" href="#requestsummarylogdatafixture">RequestSummaryLogDataFixture</a></h4>
<p>This fixture will extract the extra log data from a captured 'request.summary'
LogRecord for verification</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_log_data(
    caplog: LogCaptureFixture,
    filter_caplog: FilterCaplogFixture,
    extract_request_summary_log_data: LogDataFixture
):
    records: list[LogRecord] = filter_caplog(caplog.records, &quot;request.summary&quot;)
    assert len(records) == 1

    record: LogRecord = records[0]
    log_data: dict[str, Any] = extract_request_summary_log_data(record)
    assert log_data == expected_log_data
</code></pre>
<h4 id="injectprovidersfixture--providersfixture"><a class="header" href="#injectprovidersfixture--providersfixture">InjectProvidersFixture &amp; ProvidersFixture</a></h4>
<p>These fixture will setup and teardown given providers.</p>
<p><em><strong>Usage:</strong></em></p>
<p>If specifying providers for a module:</p>
<pre><code class="language-python">@pytest.fixture(name=&quot;providers&quot;)
def fixture_providers() -&gt; Providers:
    return {&quot;test-provider&quot;: TestProvider()}
</code></pre>
<p>If specifying providers for a test:</p>
<pre><code class="language-python">@pytest.mark.parametrize(&quot;providers&quot;, [{&quot;test-provider&quot;: TestProvider()}])
def test_with_provider() -&gt; None:
    pass
</code></pre>
<h4 id="setupprovidersfixture"><a class="header" href="#setupprovidersfixture">SetupProvidersFixture</a></h4>
<p>This fixture sets application provider dependency overrides.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_setup_providers(setup_providers: SetupProvidersFixture):
    providers: dict[str, BaseProvider] = {&quot;test-provider&quot;: TestProvider()}
    setup_providers(providers)
</code></pre>
<h4 id="teardownprovidersfixture"><a class="header" href="#teardownprovidersfixture">TeardownProvidersFixture</a></h4>
<p>This fixture resets application provider dependency overrides and is often used in
teardown fixtures.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">@pytest.fixture(autouse=True)
def teardown(teardown_providers: TeardownProvidersFixture):
    yield
    teardown_providers()
</code></pre>
<h2 id="contract-tests"><a class="header" href="#contract-tests">Contract tests</a></h2>
<p>The tests in the <code>tests/contract</code> directory are contract tests
that consume Merino's APIs using more opaque techniques. These tests run against
a Docker container of the service, specify settings via environment variables,
and operate on the HTTP API layer only and as such are more concerned with
external contracts and behavior. The contract tests cannot configure the server
per test.</p>
<p>For more details see the README.md file in the <code>test/contract</code>
directory.</p>
<h2 id="load-tests"><a class="header" href="#load-tests">Load tests</a></h2>
<p>The tests in the <code>tests/load</code> directory are load tests that
spawn multiple HTTP clients that consume Merino's API. These tests do not run on
CI. We run them manually to simulate real-world load on the Merino infrastructure.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-release-process"><a class="header" href="#the-release-process">The Release Process</a></h1>
<p>This project currently follows a <a href="https://en.wikipedia.org/wiki/Continuous_delivery">Continuous Delivery</a> process, but it's gradually moving toward <a href="https://en.wikipedia.org/wiki/Continuous_deployment">Continuous Deployment</a>.</p>
<p>Whenever a commit is pushed to this repository's <code>main</code> branch, the deployment pipeline kicks in, deploying the changeset to the <a href="dev/../firefox.html#stage"><code>stage</code> environment</a>.
After the deployment is complete, accessing the <a href="https://stage.merino.nonprod.cloudops.mozgcp.net/__version__"><code>__version__</code> endpoint</a> will show the commit hash of the deployed version, which will eventually match to the one of the latest commit on the <code>main</code> branch (a node with an older version might still serve the request before it is shut down).</p>
<h2 id="development-guidelines"><a class="header" href="#development-guidelines">Development Guidelines</a></h2>
<p>Please see the <a href="dev/../../CONTRIBUTING.html">CONTRIBUTING.md</a> docs on commit guidelines and pull request best practices.</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>The commit hash of the deployed code is considered its version identifier. The commit hash can be retrieved locally via <code>git rev-parse HEAD</code>.</p>
<h2 id="preventing-deployment-via-do-not-deploy"><a class="header" href="#preventing-deployment-via-do-not-deploy">Preventing deployment via [do not deploy]</a></h2>
<p>Occasionally developers might want to prevent a commit from triggering the deployment pipeline. While this should be discouraged, there are some legitimate cases for doing so (e.g. docs only changes).
In order to prevent the deployment of the code from a PR when merging to <code>main</code>, the <strong>title of that PR</strong> must contain the <code>[do not deploy]</code> text. When generating the merge commit for a branch within the GitHub UI, ensure that <code>[do not deploy]</code> is still present in the description, especially if you change or rename the PR later on.</p>
<p>For example:</p>
<pre><code># PR title (NOT the commit message)
doc: Add documentation for the release process [do not deploy]
</code></pre>
<p>While the <code>[do not deploy]</code> can be anywhere in the title, it is recommended to place it at its end in order to better integrate with the current PR title practices and improve readability.</p>
<p>The deployment pipeline will analyze the message of the merge commit (which will contain the PR title) and make a decision based on it.</p>
<h2 id="releasing-to-production"><a class="header" href="#releasing-to-production">Releasing to production</a></h2>
<p>Developers with write access to the Merino repository can initiate a deployment to production after a Pull-Request on the Merino GitHub repository is merged to the <code>main</code> branch.
While any developer with write access can trigger the deployment to production, the <em>expectation</em> is that individual(s) who authored and merged the Pull-Request should do so, as they are the ones most familiar with their changes and who can tell, by looking at the data, if anything looks anomalous.
In general authors should feel <em>responsible</em> for the changes they make and shepherd these changes through to deployment.</p>
<p>Releasing to production can be done by:</p>
<ol>
<li>opening the <a href="https://app.circleci.com/pipelines/github/mozilla-services/merino-py?branch=main&amp;filter=all">CircleCI dashboard</a>;</li>
<li>looking up the pipeline named <code>merino &lt;PR NUMBER&gt;</code> running in the <code>main-workflow</code>; this pipeline should either be in a running status (if the required test jobs are still running) or in the &quot;on hold&quot; status, with the <code>unhold-to-deploy-to-prod</code> being held;</li>
<li>once in the &quot;on hold&quot; status, with all the other jobs successfully completed, clicking on the &quot;thumbs up&quot; action on the <code>unhold-to-deploy-to-prod</code> job row will approve it and trigger the deployment, unblocking the <code>deploy-to-prod</code> job;</li>
<li>developers <strong>must</strong> monitor the <a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/wip-merino-py-application-and-infrastructure?orgId=1&amp;from=now-24h&amp;to=now&amp;var-environment=prodpy&amp;refresh=1m">Merino Application &amp; Infrastructure</a> dashboard for any anomaly, for example significant changes in HTTP response codes, increase in latency, cpu/memory usage (most things under the infrastructure heading).</li>
</ol>
<h2 id="what-to-do-if-production-breaks"><a class="header" href="#what-to-do-if-production-breaks">What to do if production breaks?</a></h2>
<p>If your latest release causes problems and needs to be rolled back:
don't panic and follow the instructions below:</p>
<ol>
<li>Depending on the severity of the problem, decide if this warrants <a href="https://mozilla-hub.atlassian.net/wiki/spaces/MIR/overview">kicking off an incident</a>;</li>
<li>Identify the problematic commit, as it may not necessarily be the latest one!</li>
<li>Revert the problematic commit, merge that into GitHub,
then <a href="dev/release-process.html#releasing-to-production">deploy the revert commit to production</a>.
<ul>
<li>If a fix can be identified in a relatively short time,
then you may submit a fix, rather than reverting the problematic commit.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="profiling"><a class="header" href="#profiling">Profiling</a></h1>
<p>As Merino runs as a single-threaded application using the asyncio-based
framework, it would be useful for engineers to get a good understanding
about how Merino performs and where it spends time and memory doing what
tasks to serve the requests. Local profiling offers us a way to look into
those low-level details.</p>
<p>We use <a href="https://github.com/plasma-umass/scalene">Scalene</a> as the profiler to conduct the profiling for Merino.
It's very easy to use, offers extremely detailed (at the line level)
insights with much lower overhead compared to other profilers.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>To start the profiling, you can run the following to start Merino with
Scalene:</p>
<pre><code class="language-sh">$ make profile

# or you can run it directly

$ python -m scalene merino/main.py
</code></pre>
<p>Then you can send requests to Merino manually or through using other
load testing tools. Once that's done, you can terminate the Merino
application. It will automatically collect profiling outputs (CPU &amp; Memory)
and open it in your browser.</p>
<h2 id="understand-the-outputs"><a class="header" href="#understand-the-outputs">Understand the outputs</a></h2>
<p>Out of the box, Scalene provides a very intuitive web interface to display
the profiling outputs. It's organized at the file (module) level. For each
file, it shows the CPU time and average memory usage for both the line profile
and the function profile of that module. You can also click on specific columns
to sort the lines or functions accordingly.</p>
<p>For more details of how to read the outputs, you can reference Scalene's
<a href="https://github.com/plasma-umass/scalene#output">documents</a>.</p>
<p>Equipped with those insights, you can have a good understanding about the
application, identify hotspots, bottlenecks, or other findings that are
not easy to uncover by only reading the source code. And then, you can tweak
or fix those issues, test or profile it again to verify if the fix is working.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
