<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Merino Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item "><a href="dev/index.html"><strong aria-hidden="true">4.</strong> Working on the code</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="dev/content-moderation.html"><strong aria-hidden="true">4.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="dev/dependencies.html"><strong aria-hidden="true">4.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="dev/logging-and-metrics.html"><strong aria-hidden="true">4.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="dev/middlewares.html"><strong aria-hidden="true">4.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="dev/feature_flags.html"><strong aria-hidden="true">4.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="dev/testing.html"><strong aria-hidden="true">4.6.</strong> Test Strategy</a></li><li class="chapter-item "><a href="dev/release-process.html"><strong aria-hidden="true">4.7.</strong> Release Process</a></li><li class="chapter-item "><a href="dev/profiling.html"><strong aria-hidden="true">4.8.</strong> Profiling</a></li></ol></li><li class="chapter-item "><a href="operations/index.html"><strong aria-hidden="true">5.</strong> Operations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/configs.html"><strong aria-hidden="true">5.1.</strong> Configs</a></li><li class="chapter-item "><a href="operations/elasticsearch.html"><strong aria-hidden="true">5.2.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="operations/jobs.html"><strong aria-hidden="true">5.3.</strong> Jobs</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="adr/index.html"><strong aria-hidden="true">6.</strong> Archive</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">6.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="adr/0002-merino-general-response.html"><strong aria-hidden="true">6.2.</strong> General API Response</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino"><a class="header" href="#merino">Merino</a></h1>
<p>Merino is a service that provides address bar suggestions to Firefox. Some of this content
comes from third party providers. In this case, Merino serves as a privacy preserving
buffer. User input in the address bar is handled by Merino and any clicked impression
will be delegated to a Mozilla-controlled service which will then send an interaction
ping if defined in the request and not to a provider directly. See API documentation
for more details.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<p><a href="./api.html">api.md - API Documentation</a> describes endpoints, query parameters, request and response headers, response objects and details on the suggestion objects.</p>
<p><a href="./firefox.html">firefox.md - Firefox and Merino Environments</a> describes how to enable
Merino in Firefox and lists the endpoints for the service in Production,
State and Dev.</p>
<p><a href="./data.html">data.md - Data, Metrics, Logging</a> describes all metrics and logs.</p>
<p><a href="./dev/index.html">dev/index.md - Basic Developer Docs</a> describes basics of working on Merino.</p>
<p><a href="./dev/dependencies.html">dev/dependencies.md - Development Dependencies</a> describes the development
dependencies required for Merino.</p>
<p><a href="./dev/logging-and-metrics.html">dev/logging-and-metrics.md - Logging and Metrics</a> describes metrics, logging, and telemetry.</p>
<p><a href="./dev/release-process.html">dev/release-process.md - Release Process</a> describes the release process of Merino in detail.</p>
<p><a href="./dev/testing.html">dev/testing.md - Testing</a> describes unit, integration, contract and load tests for Merino.</p>
<p><a href="./dev/profiling.html">dev/profiling.md - Profiling</a> describes how to profile Merino to address performance issues.</p>
<p><a href="./operations/configs.html">operations/configs.md - Configuring Merino</a> describes configuration management
of the project, Dynaconf setup, and the configuration of the HTTP server, logging, metrics, Remote Settings, and Sentry.</p>
<p><a href="./operations/elasticsearch.html">operations/elasticsearch.md - Elasticsearch Operations</a> describes some functionality and operations that
we do on the Elasticsearch cluster.</p>
<p><a href="./operations/jobs.html">operations/jobs.md - Merino Jobs</a> describes the jobs that are configured in Merino. Indicate where the jobs
exist and link to the details for how the jobs are run.</p>
<h2 id="about-the-name"><a class="header" href="#about-the-name">About the Name</a></h2>
<p>This project drives an important part of Firefox's &quot;felt experience&quot;. That is,
the feeling of using Firefox, hopefully in a delightful way. The word &quot;felt&quot; in
this phrase refers to feeling, but it can be punned to refer to the
<a href="https://en.wikipedia.org/wiki/Felt">textile</a>. Felt is often made of wool, and
Merino wool (from Merino sheep) produces exceptionally smooth felt.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre class="mermaid">flowchart TD
    User[\fa:fa-user User/]

    subgraph Firefox [fa:fa-firefox Firefox]
        online(Online Search and Suggest)
        offline(Offline Search and Suggest&lt;br/&gt;fetches adMarketplace, static Wikipedia, &lt;br/&gt;and other suggestions.&lt;br/&gt; Offline mode is fallback if Merino times out.)
    end

    User --&gt; |Accessing the Firefox URL bar| Firefox

    subgraph Merino [fa:fa-leaf Merino]
        srh(fa:fa-gears Suggest Request Handler)

        subgraph middleware [fa:fa-paperclip Middleware]
            Geolocation
            Logging
            UserAgent
            Metrics
        end

        maxmind[(MaxmindDB)]
        Geolocation --&gt; maxmind

        srh -..- middleware

        subgraph providers [fa:fa-truck Providers]
            adm(adm)
            amo(amo)
            toppicks(top-picks)
            weather(weather)
            wikipedia(wikipedia)
        end

        srh --&gt; adm
        srh --&gt; amo
        srh --&gt; toppicks
        srh --&gt; weather
        srh --&gt; wikipedia

        subgraph backends [fa:fa-server Backends]
            rsb(remote settings)
            accuweather(accuweather)
            elastic(elastic)
            toppicks_back(top picks)
            dynamic_amo(dynamic addons)

        end

        adm --&gt; rsb
        amo --&gt; dynamic_amo
        toppicks --&gt; toppicks_back
        weather --&gt; accuweather
        wikipedia --&gt; elastic
    end


    subgraph &quot;Airflow (Merino Jobs)&quot;
        wikipedia_sync(Wikipedia Sync)
        toppicks_sync(Top Picks Sync)
        addons_sync(Addons Remote Settings Upload)
    end

    addons_api(Addons API)
    dynamic_amo --&gt; addons_api

    elastico[(Elasticsearch)]
    elastic --&gt; elastico
    wikipedia_sync ..- |Syncs Wikipedia entries weekly| elastico

    accuweather_api(Accuweather API)
    accuweather ..-&gt; accuweather_api

    redis[(Redis Cache)]
    accuweather ..-&gt; |tries to query cache first| redis

    kinto[(Remote Settings)]
    rsb --- kinto
    addons_sync ..- |Add Addons Suggestions to Remote Settings| kinto

    toppicks_data[(GCS Top Picks Data,&lt;br/&gt;a list of Mozilla curated popular sites and metadata to be &lt;br/&gt;displayed on browser)]
    toppicks_sync ..-&gt; toppicks_data

    online --&gt; |/api/v1/suggest| srh
    offline ..- kinto
</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-api-documentation"><a class="header" href="#merino-api-documentation">Merino API documentation</a></h1>
<p>This page describes the API endpoints available on Merino.</p>
<p>The autogenerated API documentation exists <a href="https://merinopy.services.mozilla.com">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-firefox-and-merino-environments"><a class="header" href="#configuring-firefox-and-merino-environments">Configuring Firefox and Merino Environments</a></h1>
<p>Merino has been enabled by default in Firefox. Though, you will need to enable
the data sharing for Firefox Suggest to fully enable the feature. To enable it,
type <code>about:config</code> in the URL bar set the Firefox preference
<code>browser.urlbar.quicksuggest.dataCollection.enabled</code> to <code>true</code>. By default,
Merino will connect to the production environments. This is controlled with the
<code>browser.urlbar.merino.endpointURL</code> preference. See below for other options.</p>
<p>You can also query any of the endpoint URLs below with something like:</p>
<pre><code class="language-sh">curl 'https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest?q=your+query'
</code></pre>
<h2 id="environments"><a class="header" href="#environments">Environments</a></h2>
<h3 id="production"><a class="header" href="#production">Production</a></h3>
<p><em>Endpoint URL</em>: <a href="https://merino.services.mozilla.com/api/v1/suggest">https://merino.services.mozilla.com/api/v1/suggest</a></p>
<p>The primary environment for end users. Firefox is configured to use this by
default.</p>
<h3 id="stage"><a class="header" href="#stage">Stage</a></h3>
<p><em>Endpoint URL</em>: <a href="https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest">https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest</a></p>
<p>This environment is used for manual and load testing of the server. It is not
guaranteed to be stable or available. It is used as a part of the deploy process
to verify new releases before they got to production.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collection"><a class="header" href="#data-collection">Data collection</a></h1>
<p>This page should list all metrics and logs that Merino is expected to emit in
production, including what should be done about them, if anything.</p>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>This list does not include any <code>DEBUG</code> level events, since those are not logged
by default in production. The level and type of the log is listed.</p>
<p>Any log containing sensitive data must include a boolean field <code>sensitive</code>
that is set to <code>true</code> to exempt it from flowing to the generally accessible
log inspection interfaces.</p>
<h3 id="merino-apis"><a class="header" href="#merino-apis">Merino APIs</a></h3>
<ul>
<li>
<p><code>INFO web.suggest.request</code> - A suggestion request is being processed. This
event will include fields for all relevant details of the request. <strong>Fields:</strong></p>
<ul>
<li><code>sensitive</code> - Always set to true to ensure proper routing.</li>
<li><code>query</code> - If query logging is enabled, the text the user typed. Otherwise an
empty string.</li>
<li><code>country</code> - The country the request came from.</li>
<li><code>region</code> - The first country subdivision the request came from.</li>
<li><code>city</code> - The city the request came from.</li>
<li><code>dma</code> - A US-only location description that is larger than city and smaller
than states, but does not align to political borders.</li>
<li><code>agent</code> - The original user agent.</li>
<li><code>os_family</code> - Parsed from the user agent. One of &quot;windows&quot;, &quot;macos&quot;,
&quot;linux&quot;, &quot;ios&quot;, &quot;android&quot;, &quot;chrome os&quot;, &quot;blackberry&quot;, or &quot;other&quot;.</li>
<li><code>form_factor</code> - Parsed from the user agent. One of &quot;desktop&quot;, &quot;phone&quot;,
&quot;tablet&quot;, or &quot;other&quot;</li>
<li><code>browser</code> - The browser and possibly version detected. Either &quot;Firefox(XX)&quot;
where XX is the version, or &quot;Other&quot;.</li>
<li><code>rid</code> - The request ID.</li>
<li>WIP <code>accepts_english</code> - True if the user's Accept-Language header includes an
English locale, false otherwise.</li>
<li><code>requested_providers</code> - A comma separated list of providers requested via
the query string, or an empty string if none were requested (in which case
the default values would be used).</li>
<li><code>client_variants</code> - Any client variants sent to Merino in the query string.</li>
<li><code>session_id</code> - A UUID generated by the client for each search session.</li>
<li><code>sequence_no</code> -  A client-side event counter (0-based) that records the query
sequence within each search session.</li>
</ul>
</li>
<li>
<p><code>INFO request.summary</code> - The application request summary that follows the <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a>
convention. This log is recorded for all incoming HTTP requests except for the
suggest API endpoint.</p>
</li>
</ul>
<ul>
<li><code>ERROR dockerflow.error_endpoint</code> - The <code>__error__</code> endpoint of the server was
called. This is used to test our error reporting system. It is not a cause for
concern, unless we receive a large amount of these records, in which case some
outside service is likely malicious or misconfigured.</li>
</ul>
<h3 id="merino-middleware-logs"><a class="header" href="#merino-middleware-logs">Merino Middleware Logs</a></h3>
<h4 id="geolocation"><a class="header" href="#geolocation">Geolocation</a></h4>
<ul>
<li><code>WARNING merino.middleware.geolocation</code> - There was an error with a geolocation lookup.</li>
</ul>
<h3 id="merino-cron-tasks"><a class="header" href="#merino-cron-tasks">Merino Cron Tasks</a></h3>
<ul>
<li><code>WARNING merino.cron</code> - There was an error while executing a cron task.</li>
</ul>
<h3 id="merino-feature-flags"><a class="header" href="#merino-feature-flags">Merino Feature Flags</a></h3>
<ul>
<li><code>ERROR merino.featureflags</code> - There was an error while attempting to assign a
feature flag for a suggest API request.</li>
</ul>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<blockquote>
<p>A note on timers: Statsd timers are measured in milliseconds, and are reported
as integers (at least in Cadence). Milliseconds are often not precise enough
for the tasks we want to measure in Merino. Instead, we use generic histograms
to record microsecond times. Metrics recorded in this way should have <code>-us</code>
appended to their name, to mark the units used (since we shouldn't put the
proper unit Œºs in metric names).</p>
</blockquote>
<ul>
<li>
<p><code>merino.providers.initialize</code> - A timer to measure the overall initialization
duration (in ms) for <em>all</em> providers.</p>
</li>
<li>
<p><code>merino.providers.initialize.&lt;provider&gt;</code> - A timer to measure the initialization
duration (in ms) for the given <code>&lt;provider&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.providers.initialize.adm</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.status_codes.&lt;status_code&gt;</code> - A counter to measure
the status codes of an HTTP method for the <code>&lt;url_path&gt;</code>.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.status_codes.200</code></p>
</li>
<li>
<p><code>merino.&lt;http_method&gt;.&lt;url_path&gt;.timing</code> - A timer to measure the duration (in ms)
of an HTTP method for a URL path.</p>
<p><strong>Example</strong>:
<code>merino.get.api.v1.suggest.timing</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query</code> - A timer to measure the query duration (in ms) of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.adm.query</code></p>
</li>
<li>
<p><code>merino.&lt;provider_module&gt;.query.timeout</code> - A counter to measure the query timeouts of
a certain suggestion provider.</p>
<p><strong>Example</strong>:
<code>merino.providers.wikipedia.query.timeout</code></p>
</li>
<li>
<p><code>merino.suggestions-per.request</code> - A histogram metric to get the distribution of
suggestions per request.</p>
</li>
<li>
<p><code>merino.suggestions-per.provider.&lt;provider_module&gt;</code> - A histogram metric to get the distribution of
suggestions returned per provider (per request).</p>
<p><strong>Example</strong>:
<code>merino.suggestions-per.provider.wikipedia</code></p>
</li>
</ul>
<h3 id="accuweather"><a class="header" href="#accuweather">AccuWeather</a></h3>
<p>The weather provider records additional metrics.</p>
<ul>
<li><code>merino.providers.accuweather.query.cache.fetch</code> - A timer to measure the duration (in ms) of
looking up a weather report in the cache.</li>
<li><code>merino.providers.accuweather.query.cache.hit</code> - A counter to measure the number of times a
cached weather report is available.</li>
<li><code>merino.providers.accuweather.query.cache.miss</code> - A counter to measure the number of times a
weather report isn't in the cache.</li>
<li><code>merino.providers.accuweather.query.backend.get</code> - A timer to measure the duration (in ms) of a
request for a weather report from the backend. This metric isn't recorded for cache hits.</li>
<li><code>merino.providers.accuweather.query.cache.store</code> - A timer to measure the duration (in ms) of
saving a weather report from the backend to the cache. This metric isn't recorded for cache hits.</li>
<li><code>merino.providers.accuweather.query.cache.error</code> - A counter to measure the number of times the
cache store returned an error when fetching or storing a weather report. This should be 0 in
normal operation. In case of an error, the logs will include a <code>WARNING</code> with the full error
message.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation-for-working-on-merino"><a class="header" href="#developer-documentation-for-working-on-merino">Developer documentation for working on Merino</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">tl;dr</a></h2>
<p>Here are some useful commands when working on Merino.</p>
<h3 id="run-the-main-app"><a class="header" href="#run-the-main-app">Run the main app</a></h3>
<p>This project uses <a href="https://python-poetry.org/">Poetry</a> for dependency management.
See <a href="dev/./dependencies.html">dependencies</a> for how to install Poetry on your machine.</p>
<p>Install all the dependencies:</p>
<pre><code>$ poetry install
</code></pre>
<p>Run Merino:</p>
<pre><code>$ poetry run uvicorn merino.main:app --reload

# Or you can use a shortcut
$ make run
</code></pre>
<h3 id="general-commands"><a class="header" href="#general-commands">General commands</a></h3>
<pre><code class="language-shell"># List all available make commands with descriptions
$ make help

# Just like `poetry install`
$ make install

# Run isort
$ make isort

# Run black
$ make black

# Run flake8
$ make flake8

# Run bandit
$ make bandit

# Run pydocstyle
$ make pydocstyle

# Run mypy
$ make mypy

# Run all linting checks
$ make -k lint

# Run all formatters
$ make format

# Run merino-py with the auto code reloading
$ make dev

# Run merino-py without the auto code reloading
$ make run

# Run unit and integration tests and evaluate combined coverage
$ make test

# Evaluate combined unit and integration test coverage
$ make test-coverage-check

# Run unit tests
$ make unit-tests

# List fixtures in use per unit test
$ make unit-test-fixtures

# Run integration tests
$ make integration-tests

# List fixtures in use per integration test
$ make integration-test-fixtures

# Build the docker image for Merino named &quot;app:build&quot;
$ make docker-build

# Run contract tests on existing merino-py docker image
$ make run-contract-tests

# Run contract tests, with build step
$ make contract-tests

# Run contract tests cleanup
$ make contract-tests-clean

# Run local execution of (Locust) load tests using existing merino-py docker image
$ make run-load-tests

# Run local execution of (Locust) load tests, with merino-py docker build step
$ make load-tests

# Stop and remove containers and networks for load tests
$ make load-tests-clean

# Generate documents
$ make doc

# Preview the generated documents
$ make doc-preview

# Profile Merino with Scalene
$ make profile

# Run the Wikipedia CLI job
$ make wikipedia-indexer job=$JOB
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>You can generate documentation, both code level and book level, for Merino and
all related crates by running <code>./dev/make-all-docs.sh</code>. You'll need <a href="https://rust-lang.github.io/mdBook/">mdbook</a>
and <a href="https://github.com/badboy/mdbook-mermaid">mdbook-mermaid</a>, which you can install via:</p>
<pre><code class="language-sh">make doc-install-deps
</code></pre>
<p>If you haven't installed Rust and Cargo, you can reference the official Rust
<a href="https://doc.rust-lang.org/cargo/getting-started/installation.html">document</a>.</p>
<h2 id="local-configuration"><a class="header" href="#local-configuration">Local configuration</a></h2>
<p>The default configuration of Merino is <code>development</code>, which has human-oriented
pretty-print logging and debugging enabled. For settings that you wish to change in the
development configuration, you have two options, listed below.</p>
<blockquote>
<p>For full details, make sure to check out the documentation for
<a href="dev/../operations/configs.html">Merino's setting system (operations/configs.md)</a>.</p>
</blockquote>
<h3 id="update-the-defaults"><a class="header" href="#update-the-defaults">Update the defaults</a></h3>
<p>Dynaconf is used for all configuration management in Merino, where
values are specified in the <code>merino/configs/</code> directory in <code>.toml</code> files. Environment variables
are set for each environment as well and can be set when using the cli to launch the
Merino service.
Environment variables take precedence over the values set in the <code>.toml</code> files, so
any environment variable set will automatically override defaults. By the same token,
any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.</p>
<p>If the change you want to make makes the system better for most development
tasks, consider adding it to <code>merino/configs/development.toml</code>, so that other developers
can take advantage of it. If you do so, you likely want to add validation to those settings
which needs to be added in <code>merino/config.py</code>, where the Dynaconf instance exists along
with its validators. For examples of the various config settings, look at <code>configs/default.toml</code>
and <code>merino/config.py</code> to see an example of the structure.</p>
<p>It is not advisable to put secrets in <code>configs/secrets.toml</code>.</p>
<h3 id="create-a-local-override"><a class="header" href="#create-a-local-override">Create a local override</a></h3>
<p>Dynaconf will use the specified values and environment variables in the
<code>merino/configs/default.toml</code> file. You can change the environment you
want to use as mentioned above, but for local changes to adapt to your
machine or tastes, you can put the configuration in <code>merino/configs/development.local.toml</code>.
This file doesn't exist by default, so you will have to create it.
Then simply copy from the other config files and make the adjustments
that you require. These files should however not be checked into source
control and are configured to be ignored, so long as they follow the <code>*.local.toml</code>
format. Please follow this convention and take extra care to not check them in
and only use them locally.</p>
<p>See the <a href="https://www.dynaconf.com/">Dynaconf Documentation</a> for more details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="content-moderation"><a class="header" href="#content-moderation">Content Moderation</a></h1>
<p>Merino is capable of filtering and blocking of sensitive content.</p>
<h2 id="dynamic-wikipedia-provider"><a class="header" href="#dynamic-wikipedia-provider">Dynamic Wikipedia Provider</a></h2>
<h3 id="wikipedia-title-block-list"><a class="header" href="#wikipedia-title-block-list">Wikipedia Title Block List</a></h3>
<p>Located in <code>/merino/utils/block_list.py</code></p>
<p>This block list is used during the indexing job for Dynamic Wikipedia as well as at the
provider level for ensuring suggestions of a given title are not returned to the client.
This allows for granular control or ad-hoc updates of titles we wish to ignore.</p>
<p><em>NOTE:</em> In adding to the block list, ensure the title field is added as it appears
with correct spacing between the words. Membership checks of the block list are not
case sensitive and any underscores in the titles should instead be spaces.
In adding to the list, one should attempt to add the title as it appears in Wikipedia.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-dependencies"><a class="header" href="#development-dependencies">Development Dependencies</a></h1>
<h2 id="package-dependencies"><a class="header" href="#package-dependencies">Package Dependencies</a></h2>
<p>This project uses <a href="https://python-poetry.org/">Poetry</a> for dependency management. While you can use the
vanilla virtualenv to set up the dev environment, we highly recommend to check
out <a href="https://github.com/pyenv/pyenv">pyenv</a> and <a href="https://github.com/pyenv/pyenv-virtualenv">pyenv-virtualenv</a>, as they work nicely with Poetry.
Follow the instructions to install <a href="https://github.com/pyenv/pyenv#installation">pyenv</a>, <a href="https://github.com/pyenv/pyenv-virtualenv#installation">pyenv-virtualenv</a>, and
<a href="https://python-poetry.org/docs/#installation">poetry</a>.</p>
<p>Feel free to browse the <a href="dev//pyproject.toml">pyproject.toml</a> file for a listing of dependencies
and their versions.</p>
<p>Once Poetry is installed, install all the dependencies:</p>
<pre><code>$ poetry install
</code></pre>
<p>Add packages to project via poetry</p>
<pre><code>$ poetry add &lt;package_name&gt;
</code></pre>
<p>After that you should be to run Merino as follows:</p>
<pre><code>$ poetry run uvicorn merino.main:app --reload

# Or you can fire up a poetry shell to make it shorter
$ poetry shell
$ uvicorn merino.main:app --reload
</code></pre>
<h2 id="service-dependencies"><a class="header" href="#service-dependencies">Service Dependencies</a></h2>
<p>Merino uses a Redis-based caching system, and so requires a Redis instance to
connect to.</p>
<p>To make things simple, Redis (and any future service dependencies) can be
started with Docker Compose, using the <code>docker-compose.yaml</code> file in the <code>dev/</code>
directory. Notably, this does not run any Merino components that have source
code in this repository.</p>
<pre><code class="language-shell">$ cd dev
$ docker-compose up

# Or run services in deamon mode
$ docker-compose up -d

# Stop it
$ docker-compose down


# Shortcuts are also provided
$ make docker-compose-up
$ make docker-compose-up-daemon
$ make docker-compose-down
</code></pre>
<p>Redis is listening on port 6397 and can be connected via <code>redis://localhost:6397</code>.</p>
<p>This Dockerized set up is optional. Feel free to run the dependent services by
any other means as well.</p>
<h3 id="dev-helpers"><a class="header" href="#dev-helpers">Dev Helpers</a></h3>
<p>The docker-compose setup also includes some services that can help during
development.</p>
<ul>
<li>Redis Commander, http://localhost:8081 - Explore the Redis database started
above.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-and-metrics"><a class="header" href="#logging-and-metrics">Logging and Metrics</a></h1>
<p>To get data out of Merino and into observable systems, we use <em>metrics</em> and
<em>logging</em>. Each has a unique use case. Note that in general, because of the scale
we work at, adding a metric or log event in production is not free, and if we
are careless can end up costing quite a bit. Record what is needed, but don't go
over board.</p>
<p>All data collection that happens in production (logging at INFO, WARN, or ERROR
levels; and metrics) should be documented in <a href="dev/../data.html"><code>docs/data.md</code></a>.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>Merino uses <a href="https://firefox-source-docs.mozilla.org/mozbase/mozlog.html">MozLog</a> for structured logging. Logs can be recorded through the
standard Python <code>logging</code> module. Merino can output logs in various formats,
including a JSON format (MozLog) for production. A pretty, human readable format
is also provided for development and other use cases.</p>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>MozLog requires that all messages have a <code>type</code> value. By convention, we use
the name of the Python module, where the log record get issued, to populate this
field. For example:</p>
<pre><code class="language-py">import logging

logger = logging.getLogger(__name__)

# The `type` field of the log record will be the same as `__name__`.
logger.info(&quot;A new log message&quot;, data=extra_fields)
</code></pre>
<p>In general, the log <em>message</em> (&quot;An empty MultiProvider was created&quot;) and the log
<em>type</em> should both tell the reader what has happened. The difference is that the
message is for humans and the type is for machines.</p>
<h3 id="levels"><a class="header" href="#levels">Levels</a></h3>
<p>Tracing provides five log levels that should be familiar. This is what we mean
by them in Merino:</p>
<ul>
<li>
<p><code>CRITICAL</code> - There was a serious error indicating that the program itself may
be unable to continue running.</p>
</li>
<li>
<p><code>ERROR</code> - There was a problem, and the task was not completable. This usually
results in a 500 being sent to the user. All error logs encountered in
production are reported to Sentry and should be considered a bug. If it isn't
a bug, it shouldn't be logged as an error.</p>
</li>
<li>
<p><code>WARNING</code> - There was a problem, but the task was able to recover. This
doesn't usually affect what the user sees. Warnings are suitable for
unexpected but &quot;in-spec&quot; issues, like a sync job not returning an empty set or
using a deprecated function. These are not reported to Sentry.</p>
</li>
<li>
<p><code>INFO</code> - This is the default level of the production service. Use for logging
that something happened that isn't a problem and we care about in production.
This is the level that Merino uses for it's one-per-request logs and sync
status messages. Be careful adding new per-request logs at this level, as they
can be expensive.</p>
</li>
<li>
<p><code>DEBUG</code> - This is the default level for developers running code locally. Use
this to give insight into how the system is working, but keep in mind that
this will be on by default, so don't be too noisy. Generally this should
summarize what's happening, but not give the small details like a log line for
every iteration of a loop. Since this is off in production, there are no cost
concerns.</p>
</li>
</ul>
<h2 id="metrics-1"><a class="header" href="#metrics-1">Metrics</a></h2>
<p>Merino metrics are reported as <a href="https://www.datadoghq.com/blog/statsd/.">Statsd</a> metrics.</p>
<p>Unlike logging, the primary way that metrics reporting can cost a lot is in
<em>cardinality</em>. The number of metric IDs we have and the combination of tag
values that we supply. Often the number of individual events doesn't matter as
much, since multiple events are aggregated together.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="middlwares"><a class="header" href="#middlwares">Middlwares</a></h1>
<p>Merino leverages middleware for various functionalities such as logging, metrics,
parsing for geolocation &amp; user agent, feature flags etc. Middleware is defined
in the <code>merino/middleware</code> directory.</p>
<h2 id="caveat"><a class="header" href="#caveat">Caveat</a></h2>
<p>We currently don't implement middleware using the middleware facilities provided
by FastAPI/Starlette as they've shown significant performance overhead, preventing
Merino from achieving the SLOs required by Firefox Suggest.</p>
<p>Before those performance issues get resolved in the upstream, we will be implementing
middleware for Merino through the <a href="https://asgi.readthedocs.io/en/latest/specs/www.html">ASGI protocol</a>. You can also reference this
<a href="https://florimond.dev/en/posts/2019/08/introduction-to-asgi-async-python-web/">tutorial</a> to learn more about ASGI. See Starlette's <a href="https://www.starlette.io/middleware/">middleware</a> document
for more details about how to write pure ASGI middlewares. Specifically, we can reuse
Starlette's data structures (<code>Request</code>, <code>Headers</code>, <code>QueryParams</code> etc.) to facilitate
the implementation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="feature-flags"><a class="header" href="#feature-flags">Feature Flags</a></h1>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>Do you plan to release code behind a feature flag? Great! üòÉ</p>
<p>Your feature flag needs to be defined first. If it's already defined, go ahead.
Otherwise check the configuration section <a href="dev/feature_flags.html#configuration">below</a> before you
continue.</p>
<p>Use the following line in API endpoint code to gain access to the feature flags
object:</p>
<pre><code class="language-python">feature_flags: FeatureFlags = request.scope[ScopeKey.FEATURE_FLAGS]
</code></pre>
<p>Then check whether a certain feature flag, such as <code>example</code>, is enabled by calling:</p>
<pre><code class="language-python">if feature_flags.is_enabled(&quot;example&quot;):
    print(&quot;feature flag 'example' is enabled! üöÄ&quot;)
</code></pre>
<p>When you do that, the decision (whether the feature flag is enabled or not) is
recorded and stored in a <code>dict</code> on the <code>decisions</code> attribute of the feature
flags object.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>The feature flags system in Merino consists of three components:</p>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Location</th></tr></thead><tbody>
<tr><td>A FastAPI middleware that reads the query parameter <code>sid</code> sent by the client application and sets a session ID for the current request based on that.</td><td><code>merino/middleware/featureflags.py</code></td></tr>
<tr><td>A <code>FeatureFlags</code> class which you can use to check if a certain feature flag is enabled.</td><td><code>merino/featureflags.py</code></td></tr>
<tr><td>A local directory containing static files that define and configure feature flags for Merino.</td><td><code>merino/configs/flags/</code></td></tr>
</tbody></table>
</div>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Currently two bucketing schemes are supported: <code>random</code> and <code>session</code>.</p>
<h3 id="random"><a class="header" href="#random">Random</a></h3>
<p>Random does what it says on the tin. It generates a random bucketing ID for
every flag check.</p>
<h3 id="session"><a class="header" href="#session">Session</a></h3>
<p>Session bucketing uses the session ID of the request as the bucketing key so
that feature checks within a given search session would be consistent.</p>
<h3 id="fields"><a class="header" href="#fields">Fields</a></h3>
<p>Each flag defines the following fields:</p>
<pre><code class="language-toml">[default.flags.&lt;flag_name&gt;]
scheme = 'session'
enabled = 0.5
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>scheme</code></td><td>This is the bucketing scheme for the flag. Allowed values are <code>'random'</code> and <code>'session'</code></td></tr>
<tr><td><code>enabled</code></td><td>This represents the % enabled for the flag and must be a float between <code>0</code> and <code>1</code></td></tr>
</tbody></table>
</div>
<h2 id="metrics-2"><a class="header" href="#metrics-2">Metrics</a></h2>
<p>When submitting application metrics, feature flag decisions that were made while
processing the current request up to this point are <strong>automatically</strong> added as
tags to the emitted metrics.</p>
<p>The format of these tags is:</p>
<pre><code>feature_flag.&lt;feature_flag_name&gt;
</code></pre>
<p>For more information about this see the <code>ClientMeta</code> meta class and the
<code>add_feature_flags</code> decorator in <code>merino/metrics.py</code>.</p>
<h2 id="monitoring-in-grafana"><a class="header" href="#monitoring-in-grafana">Monitoring in Grafana</a></h2>
<p>Because feature flag decisions are automatically added as tags to emitted
metrics, you can use them in your queries in Grafana. üìà</p>
<p>For example, if you want to group by decisions for a feature flag with name
<code>hello_world</code>, you can use <code>tag(feature_flag.hello_world)</code> in <code>GROUP BY</code> in
Grafana. You can also use <code>[[tag_feature_flag.hello_world]]</code> in the <code>ALIAS</code> for
panel legends.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-strategy"><a class="header" href="#test-strategy">Test Strategy</a></h1>
<p>Merino is tested using a combination of functional and performance tests.</p>
<p>Test code resides in the <code>tests</code> directory.</p>
<h2 id="functional"><a class="header" href="#functional">Functional</a></h2>
<p>The functional test strategy is four-tiered, composed of: unit, integration, contract
and end-to-end testing.</p>
<h3 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h3>
<p>The unit layer is suitable for testing complex behavior at a small scale, with
fine-grained control over the inputs. Due to their narrow scope, unit tests are
fundamental to thorough test coverage.</p>
<p>To execute unit tests, use: <code>make unit-tests</code></p>
<p>Unit tests are written and executed with pytest and are located in the <code>tests/unit</code>
directory, using the same organizational structure as the source code of the merino
service. Type aliases dedicated for test should be stored in the <code>types.py</code> module.
The <code>conftest.py</code> modules contain common utilities in fixtures.</p>
<p>For a breakdown of fixtures in use per test, use: <code>make unit-test-fixtures</code></p>
<p>Available fixtures include:</p>
<h4 id="filtercaplogfixture"><a class="header" href="#filtercaplogfixture">FilterCaplogFixture</a></h4>
<p>Useful when verifying log messages, this fixture filters log records captured with
pytest's caplog by a given <code>logger_name</code>.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_filter_caplog(
    caplog: LogCaptureFixture, filter_caplog: FilterCaplogFixture
) -&gt; None:
    records: list[LogRecord] = filter_caplog(caplog.records, &quot;merino.providers.adm&quot;)
</code></pre>
<p>Note: This fixture is shared with integration tests.</p>
<h4 id="suggestionrequestfixture"><a class="header" href="#suggestionrequestfixture">SuggestionRequestFixture</a></h4>
<p>For use when querying providers, this fixture creates a SuggestionRequest object with
a given <code>query</code></p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_suggestion_request(srequest: SuggestionRequestFixture) -&gt; None:
    request: SuggestionRequest = srequest(&quot;example&quot;)
    result: list[BaseSuggestion] = await provider.query(request)
</code></pre>
<h4 id="scopefixture-receivemockfixture--sendmockfixture"><a class="header" href="#scopefixture-receivemockfixture--sendmockfixture">ScopeFixture, ReceiveMockFixture &amp; SendMockFixture</a></h4>
<p>For use when testing middleware, these fixtures initialize or mock the common Scope,
Receive and Send object dependencies.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_middleware(scope: Scope, receive_mock: Receive, send_mock: Send) -&gt; None:
    pass
</code></pre>
<h3 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h3>
<p>The integration layer of testing allows for verification of interactions between
service components, with lower development, maintenance and execution costs compared
with higher level tests, such as contract tests.</p>
<p>To execute integration tests, use: <code>make integration-tests</code></p>
<p>Integration tests are located in the <code>tests/integration</code> directory. They use pytest and
the FastAPI <code>TestClient</code> to send requests to specific merino endpoints and verify
responses as well as other outputs, such as logs. Tests are organized according to the
API path under test. Type aliases dedicated for test should be stored in the <code>types.py</code>
module. Fake providers created for test should be stored in the <code>fake_providers.py</code>
module. The <code>conftest.py</code> modules contain common utilities in fixtures.</p>
<p>For a breakdown of fixtures in use per test, use: <code>make integration-test-fixtures</code></p>
<p>Available fixtures include:</p>
<h4 id="filtercaplogfixture-1"><a class="header" href="#filtercaplogfixture-1">FilterCaplogFixture</a></h4>
<p><a href="dev/testing.html#FilterCaplogFixture">Details</a> available in Unit Tests section</p>
<h4 id="testclientfixture"><a class="header" href="#testclientfixture">TestClientFixture</a></h4>
<p>This fixture creates an instance of the TestClient to be used in testing API calls.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_test_client(client: TestClient):
    response: Response = client.get(&quot;/api/v1/endpoint&quot;)
</code></pre>
<h4 id="testclientwitheventsfixture"><a class="header" href="#testclientwitheventsfixture">TestClientWithEventsFixture</a></h4>
<p>This fixture creates an instance of the TestClient, that will trigger event handlers
(i.e. <code>startup</code> and <code>shutdown</code>) to be used in testing API calls.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_test_client_with_event(client_with_events: TestClient):
    response: Response = client_with_events.get(&quot;/api/v1/endpoint&quot;)
</code></pre>
<h4 id="requestsummarylogdatafixture"><a class="header" href="#requestsummarylogdatafixture">RequestSummaryLogDataFixture</a></h4>
<p>This fixture will extract the extra log data from a captured 'request.summary'
LogRecord for verification</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_log_data(
    caplog: LogCaptureFixture,
    filter_caplog: FilterCaplogFixture,
    extract_request_summary_log_data: LogDataFixture
):
    records: list[LogRecord] = filter_caplog(caplog.records, &quot;request.summary&quot;)
    assert len(records) == 1

    record: LogRecord = records[0]
    log_data: dict[str, Any] = extract_request_summary_log_data(record)
    assert log_data == expected_log_data
</code></pre>
<h4 id="injectprovidersfixture--providersfixture"><a class="header" href="#injectprovidersfixture--providersfixture">InjectProvidersFixture &amp; ProvidersFixture</a></h4>
<p>These fixture will setup and teardown given providers.</p>
<p><em><strong>Usage:</strong></em></p>
<p>If specifying providers for a module:</p>
<pre><code class="language-python">@pytest.fixture(name=&quot;providers&quot;)
def fixture_providers() -&gt; Providers:
    return {&quot;test-provider&quot;: TestProvider()}
</code></pre>
<p>If specifying providers for a test:</p>
<pre><code class="language-python">@pytest.mark.parametrize(&quot;providers&quot;, [{&quot;test-provider&quot;: TestProvider()}])
def test_with_provider() -&gt; None:
    pass
</code></pre>
<h4 id="setupprovidersfixture"><a class="header" href="#setupprovidersfixture">SetupProvidersFixture</a></h4>
<p>This fixture sets application provider dependency overrides.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">def test_with_setup_providers(setup_providers: SetupProvidersFixture):
    providers: dict[str, BaseProvider] = {&quot;test-provider&quot;: TestProvider()}
    setup_providers(providers)
</code></pre>
<h4 id="teardownprovidersfixture"><a class="header" href="#teardownprovidersfixture">TeardownProvidersFixture</a></h4>
<p>This fixture resets application provider dependency overrides and is often used in
teardown fixtures.</p>
<p><em><strong>Usage:</strong></em></p>
<pre><code class="language-python">@pytest.fixture(autouse=True)
def teardown(teardown_providers: TeardownProvidersFixture):
    yield
    teardown_providers()
</code></pre>
<h3 id="contract-tests"><a class="header" href="#contract-tests">Contract Tests</a></h3>
<p>The tests in the <code>tests/contract</code> directory are contract tests
that consume Merino's APIs using more opaque techniques. These tests run against
a Docker container of the service, specify settings via environment variables,
and operate on the HTTP API layer only and as such are more concerned with
external contracts and behavior. The contract tests cannot configure the server
per test.</p>
<p>For more details see the README.md file in the <code>test/contract</code> directory.</p>
<h3 id="end-to-end-tests"><a class="header" href="#end-to-end-tests">End-to-End Tests</a></h3>
<p>The end-to-end tests are executed manually by Softvision.</p>
<h2 id="performance"><a class="header" href="#performance">Performance</a></h2>
<h3 id="load-tests"><a class="header" href="#load-tests">Load Tests</a></h3>
<p>The tests in the <code>tests/load</code> directory are load tests that spawn multiple HTTP
clients that consume Merino's API in order to simulate real-world load on the Merino
infrastructure. These tests use the Locust framework and are triggered manually at the
discretion of the Merino Engineering Team.</p>
<p>For more details see the README.md file in the <code>test/load</code> directory.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-release-process"><a class="header" href="#the-release-process">The Release Process</a></h1>
<p>This project currently follows a <a href="https://en.wikipedia.org/wiki/Continuous_deployment">Continuous Deployment</a> process.</p>
<p>Whenever a commit is pushed to this repository's <code>main</code> branch, a CircleCI workflow is triggered
which performs code checks and runs automated tests. The workflow additionally builds a new Docker
image of the service and pushes that Docker image to the Docker Hub registry (this requires all
previous jobs to pass).</p>
<p>Pushing a new Docker image to the Docker Hub registry triggers a webhook that starts the Jenkins
deployment pipeline (the Docker image tag determines the target environment). The deployment
pipeline first deploys to the <a href="dev/../firefox.html#stage"><code>stage</code> environment</a> and subsequently to the
<a href="dev/../firefox.html#production"><code>production</code> environment</a>.</p>
<p><img src="dev/./circleci_main_workflow.jpg" alt="Activity diagram of CircleCI main-workflow" /></p>
<p>After the deployment is complete, accessing the <a href="https://stage.merino.nonprod.cloudops.mozgcp.net/__version__"><code>__version__</code> endpoint</a> will show
the commit hash of the deployed version, which will eventually match to the one of the latest commit
on the <code>main</code> branch (a node with an older version might still serve the request before it is shut
down).</p>
<h2 id="development-guidelines"><a class="header" href="#development-guidelines">Development Guidelines</a></h2>
<p>Please see the <a href="https://github.com/mozilla-services/merino-py/blob/main/CONTRIBUTING.md">CONTRIBUTING.md</a> docs on commit guidelines and pull request best
practices.</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>The commit hash of the deployed code is considered its version identifier. The commit hash can be
retrieved locally via <code>git rev-parse HEAD</code>.</p>
<h2 id="load-testing"><a class="header" href="#load-testing">Load Testing</a></h2>
<p>Load testing can be run locally or as a part of the deployment process. Local execution does not
require any labeling in commit messages. For deployment, you have to add a label to the message of
the commit that you wish to deploy in the form of: <code>[load test: (abort|warn)]</code>. In most cases this
will be the merge commit created by merging a GitHub pull request.</p>
<p><code>abort</code> will prevent deployment should the load testing fail while <code>warn</code> will warn via Slack and
continue deployment. For detailed specifics on load testing and this convention, please see the
<a href="https://github.com/mozilla-services/merino-py/blob/main/tests/load/README.md">Load Test README</a>.</p>
<p>Logs from load tests executed in continuous deployment are available in the <code>/data</code> volume of the
Locust master kubernetes pod.</p>
<h2 id="releasing-to-production"><a class="header" href="#releasing-to-production">Releasing to production</a></h2>
<p>Developers with write access to the Merino repository will initiate a deployment to production when
a Pull-Request on the Merino GitHub repository is merged to the <code>main</code> branch. It is recommended to
merge pull requests during hours when the majority of Contile contributors are online.</p>
<p>While any developer with write access can trigger the deployment to production, the <em>expectation</em> is
that the individual(s) who authored and merged the Pull-Request should do so, as they are the ones
most familiar with their changes and who can tell, by looking at the data, if anything looks
anomalous. Developers <strong>must</strong> monitor the <a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/wip-merino-py-application-and-infrastructure?orgId=1&amp;from=now-24h&amp;to=now&amp;var-environment=prodpy&amp;refresh=1m">Merino Application &amp; Infrastructure</a>
dashboard for any anomaly, for example significant changes in HTTP response codes, increase in
latency, container/cpu/memory usage (most things under the 'Infrastructure' heading).</p>
<h3 id="what-to-do-if-tests-fail-during-deployment"><a class="header" href="#what-to-do-if-tests-fail-during-deployment">What to do if tests fail during deployment?</a></h3>
<ol>
<li>
<p>Investigate the cause of the test failure</p>
<ul>
<li>For functional tests (unit, integration or contract), logs can be found on
<a href="https://app.circleci.com/pipelines/github/mozilla-services/merino-py">CircleCI</a></li>
<li>For performance tests (load), insights can be found on <a href="https://earthangel-b40313e5.influxcloud.net/d/rQAfYKIVk/wip-merino-py-application-and-infrastructure?orgId=1&amp;from=now-24h&amp;to=now&amp;var-environment=prodpy&amp;refresh=1m">Grafana</a> and in the
Locust logs. To access the Locust logs:
<ol>
<li>Open a cloud shell in the <a href="https://console.cloud.google.com/kubernetes/list/overview?project=moz-fx-merino-nonprod-ee93">Merino stage environment</a></li>
<li>Authenticate by executing the following command:</li>
</ol>
<pre><code class="language-shell">gcloud container clusters get-credentials merino-nonprod-v1 \
  --region us-west1 --project moz-fx-merino-nonprod-ee93
</code></pre>
<ol start="3">
<li>Access the data in the Kubernetes pod by executing the following command:</li>
</ol>
<pre><code class="language-shell">  kubectl exec -it -n locust-merino locust-master-0 -- bash -c &quot;cd /data &amp;&amp; /bin/bash&quot;
</code></pre>
</li>
</ul>
</li>
<li>
<p>Fix or mitigate the failure</p>
<ul>
<li>If a fix can be identified in a relatively short time, then submit a fix</li>
<li>If the failure is caused by a flaky or intermittent functional test and the risk to the
end-user experience is low, then the test can be &quot;skipped&quot;, using the pytest<code>xfail</code>
<a href="https://docs.pytest.org/en/latest/how-to/skipping.html">decorator</a> during continued investigation. Example:
<pre><code class="language-python">@pytest.mark.xfail(reason=&quot;Test Flake Detected (ref: DISCO-####)&quot;)
</code></pre>
</li>
</ul>
</li>
<li>
<p>Re-Deploy</p>
<ul>
<li>A fix or mitigation will most likely require a PR merge to the <code>main</code> branch that will
automatically trigger the deployment process. If this is not possible, a re-deployment can be
initiated manually by triggering the CI pipeline in <a href="https://app.circleci.com/pipelines/github/mozilla-services/merino-py">CircleCI</a>.</li>
</ul>
</li>
</ol>
<h3 id="what-to-do-if-production-breaks"><a class="header" href="#what-to-do-if-production-breaks">What to do if production breaks?</a></h3>
<p>If your latest release causes problems and needs to be rolled back:
don't panic and follow the instructions below:</p>
<ol>
<li>Depending on the severity of the problem, decide if this warrants
<a href="https://mozilla-hub.atlassian.net/wiki/spaces/MIR/overview">kicking off an incident</a>;</li>
<li>Identify the problematic commit (see instructions below), as it may not necessarily be the latest one!</li>
<li>Revert the problematic commit, merge that into GitHub,
then <a href="dev/release-process.html#releasing-to-production">deploy the revert commit to production</a>.
<ul>
<li>If a fix can be identified in a relatively short time,
then you may submit a fix, rather than reverting the problematic commit.</li>
</ul>
</li>
</ol>
<h4 id="locate-problematic-commit-via-git-bisect"><a class="header" href="#locate-problematic-commit-via-git-bisect">Locate problematic commit via &quot;git bisect&quot;</a></h4>
<p>If you are not sure about which commit broke production, you can use <code>git bisect</code> to locate the problematic commit as follows:</p>
<pre><code class="language-sh"># Start the bisect session.
$ git bisect start

# Flag a bad commit, usually you can set it to the latest commit as it's broken
# in production.
$ git bisect bad &lt;commit-hash-for-a-bad-commit&gt;

# Flag a good commit, this can be set to the last known good commit.
# You can use an old commit if you're still unsure, bisect will perform binary
# searches anyway.
$ git bisect good &lt;commit-hash-for-a-good-commit&gt;

# Git will check out a commit in the middle and then you can test it to see if
# the issue is still reproducible. If yes, flag it &quot;bad&quot;, otherwise flag it
# &quot;good&quot;. Git will use that as input to make the next move until it locates the
# problematic commit.
$ git bisect [bad|good]

# End the bisect session when you're done.
$ git bisect reset
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="profiling"><a class="header" href="#profiling">Profiling</a></h1>
<p>As Merino runs as a single-threaded application using the asyncio-based
framework, it would be useful for engineers to get a good understanding
about how Merino performs and where it spends time and memory doing what
tasks to serve the requests. Local profiling offers us a way to look into
those low-level details.</p>
<p>We use <a href="https://github.com/plasma-umass/scalene">Scalene</a> as the profiler to conduct the profiling for Merino.
It's very easy to use, offers extremely detailed (at the line level)
insights with much lower overhead compared to other profilers.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>To start the profiling, you can run the following to start Merino with
Scalene:</p>
<pre><code class="language-sh">$ make profile

# or you can run it directly

$ python -m scalene merino/main.py
</code></pre>
<p>Then you can send requests to Merino manually or through using other
load testing tools. Once that's done, you can terminate the Merino
application. It will automatically collect profiling outputs (CPU &amp; Memory)
and open it in your browser.</p>
<h2 id="understand-the-outputs"><a class="header" href="#understand-the-outputs">Understand the outputs</a></h2>
<p>Out of the box, Scalene provides a very intuitive web interface to display
the profiling outputs. It's organized at the file (module) level. For each
file, it shows the CPU time and average memory usage for both the line profile
and the function profile of that module. You can also click on specific columns
to sort the lines or functions accordingly.</p>
<p>For more details of how to read the outputs, you can reference Scalene's
<a href="https://github.com/plasma-umass/scalene#output">documents</a>.</p>
<p>Equipped with those insights, you can have a good understanding about the
application, identify hotspots, bottlenecks, or other findings that are
not easy to uncover by only reading the source code. And then, you can tweak
or fix those issues, test or profile it again to verify if the fix is working.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="operations"><a class="header" href="#operations">Operations</a></h1>
<p>This is where we put operational documentation for Merino.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-merino-operations"><a class="header" href="#configuring-merino-operations">Configuring Merino (Operations)</a></h1>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<p>Merino's settings are managed via Dynaconf and can be specified in two ways: by a
TOML file in the <code>merino/configs/</code> directory, or via environment variables. Environment
variables take precedence over the values set in the TOML files. TOML files set with the
same environment name that is currently activated also automatically override defaults.
Any config file that is pointed to will override the <code>merino/configs/default.toml</code> file.
Read below for more specific details.</p>
<h3 id="file-organization"><a class="header" href="#file-organization"><a href="operations/configs.html#file-organization">File organization</a></a></h3>
<p>These are the settings sources, with later sources overriding earlier ones.</p>
<ul>
<li>
<p>A <code>config.py</code> file establishes a Dynaconf instance and environment-specific values
are pulled in from the corresponding TOML files and environment variables. Other
configurations are established by files that are prefixed with <code>config_*.py</code>,
such as <code>config_sentry.py</code> or <code>config_logging.py</code>.</p>
</li>
<li>
<p>Per-environment configuration files are in the <code>configs</code> directory. The environment
is selected using the environment variable <code>MERINO_ENV</code>. The settings for
that environment are then loaded from <code>configs/${env}.toml</code>, if the file/env exists. The
default environment is &quot;development&quot;. A &quot;production&quot; environment is also
provided.</p>
</li>
<li>
<p>Local configuration files are not checked into the repository, but if created should be named
<code>configs/development.local.toml</code>, following the format of <code>&lt;environment&gt;.local.toml</code>.
This file is listed in the <code>.gitignore</code> file and is safe to use for local configuration.
One may add secrets here if desired, though it is advised to exercise great caution.</p>
</li>
</ul>
<h3 id="general"><a class="header" href="#general">General</a></h3>
<ul>
<li>
<p>All environments are prefixed with <code>MERINO_</code>. This is established in the
<code>config.py</code> file by setting the <code>envvar_prefix=&quot;MERINO&quot;</code> for the Dynaconf
instance. The first level following <code>MERINO_</code> is accessed with a single underscore <code>_</code>
and any subsequent levels require two underscores <code>__</code>. For example,
the logging format can be controlled from the environment variable
<code>MERINO_LOGGING__FORMAT</code>.</p>
</li>
<li>
<p>Production environment variables are set by SRE and stored in the
cloudops project in the <code>configmap.yml</code> file. Contact SRE if you require
information or access on this file, or request access to the cloudops infra
repo.</p>
</li>
<li>
<p>You can set these environment variables in your setup by modifying the <code>.toml</code> files.
Conversely, when using <code>make</code>, you can prefix <code>make run</code> with overrides to the
desired environment variables using CLI flags.</p>
<p>Example:
<code>MERINO_ENV=production MERINO_LOGGING__FORMAT=pretty make dev</code></p>
</li>
<li>
<p><code>env</code> (<code>MERINO_ENV</code>) - Only settable from environment variables. Controls
which environment configuration is loaded, as described above.</p>
</li>
<li>
<p><code>debug</code> (<code>MERINO_DEBUG</code>) - Boolean that enables additional features to debug
the application. This should not be set to true in public environments, as it
reveals all configuration, including any configured secrets.</p>
</li>
<li>
<p><code>format</code> (<code>MERINO_LOGGING__FORMAT</code>) - Controls the format of outputted logs in
either <code>pretty</code> or <code>mozlog</code> format. See <a href="operations/../../merino/config_logging.py">../config_logging.py</a>.</p>
</li>
</ul>
<h3 id="caveat-1"><a class="header" href="#caveat-1">Caveat</a></h3>
<p>Be extra careful whenever you need to reference those deeply nested settings
(e.g. <code>settings.foo.bar.baz</code>) in the hot paths of the code base, such as middlewares
or route handlers. Under the hood, Dynaconf will perform a dictionary lookup
for each level of the configuration hierarchy. While it's harmless to do those
lookups once or twice, it comes a surprisingly high overhead if accessing them
repeatedly in the hot paths. You can cache those settings somewhere to mitigate
this issue.</p>
<h3 id="deployment"><a class="header" href="#deployment">Deployment</a></h3>
<p>This group currently features a single setting:</p>
<ul>
<li><code>deployment.canary</code> (<code>MERINO_DEPLOYMENT__CANARY</code>) - a boolean that represents
whether the pod running this application is deployed as a canary. The value is
added as a constant tag <code>deployment.canary</code> with type <code>int</code> to emitted metrics.
Note that this setting is supposed to be controlled exclusively by deployment
tooling.</li>
</ul>
<h3 id="runtime-configurations"><a class="header" href="#runtime-configurations">Runtime Configurations</a></h3>
<ul>
<li><code>runtime.query_timeout_sec</code> (<code>MERINO_RUNTIME__QUERY_TIMEOUT_SEC</code>) - A floating
point (in seconds) indicating the maximum waiting period for queries issued within
the handler of the <code>suggest</code> endpoint. All the unfinished query tasks will be
cancelled once the timeout gets triggered. Note that this timeout can also be
configured by specific providers. The provider timeout takes precedence over this
value.</li>
</ul>
<h3 id="api-configurations"><a class="header" href="#api-configurations">API Configurations</a></h3>
<ul>
<li>
<p><code>default.web.api.v1.client_variant_max</code> (<code>MERINO_WEB__API__V1__CLIENT_VARIANT_MAX</code>)</p>
</li>
<li>
<p>A non-negative integer to contol the limit of optional client variants passed
to suggest endpoint as part of experiments or rollouts.  Additional validators
can/will be implemented to ensure a limitation on the number of variants passed
to the request. See: https://mozilla-services.github.io/merino/api.html#suggest.</p>
</li>
<li>
<p><code>default.web.api.v1.query_character_max</code> (<code>MERINO_WEB__API__V1__QUERY_CHARACTER_MAX</code>)</p>
</li>
<li>
<p>A non-negative integer value that is passed into the <code>max_length</code> parameter
of the FastAPI Query object constructor.  This limits the string character length
of a given query string, in this case the total string length count for the suggestion query.</p>
</li>
<li>
<p><code>default.web.api.v1.client_variant_character_max</code> (<code>MERINO_WEB__API__V1__CLIENT_VARIANT_CHARACTER_MAX</code>)</p>
</li>
<li>
<p>A non-negative integer value that is passed into the <code>max_length</code> parameter
of the FastAPI Query object constructor.  This limits the string character length
of a given query string, in this case the total string length count for client variants.</p>
</li>
</ul>
<h3 id="logging-1"><a class="header" href="#logging-1">Logging</a></h3>
<p>Settings to control the format and amount of logs generated.</p>
<ul>
<li>
<p><code>logging.format</code> (<code>MERINO_LOGGING__FORMAT</code>) - The format to emit logs in. One of</p>
<ul>
<li><code>pretty</code> (default in development) - Multiple lines per event, human-oriented
formatting and color.</li>
<li><code>mozlog</code> (default in production) - A single line per event, formatted as
JSON in <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a> format.</li>
</ul>
</li>
<li>
<p><code>logging.level</code> (<code>MERINO_LOGGING__LEVEL</code>) - Minimum level of logs that should
be reported. This should be a number of <em>entries</em> separated by commas (for
environment variables) or specified as list (TOML).</p>
<p>Each entry can be one of <code>CRITICAL</code>, <code>ERROR</code>, <code>WARN</code>, <code>INFO</code>,  or <code>DEBUG</code> (in
increasing verbosity).</p>
</li>
</ul>
<h3 id="metrics-3"><a class="header" href="#metrics-3">Metrics</a></h3>
<p>Settings for Statsd/Datadog style metrics reporting.</p>
<ul>
<li>
<p><code>metrics.host</code> (<code>MERINO_METRICS__HOST</code>) - The IP or hostname to send metrics
to over UDP. Defaults to localhost.</p>
</li>
<li>
<p><code>metrics.port</code> (<code>MERINO_METRICS__PORT</code>) - The port to send metrics to over
UDP. Defaults to 8092.</p>
</li>
<li>
<p><code>metrics.dev_logger</code> (<code>MERINO_METRICS__DEV_LOGGER</code>) - Whether or not to send
metrics over to the logger. Should only be used for non-production environments.</p>
</li>
</ul>
<h3 id="sentry"><a class="header" href="#sentry">Sentry</a></h3>
<p>Error reporting via Sentry.</p>
<ul>
<li><code>sentry.mode</code> (<code>MERINO_SENTRY__MODE</code>) - The type of Sentry integration to
enable. One of <code>release</code>, <code>debug</code>, or <code>disabled</code>. The <code>debug</code> setting
should only be used for local development.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>release</code>, then the following two settings are
required:</p>
<ul>
<li><code>sentry.dsn</code> (<code>MERINO_SENTRY__DSN</code>) - Configuration to connect to the Sentry project.</li>
<li><code>sentry.env</code> (<code>MERINO_SENTRY__ENV</code>) - The environment to report to Sentry.
Probably &quot;prod&quot;, &quot;stage&quot;, or &quot;dev&quot;.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>disabled</code>, no Sentry integration will be activated.
If it is set to <code>debug</code>, the DSN will be set to a testing value
recommended by Sentry, and extra output will be included in the logs.</p>
<h3 id="remote_settings"><a class="header" href="#remote_settings">Remote_settings</a></h3>
<p>Connection to Remote Settings. This is used by the Remote Settings suggestion
provider below.</p>
<ul>
<li>
<p><code>remote_settings.server</code> (<code>MERINO_REMOTE_SETTINGS__SERVER</code>) - The server to
sync from. Example: <code>https://firefox.settings.services.mozilla.com</code>.</p>
</li>
<li>
<p><code>remote_settings.bucket</code> (<code>MERINO_REMOTE_SETTINGS__BUCKET</code>) -
The bucket to use for Remote Settings providers if not specified in the
provider config. Example: &quot;main&quot;.</p>
</li>
<li>
<p><code>remote_settings.collection</code>
(<code>MERINO_REMOTE_SETTINGS__COLLECTION</code>) - The collection to use for
Remote Settings providers if not specified in the provider config. Example:
&quot;quicksuggest&quot;.</p>
</li>
</ul>
<h3 id="location"><a class="header" href="#location">Location</a></h3>
<p>Configuration for determining the location of users.</p>
<ul>
<li><code>location.maxmind_database</code> (<code>MERINO_LOCATION__MAXMIND_DATABASE</code>) - Path to a
MaxMind GeoIP database file.</li>
</ul>
<h3 id="redis"><a class="header" href="#redis"><a href="operations/configs.html#redis">Redis</a></a></h3>
<p>Global Redis settings. The weather provider optionally uses Redis to cache weather suggestions.</p>
<ul>
<li><code>redis.server</code> (<code>MERINO_REDIS__SERVER</code>) - The Redis server URL, in the form of
<code>redis://localhost:6379</code>.</li>
</ul>
<h3 id="accuweather-1"><a class="header" href="#accuweather-1">AccuWeather</a></h3>
<p>Configuration for using AccuWeather as a weather backend</p>
<ul>
<li><code>api_key</code> (<code>MERINO_ACCUWEATHER__API_KEY</code>) - The API key to AccuWeather's API
endpoint. In production, this should be set via environment variable as a secret.</li>
<li><code>url_base</code> (<code>MERINO_ACCUWEATHER__URL_BASE</code>) - The base URL of AccuWeather's
API endpoint.</li>
<li><code>url_param_api_key</code> (<code>MERINO_ACCUWEATHER__URL_PARAM_API_KEY</code>) - The parameter
of the API key for AccuWeather's API endpoint.</li>
<li><code>url_current_conditions_path</code> (<code>MERINO_ACCUWEATHER__URL_CURRENT_CONDITIONS_PATH</code>) -
The URL path for current conditions.</li>
<li><code>url_forecasts_path</code> (<code>MERINO_ACCUWEATHER__URL_FORECASTS_PATH</code>) - The URL path
for forecasts.</li>
<li><code>url_postalcodes_path</code> (<code>MERINO_ACCUWEATHER__URL_POSTALCODES_PATH</code>) - The URL path
for postal codes.</li>
<li><code>url_postalcodes_param_query</code> (<code>MERINO_ACCUWEATHER__URL_POSTALCODES_PARAM_QUERY</code>) -
The query parameter for postal codes.</li>
<li><code>url_param_partner_code</code> (<code>MERINO_ACCUWEATHER__URL_PARAM_PARTNER_CODE</code>) -
The query parameter for the <a href="https://apidev.accuweather.com/developers/partner-code">partner code</a>
to append to URLs in the current conditions and forecast responses.</li>
<li><code>partner_code</code> (<code>MERINO_ACCUWEATHER__PARTNER_CODE</code>) -
The partner code to append to URLs in the current conditions and forecast responses.</li>
</ul>
<h3 id="amo-api"><a class="header" href="#amo-api">AMO API</a></h3>
<ul>
<li><code>api_url</code> (<code>MERINO_AMO__DYNAMIC__API_URL</code>) - the base URL of the Addons API.</li>
</ul>
<h3 id="provider-configuration"><a class="header" href="#provider-configuration">Provider Configuration</a></h3>
<p>The configuration for suggestion providers.</p>
<h4 id="adm-provider"><a class="header" href="#adm-provider">Adm Provider</a></h4>
<p>These are production providers that generate suggestions.</p>
<ul>
<li>Remote Settings - Provides suggestions from a RS collection, such as the
suggestions provided by adM. See also the top level configuration for Remote
Settings above.
<ul>
<li><code>type</code> (<code>MERINO_PROVIDERS__ADM__TYPE</code>) - The type of this provider, should be <code>adm</code>.</li>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__ADM__ENABLED_BY_DEFAULT</code>) - Whether
this provider is enabled by default.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__ADM__BACKEND</code>) - The backend of the provider.
Either <code>remote-settings</code> or <code>test</code>.</li>
<li><code>resync_interval_sec</code> (<code>MERINO_PROVIDERS__ADM__RESYNC_INTERVAL_SEC</code>) - The time
between re-syncs of Remote Settings data, in seconds. Defaults to 3 hours.</li>
<li><code>cron_interval_sec</code>
(<code>MERINO_PROVIDERS__ADM__CRON_INTERVAL_SEC</code>) - The interval of the Remote
Settings cron job (in seconds). Following tasks are done in this cron job:
<ul>
<li>Resync with Remote Settings if needed. The resync interval is configured
separately by the provider. Note that this interval should be set smaller
than <code>resync_interval_sec</code> of the Remote Settings leaf provider.</li>
<li>Retry if the regular resync fails.</li>
</ul>
</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__ADM__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
</ul>
</li>
</ul>
<h4 id="accuweather-provider"><a class="header" href="#accuweather-provider">AccuWeather Provider</a></h4>
<ul>
<li>AccuWeather - Provides weather suggestions &amp; forecasts.
<ul>
<li><code>type</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__TYPE</code>) - The type of this provider, should be
<code>accuweather</code>.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__backend</code>) - The backend of the provider.
Either <code>accuweather</code> or <code>test</code>.</li>
<li><code>cache</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__CACHE</code>) - The store used to cache weather reports.
Either <code>redis</code> or <code>none</code>. If <code>redis</code>, the <a href="operations/configs.html#redis">global Redis settings</a> must be set.
Defaults to <code>none</code>.</li>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__ENABLED_BY_DEFAULT</code>) - Whether
this provider is enabled by default.</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
<li><code>query_timeout_sec</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__QUERY_TIMEOUT_SEC</code>) - A floating
point (in seconds) indicating the maximum waiting period when Merino queries
for weather forecasts. This will override the default query timeout.</li>
<li><code>cached_report_ttl_sec</code> (<code>MERINO_PROVIDERS__ACCUWEATHER__CACHED_REPORT_TTL_SEC</code>) - The
number of whole seconds (as an integer) indicating the time-to-live for a cached weather
report (current conditions and forecast) for a location. After the TTL expires, the provider
will fetch and cache the report again on the next suggestion request for that location.</li>
</ul>
</li>
</ul>
<h4 id="amo-provider"><a class="header" href="#amo-provider">AMO Provider</a></h4>
<ul>
<li><code>type</code> (<code>MERINO_PROVIDERS__AMO__TYPE</code>) - The type of this provider, should be <code>amo</code>.</li>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__AMO__ENABLED_BY_DEFAULT</code>) - Whether
this provider is enabled by default. Defaults to false.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__AMO__BACKEND</code>) - The backend of the provider.
Either <code>static</code> or <code>dynamic</code>.</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__AMO__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.3.</li>
<li><code>min_chars</code> (<code>MERINO_PROVIDERS__AMO__MIN_CHARS</code>) - The minimum number of characters
to process a querystring.</li>
<li><code>resync_interval_sec</code> (<code>MERINO_PROVIDERS__AMO__RESYNC_INTERVAL_SEC</code>) - The re-syncing frequency 
for the AMO data. Defaults to daily.</li>
<li><code>cron_interval_sec</code> (<code>MERINO_PROVIDERS__AMO__CRON_INTERVAL_SEC</code>) - The frequency that the cron checks
to see if re-syncing is required. This should be more frequent than the <code>resync_interval_sec</code> to retry 
on errors. Defaults to every minute.</li>
</ul>
<h4 id="top-picks-provider"><a class="header" href="#top-picks-provider">Top Picks Provider</a></h4>
<ul>
<li>Top Picks - Provides suggestions from a static domain list of the 1000 most visited websites.
<ul>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__TOP_PICKS__ENABLED_BY_DEFAULT</code>) - Boolean that defines
whether this provider is enabled by default.</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__TOP_PICKS__SCORE</code>) - The ranking score for this provider as a floating
point number with a default set to 0.25.</li>
<li><code>query_char_limit</code> (<code>MERINO_PROVIDERS__TOP_PICKS__QUERY_CHAR_LIMIT</code>) - The minimum character limit
for a Top Picks suggestion to be indexed and query to be processed. Represented as an integer with a
default set to 4.</li>
<li><code>firefox_char_limit</code> (<code>MERINO_PROVIDERS__TOP_PICKS__FIREFOX_CHAR_LIMIT</code>) - The minimum character
limit set for short suggestion indexing and for Firefox to process a query on Merino. Represented
as an integer. Default is set to 2.</li>
<li><code>top_picks_file_path</code> (<code>MERINO_PROVIDERS__TOP_PICKS__TOP_PICKS_FILE_PATH</code>) - File path to the json
file of domains, represented as a string. Either <code>dev/top_picks.json</code> in production
or <code>tests/data/top_picks.json</code> for testing.</li>
</ul>
</li>
</ul>
<h4 id="wiki-fruit-provider"><a class="header" href="#wiki-fruit-provider">Wiki Fruit Provider</a></h4>
<ul>
<li>Wiki Fruit - Provides suggestions from a test provider. Should not be used
in production.
<ul>
<li><code>type</code> (<code>MERINO_PROVIDERS__WIKI_FRUIT__TYPE</code>) - The type of this provider, should be
<code>wiki_fruit</code>.</li>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__WIKI_FRUIT__ENABLED_BY_DEFAULT</code>) - Whether
this provider is enabled by default.</li>
</ul>
</li>
</ul>
<h4 id="wikipedia-dynamic-match-provider"><a class="header" href="#wikipedia-dynamic-match-provider">Wikipedia Dynamic Match Provider</a></h4>
<ul>
<li>Wikipedia - Provider backed by the locally indexed Wikipedia through Elasticsearch.
<ul>
<li><code>type</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__TYPE</code>) - The type of this provider, should be
<code>wikipedia</code>.</li>
<li><code>enabled_by_default</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ENABLED_BY_DEFAULT</code>) - Whether
this provider is enabled by default.</li>
<li><code>backend</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__backend</code>) - The backend of the provider.
Either <code>elasticsearch</code> or <code>test</code>.</li>
<li><code>es_url</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ES_URL</code>) - The URL of the cluster that we
want to connect to.</li>
<li><code>es_api_key</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ES_API_KEY</code>) - The base64 key used to
authenticate on the Elasticsearch cluster specified by <code>es_cloud_id</code>.</li>
<li><code>es_index</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ES_INDEX</code>) - The index identifier
of Wikipedia in Elasticsearch.</li>
<li><code>es_max_suggestions</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ES_MAX_SUGGESTIONS</code>) - The
maximum suggestions for each search request to Elasticsearch.</li>
<li><code>es_request_timeout_ms</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__ES_REQUEST_TIMEOUT_MS</code>) - The
timeout in milliseconds for each search request to Elasticsearch.</li>
<li><code>score</code> (<code>MERINO_PROVIDERS__WIKIPEDIA__SCORE</code>) - The ranking score for this provider
as a floating point number. Defaults to 0.23.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="elasticsearch-operations"><a class="header" href="#elasticsearch-operations">Elasticsearch Operations</a></h1>
<p>We use Elasticsearch as a source of data for one of our providers.
This page documents some of the commands that we want to run on the cluster.</p>
<h2 id="elasticsearch-index-policy"><a class="header" href="#elasticsearch-index-policy">Elasticsearch Index Policy</a></h2>
<p>We want to ensure that the index expire after 30 days,
so we need to add a lifecycle policy for this deletion to happen.</p>
<p>The command to run in Kibana to add this policy:</p>
<pre><code>PUT _ilm/policy/enwiki_policy
{
  &quot;policy&quot;: {
    &quot;phases&quot;: {
      &quot;delete&quot;: {
        &quot;min_age&quot;: &quot;30d&quot;,
        &quot;actions&quot;: {
          &quot;delete&quot;: {}
        }
      }
    }
  }
}
</code></pre>
<h2 id="closed-index-recovery"><a class="header" href="#closed-index-recovery">Closed Index Recovery</a></h2>
<p>The indexing job currently <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-close.html">closes the index</a>
after it migrates the alias to point to the new index.
Closing the index removes the ability to query from the index
but also reduces the heap memory usage when the index is not actively being queried.</p>
<p>If there is a situation where we need to recover a closed index to be the main index,
we will need to do the following:</p>
<ol>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-open-close.html">Re-open the index</a></li>
<li>Point the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html">index alias</a> to the recovered index</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-jobs-operations"><a class="header" href="#merino-jobs-operations">Merino Jobs Operations</a></h1>
<h2 id="dynamic-wikipedia"><a class="header" href="#dynamic-wikipedia">Dynamic Wikipedia</a></h2>
<p>Merino currently builds the Elasticsearch indexing job that runs in Airflow.
Airflow takes the <code>latest</code> image built as the base image.
The reasons to keep the job code close to the application code are:</p>
<ol>
<li>Data models can be shared between the indexing job and application more easily. 
This means that data migrations will be simpler.</li>
<li>All the logic regarding Merino functionality can be found in one place.</li>
<li>Eliminates unintended differences in functionality due to dependency mismatch.</li>
</ol>
<h3 id="where-to-find-and-modify-the-jobs"><a class="header" href="#where-to-find-and-modify-the-jobs">Where to find and modify the jobs</a></h3>
<p>The job is configured in <a href="https://github.com/mozilla/telemetry-airflow"><code>telemetry-airflow</code></a>.</p>
<p>You can access the job in the 
<a href="https://workflow.telemetry.mozilla.org/dags/merino_jobs/grid?search=merino_jobs">Airflow Console</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-adrs"><a class="header" href="#merino-adrs">Merino ADRs</a></h1>
<p>This directory archives all the Architectural Decision Records (ADRs) for Merino.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="locust-vs-k6-merino-py-performance-test-framework"><a class="header" href="#locust-vs-k6-merino-py-performance-test-framework">Locust vs k6; Merino-py Performance Test Framework</a></h1>
<ul>
<li><strong>Status:</strong> Accepted</li>
<li><strong>Deciders:</strong> Nan Jiang, Raphael Pierzina &amp; Katrina Anderson</li>
<li><strong>Date:</strong> 2023-02-21</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Performance testing for the Rust version of Merino was conducted with the <a href="https://locust.io/">Locust</a> 
test framework and focused on the detection of HTTP request failures. During the 
migration of Merino from Rust to Python, performance testing was conducted with <a href="https://k6.io/">k6</a> 
and focused on the evaluation of request latency. Going forward a unified performance 
testing solution is preferred, should the test framework be Locust or k6?</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ol>
<li>The test framework supports the current load test design, a 10-minute test run with 
an average load of 1500RPS (see <a href="https://docs.google.com/document/d/1v7LDXENPZg37KXeNcznEZKNZ8rQlOhNbsHprFyMXHhs/edit?usp=sharing">Merino Load Test Plan</a>)</li>
<li>The test framework measures HTTP request failure and client-side latency metrics</li>
<li>The test framework is compatible with the Rapid Release Model for Firefox Services 
initiative, meaning:
<ul>
<li>It can execute through command line</li>
<li>It can signal failures given check or threshold criteria</li>
<li>It can be integrated into a CD pipeline</li>
<li>It can report metrics to <a href="https://earthangel-b40313e5.influxcloud.net/?orgId=1%5D">Grafana</a></li>
</ul>
</li>
<li>The members of the DISCO and ETE teams are able to contribute to and maintain load 
tests written with the test framework</li>
</ol>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li>A. Locust</li>
<li>B. k6</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option:</p>
<ul>
<li><strong>A. Locust</strong></li>
</ul>
<p>Both k6 and Locust are able to execute the current load test design, report required 
metrics and fulfill the Rapid Release Model for Firefox Services initiative; However, 
Locust's Python tech stack ultimately makes it the better fit for the Merino-py 
project. In-line with the team's single repository direction (see <a href="https://github.com/mozilla-services/merino-py/pull/186">PR</a>), using 
Locust will:</p>
<ul>
<li>Leverage existing testing, linting and formatting infrastructure</li>
<li>Promote dependency sharing and code re-use (models &amp; backends)</li>
</ul>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2>
<h3 id="a-locust"><a class="header" href="#a-locust">A. Locust</a></h3>
<p><a href="https://locust.io/">Locust</a> can be viewed as the status quo option, since it is the framework that is 
currently integrated into the Merino-py repository and is the basis for the CD load 
test integration currently underway (see <a href="https://mozilla-hub.atlassian.net/browse/DISCO-2113">DISCO-2113</a>). </p>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>Locust has a mature distributed load generation feature and can easily support a 1500 
RPS load</li>
<li>Locust has built-in RPS, HTTP request failure and time metrics with customizable URL 
break-down</li>
<li>Locust scripting is in Python</li>
<li>Locust supports direct command line usage</li>
<li>Locust is used for load testing in other Mozilla projects and is recommended by the
ETE team</li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>Locust is 100% community driven (no </li>
<li>commercial business), which means its 
contribution level can wane</li>
<li>Preliminary research indicates that reporting metrics from Locust to <a href="https://earthangel-b40313e5.influxcloud.net/?orgId=1%5D">Grafana</a> 
requires the creation of custom code, a plugin or a third party integration</li>
</ul>
<h3 id="b-k6"><a class="header" href="#b-k6">B. k6</a></h3>
<p>For the launch of Merino-py, performance bench-marking was conducted using a <a href="https://k6.io/">k6</a> 
load test script (see <a href="https://github.com/quiiver/merino-explorations">Merino Explorations</a>). This script was reused from the Merino 
rewrite exploration effort and has proven successful in assessing if Merino-py 
performance achieves the target p95 latency threshold, effecting preventative change 
(See <a href="https://github.com/mozilla-services/merino-py/pull/67#issuecomment-1266031853">PR</a>). k6's effectiveness and popularity amongst team members is an incentive 
to pause and evaluate if it is a more suitable framework going forward.</p>
<h4 id="pros-1"><a class="header" href="#pros-1">Pros</a></h4>
<ul>
<li>k6 is an open-source commercially backed framework with a high contribution rate</li>
<li>k6 is built by Grafana Labs, inferring easy integration with dashboards</li>
<li>k6 has built-in RPS, HTTP request failure and time metrics with customizable URL 
break-down</li>
<li>k6 supports direct command line usage</li>
<li>k6 is feature rich, including built-in functions to generate pass/fail results and 
create custom metrics</li>
</ul>
<h4 id="cons-1"><a class="header" href="#cons-1">Cons</a></h4>
<ul>
<li>The k6 development stack is in JavaScript/TypeScript. This means:
<ul>
<li>Modeling and backend layer code would need to be duplicated and maintained</li>
<li>Linting, formatting and dependency infrastructure would need to be added and 
maintained</li>
</ul>
</li>
<li>k6 has an immature distributed load generation feature, with <a href="https://k6.io/docs/testing-guides/running-large-tests/#distributed-execution">documented</a> 
limitations
<ul>
<li>k6 runs more efficiently than other frameworks, so it may be possible to achieve
1500 RPS without distribution </li>
</ul>
</li>
</ul>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://mozilla-hub.atlassian.net/browse/DISCO-2045">DISCO-2045 - Investigate K6 load testing in Merino-py CD</a></li>
</ul>
<!-- References -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-suggest-api-response-structure"><a class="header" href="#merino-suggest-api-response-structure">Merino Suggest API Response Structure</a></h1>
<ul>
<li>Status: accepted</li>
<li>Deciders: Michelle Tran, Lina Butler, Nan Jiang, Wil Stuckey,
Drew Willcoxon, Taddes Korris, Tiffany Tran</li>
<li>Date: 2023-04-20</li>
</ul>
<h2 id="context-and-problem-statement-1"><a class="header" href="#context-and-problem-statement-1">Context and Problem Statement</a></h2>
<p>As Merino continues to add more suggestions, 
suggestion providers are going to have to return all sorts of
data to the clients that are bespoke to the particular suggestion.
For instance, weather suggestion returns a <code>temperature</code>.
Currently, we do not have a strategy to manage these bespoke pieces of data
which results in them returned at the top level of the suggestion object.
However, this will pose a problem when</p>
<ol>
<li>names of fields are shared between providers, but have different semantics 
(i.e. <code>rating</code> may be a decimal value between 0-1 in one type, 
and a &quot;star&quot; integer rating between 1-5 in another)</li>
<li>the API is unclear about what will <em>necessarily</em> exist, and what is <em>optional</em>,
which leads to client confusion about the contract</li>
</ol>
<p>So, this ADR is to make a decision on how we want to handle provider specific fields
going forward.</p>
<h2 id="decision-drivers-1"><a class="header" href="#decision-drivers-1">Decision Drivers</a></h2>
<p>In rough order of importance:</p>
<ol>
<li>Explicitness of Ownership - i.e. the <code>rating</code> field belongs to the <code>addons</code> provider</li>
<li>Compatibility with [JSON] Schema Validation</li>
<li>Adherence to the Fx Suggest Design Framework</li>
<li>Backwards Compatibility with Current Schema</li>
</ol>
<h2 id="considered-options-1"><a class="header" href="#considered-options-1">Considered Options</a></h2>
<ul>
<li>A. Continue to add to Top Level with Optional Fields</li>
<li>B. Custom Details Field for Bespoke Provider Fields</li>
<li>B.5 Custom Details Field without the Provider Nesting</li>
<li>C. Custom Details Field for a &quot;Type&quot;</li>
<li>D. Component Driven <code>custom_details</code></li>
</ul>
<h2 id="decision-outcome-1"><a class="header" href="#decision-outcome-1">Decision Outcome</a></h2>
<p>Chosen option: B</p>
<p>We will also <em>not</em> increase the version number of the API for this ADR.
So, going forward, we will encode option B into the response design
without changing the existing providers.
This means that the following providers will <em>not</em> have
their bespoke fields removed from top level:</p>
<ul>
<li>AdM Provider</li>
<li>Top Picks Provider</li>
<li>Weather Provider</li>
<li>Wikipedia Provider</li>
<li>WikiFruit Provider</li>
</ul>
<p>However, this does not preclude these providers from duplicating the fields
to <code>custom_details</code> in the v1 API.</p>
<h3 id="positive-consequences-of-option-b"><a class="header" href="#positive-consequences-of-option-b">Positive Consequences of Option B</a></h3>
<ul>
<li>Clear isolation of fields that belong together (i.e. grouped by provider).</li>
<li>Clear ownership of fields through the structure.</li>
<li>Simpler validation logic than other options due to less need for conditionals.</li>
</ul>
<h3 id="negative-consequences-of-option-b"><a class="header" href="#negative-consequences-of-option-b">Negative Consequences of Option B</a></h3>
<ul>
<li>Potentially some redundancy caused by extra nesting.</li>
<li>Might not be as flexible with a provider that returns different fields based on
what type of suggestion it is.</li>
</ul>
<h3 id="positive-consequences-of-not-increasing-api-version"><a class="header" href="#positive-consequences-of-not-increasing-api-version">Positive Consequences of not Increasing API Version</a></h3>
<ul>
<li>We do not have to worry about migrating Firefox (and other clients) into the new format.
The migration is going to be quite a lot of extra work that adds little benefits
(other than consistency of design, it doesn't add more features nor improve
any known time sinks with development).</li>
<li>Do not have to support 2 versions of the API.</li>
</ul>
<h3 id="negative-consequences-of-not-increasing-api-version"><a class="header" href="#negative-consequences-of-not-increasing-api-version">Negative Consequences of not Increasing API Version</a></h3>
<ul>
<li>Some inconsistencies with how providers add fields to the response.
We will likely want to resolve this as we migrate to v2,
but it's a known issue at the moment.</li>
<li>Might be missing an opportune time to migrate, as features are currently not out yet
which means the flexibility for change is higher.</li>
</ul>
<h2 id="pros-and-cons-of-the-options-1"><a class="header" href="#pros-and-cons-of-the-options-1">Pros and Cons of the Options</a></h2>
<h3 id="a-continue-to-add-to-top-level-with-optional-fields"><a class="header" href="#a-continue-to-add-to-top-level-with-optional-fields">A. Continue to add to Top Level with Optional Fields</a></h3>
<p>This is the status quo option.
We will continue to append bespoke values to the top level suggestion,
and ensure that they're optional.
We can continue to use the <code>provider</code> to signal what fields exists
and how they should be parsed.
For example, we can specify 2 different types of <code>rating</code>,
and hence 2 validation strategy for it,
based off of which provider is specified.</p>
<p>Example:</p>
<pre><code class="language-json">{
  &quot;suggestions&quot;: [
    {
      ...
      &quot;provider&quot;: &quot;addons&quot;,
      &quot;rating&quot;: &quot;4.123&quot;,
      ...
    },
    {
      ...
      &quot;provider&quot;: &quot;movies&quot;,
      &quot;rating&quot;: 0.123,
      ...
    },
    ...
  ],
  ...
}
</code></pre>
<p>The partial JSON Schema validation will look something like:</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;object&quot;,
  &quot;properties&quot;: {
    &quot;provider&quot;: {
      &quot;type&quot;: &quot;string&quot;
    }
  },
  &quot;required&quot;: [&quot;provider&quot;],
  &quot;allOf&quot;: [
    {
      &quot;if&quot;: {
        &quot;properties&quot;: {
          &quot;provider&quot;: {
            &quot;const&quot;: &quot;addons&quot;
          }
        }
      },
      &quot;then&quot;: {
        &quot;properties&quot;: {
          &quot;rating&quot;: {
            &quot;type&quot;: &quot;string&quot;
          }
        },
        &quot;required&quot;: [
          &quot;rating&quot;
        ]
      }
    },
    {
      &quot;if&quot;: {
        &quot;properties&quot;: {
          &quot;provider&quot;: {
            &quot;const&quot;: &quot;movies&quot;
          }
        }
      },
      &quot;then&quot;: {
        &quot;properties&quot;: {
          &quot;rating&quot;: {
            &quot;type&quot;: &quot;number&quot;
          }
        },
        &quot;required&quot;: [
          &quot;rating&quot;
        ]
      }
    }
  ]
}
</code></pre>
<h4 id="pros-2"><a class="header" href="#pros-2">Pros</a></h4>
<ul>
<li>Can specify specific validation per provider.</li>
<li>Merino is still kind of immature, so it still might be too early to think about design.</li>
<li>Less nesting in the models (resulting in less complexity).</li>
<li>Currently, backwards compatible as we don't have to do anything 
to existing providers, as this follows the existing patterns.</li>
</ul>
<h4 id="cons-2"><a class="header" href="#cons-2">Cons</a></h4>
<ul>
<li>Lack of isolation for bespoke fields; <code>ratings</code> is coupled with 2 specific providers,
and by just looking at the response, it's not clear that they are related.</li>
<li>Not clear what is shared between <em>all</em> suggestions, vs. what is bespoke to specific provider.</li>
<li>It is not obvious that the <code>provider</code> field should signal how you should perform validation.
In other words, there is a contextual dependency on the JSON structure of suggestion based on <code>provider</code>.</li>
</ul>
<h3 id="b-custom-details-field-for-bespoke-provider-fields"><a class="header" href="#b-custom-details-field-for-bespoke-provider-fields">B. Custom Details Field for Bespoke Provider Fields</a></h3>
<p>We introduce a <code>custom_details</code> field that uses a provider name as key
to an object with the bespoke values to that provider.</p>
<p>Example:</p>
<pre><code class="language-json">{
  &quot;suggestions&quot;: [
    {
      ...
      &quot;provider&quot;: &quot;addons&quot;,
      &quot;custom_details&quot;: {
        &quot;addons&quot;: {
          &quot;rating&quot;: &quot;4.7459&quot;
        }
      }
    },
    ...
  ],
  ...
}
</code></pre>
<p>The specific fields in <code>custom_details</code> will all be optional (i.e. <code>addons</code> will be an optional key)
but the <em>shape</em> of what goes in <code>addons</code> can be more strict (i.e. <code>addons</code> require a <code>rating</code> field).</p>
<p>A partial schema specification for the above might look like<sup class="footnote-reference"><a href="#jsonschema">1</a></sup>:</p>
<pre><code class="language-json">{
  &quot;$schema&quot;: &quot;https://json-schema.org/draft/2020-12/schema&quot;,
  &quot;title&quot;: &quot;Suggest API Response v1&quot;,
  &quot;description&quot;: &quot;Response for /api/v1/suggest&quot;,
  &quot;type&quot;: &quot;object&quot;,
  &quot;properties&quot;: {
    &quot;provider&quot;: {
      &quot;description&quot;: &quot;id for the provider type&quot;,
      &quot;type&quot;: &quot;string&quot;
    },
    &quot;custom_details&quot;: {
      &quot;type&quot;: &quot;object&quot;,
      &quot;properties&quot;: {
        &quot;addons&quot;: {
          &quot;type&quot;: &quot;object&quot;,
          &quot;description&quot;: &quot;Custom Addon Fields&quot;,
          &quot;properties&quot;: {
            &quot;rating&quot;: {
              &quot;type&quot;: &quot;number&quot;
            }
          },
          &quot;required&quot;: [&quot;rating&quot;]
        }
      }
    }
  },
  &quot;required&quot;: [&quot;provider&quot;]
}
</code></pre>
<div class="footnote-definition" id="jsonschema"><sup class="footnote-definition-label">1</sup>
<p>Can play with JSON schema in https://www.jsonschemavalidator.net/</p>
</div>
<h4 id="pros-3"><a class="header" href="#pros-3">Pros</a></h4>
<ul>
<li>Can specify specific validation per provider.</li>
<li>Clear ownership of <code>rating</code> to <code>addons</code> via structure.</li>
<li>Fields outside of <code>custom_details</code> can be fields that are more universal across suggestions.
These fields can potentially be correlated directly to the Fx Suggest Design Framework
(i.e. <code>context_label</code>, <code>url</code>, <code>title</code>, <code>description</code>, etc.).</li>
<li>Having a clear distinction for Fx Suggest Design Framework fields vs. bespoke fields makes this more
backwards compatible, as the fields in the Design Framework can render the <em>default</em> suggestion case
for clients who haven't upgraded their clients.</li>
</ul>
<h4 id="cons-3"><a class="header" href="#cons-3">Cons</a></h4>
<ul>
<li>We'll likely need to migrate existing providers at some point. But in the meantime,
some fields will not follow convention to maintain backwards compatibility.</li>
<li>Extra nesting inside of <code>custom_details</code>.</li>
</ul>
<h3 id="b5-custom-details-field-without-the-provider-nesting"><a class="header" href="#b5-custom-details-field-without-the-provider-nesting">B.5 Custom Details Field without the Provider Nesting</a></h3>
<p>This is exactly like B, except that we remove the extra nesting.</p>
<p>So, in the example above, we can remove the extra <code>addons</code> object to get:</p>
<pre><code class="language-json">{
  &quot;suggestions&quot;: [
    {
      ...
      &quot;provider&quot;: &quot;addons&quot;,
      &quot;custom_details&quot;: {
        &quot;rating&quot;: &quot;4.7459&quot;
      }
    },
    ...
  ],
  ...
}
</code></pre>
<p>The validation of the contents of <code>custom_details</code> will look more like A.</p>
<pre><code class="language-json">{
  &quot;$schema&quot;: &quot;https://json-schema.org/draft/2020-12/schema&quot;,
  &quot;title&quot;: &quot;Suggest API Response v1&quot;,
  &quot;description&quot;: &quot;Response for /api/v1/suggest&quot;,
  &quot;type&quot;: &quot;object&quot;,
  &quot;properties&quot;: {
    &quot;provider&quot;: {
      &quot;description&quot;: &quot;id for the provider type&quot;,
      &quot;type&quot;: &quot;string&quot;
    }
  },
  &quot;required&quot;: [
    &quot;provider&quot;
  ],
  &quot;if&quot;: {
    &quot;properties&quot;: {
      &quot;provider&quot;: {
        &quot;const&quot;: &quot;addons&quot;
      }
    }
  },
  &quot;then&quot;: {
    &quot;properties&quot;: {
      &quot;custom_details&quot;: {
        &quot;description&quot;: &quot;Custom Details Specific for Addons&quot;,
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
          &quot;rating&quot;: {
            &quot;type&quot;: &quot;string&quot;
          }
        },
        &quot;required&quot;: [
          &quot;rating&quot;
        ]
      }
    },
    &quot;required&quot;: [&quot;custom_details&quot;]
  }
}
</code></pre>
<h4 id="pros-4"><a class="header" href="#pros-4">Pros</a></h4>
<ul>
<li>Can specify specific validation per provider.</li>
<li>Fields outside of <code>custom_details</code> can be fields that are more universal across suggestions.
These fields can potentially be correlated directly to the Fx Suggest Design Framework
(i.e. <code>context_label</code>, <code>url</code>, <code>title</code>, <code>description</code>, etc.).</li>
<li>Having a clear distinction for Fx Suggest Design Framework fields vs. bespoke fields makes this more
backwards compatible, as the fields in the Design Framework can render the <em>default</em> suggestion case
for clients who haven't upgraded their clients.</li>
<li>Less nesting in the response than B</li>
</ul>
<h4 id="cons-4"><a class="header" href="#cons-4">Cons</a></h4>
<ul>
<li>We'll likely need to migrate existing providers at some point. But in the meantime,
some fields will not follow convention to maintain backwards compatibility.</li>
<li>The relationship between <code>provider</code> and <code>custom_details</code> is more implicit, than explicit.</li>
<li>This has a lot of the same <em>cons</em> as Option A because validation is done similarly.</li>
</ul>
<h3 id="c-custom-details-field-for-a-type"><a class="header" href="#c-custom-details-field-for-a-type">C. Custom Details Field for a &quot;Type&quot;</a></h3>
<p>This is similar to option B, except that we want to introduce a new <code>type</code> field
to differentiate it from the provider.
The <code>custom_details</code> will be keyed by this type, rather than the <code>provider</code> name.
These <code>types</code> are kind of analogous to a <em>rendering component</em>,
as they will likely be used to specify a specific rendering path in the client.</p>
<p>Example:</p>
<pre><code class="language-json">{
  &quot;suggestions&quot;: [
    {
      ...
      &quot;provider&quot;: &quot;addons&quot;,
      &quot;type&quot;: &quot;addons_type&quot;,
      &quot;custom_details&quot;: {
        &quot;addons_type&quot;: {
          &quot;rating&quot;: &quot;4.7459&quot;
        }
      }
    },
    ...
  ],
  ...
}
</code></pre>
<h4 id="pros-5"><a class="header" href="#pros-5">Pros</a></h4>
<ul>
<li>All the pros for B applies here</li>
<li>Can decouple the <code>custom_details</code> from <code>provider</code>. This will be helpful for potentially 
sharing the <code>type</code> with other suggestions produced by different providers. For instance,
we may want this to specify different <em>rendering</em> paths in the client 
(i.e. a &quot;top picks&quot; type to be shared between <code>addons</code> and <code>top_picks</code> providers,
as there's many shared fields because they're rendered similarly). </li>
</ul>
<h4 id="cons-5"><a class="header" href="#cons-5">Cons</a></h4>
<ul>
<li>All the cons for B applies here</li>
<li>Potentially over-engineering for <code>type</code>, as it's use is currently hypothetical.</li>
</ul>
<h3 id="d-component-driven-custom_details"><a class="header" href="#d-component-driven-custom_details">D. Component Driven <code>custom_details</code></a></h3>
<p>This solution will model distinct UI components in the <code>custom_details</code> section.
For example, if the <code>addons</code> provider have specific UI components to render a <code>ratings</code> component and
a <code>highlight_context_label</code>, then we can specify these directly in the <code>custom_details</code> section.
This will assume that the client side have these specific rendering types.</p>
<p>Example:</p>
<pre><code class="language-json">{
  &quot;suggestions&quot;: [
    {
      ...
      &quot;provider&quot;: &quot;addons&quot;,
      &quot;custom_details&quot;: {
        &quot;ratings&quot;: {
          &quot;value&quot;: &quot;4.7459&quot;,
          &quot;unit&quot;: &quot;stars&quot;
        },
        &quot;highlight_context_label&quot;: {
          &quot;text&quot;: &quot;Special Limited Time Offer!&quot;
        }
      }
    },
    ...
  ],
  ...
}
</code></pre>
<h4 id="pros-6"><a class="header" href="#pros-6">Pros</a></h4>
<ul>
<li>Can share custom components with schema validation.</li>
<li>Backwards compatible with clients who don't have the necessary components to render. 
It will just use the default renderer via the Fx Suggest Design Framework</li>
</ul>
<h4 id="cons-6"><a class="header" href="#cons-6">Cons</a></h4>
<ul>
<li>We currently don't have a sophisticated Component Design Framework, so this is probably overengineering.</li>
<li>This tightly couples the API to the design framework of Desktop Firefox, which makes the fields potentially
less relevant to other clients.</li>
</ul>
<h2 id="links-1"><a class="header" href="#links-1">Links</a></h2>
<ul>
<li><a href="https://json-schema.org/">JSON Schema Specification</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
