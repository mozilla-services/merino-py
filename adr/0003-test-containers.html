<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Adopt Testcontainers for Integration Testing - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item "><a href="../social-contract.html"><strong aria-hidden="true">4.</strong> Social contract</a></li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">5.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">5.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">5.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">5.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">5.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">5.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">5.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">5.7.</strong> Profiling</a></li><li class="chapter-item "><a href="../testing/index.html"><strong aria-hidden="true">5.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/unit-tests.html"><strong aria-hidden="true">5.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../testing/integration-tests.html"><strong aria-hidden="true">5.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="../testing/load-tests.html"><strong aria-hidden="true">5.8.3.</strong> Load Tests</a></li></ol></li></ol></li><li class="chapter-item "><a href="../operations/index.html"><strong aria-hidden="true">6.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">6.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">6.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">6.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">6.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">6.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">6.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../operations/jobs.html"><strong aria-hidden="true">6.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">6.7.1.</strong> Navigational Suggestions</a></li><li class="chapter-item "><a href="../operations/jobs/dynamic-wiki-indexer.html"><strong aria-hidden="true">6.7.2.</strong> Dynamic Wikipedia Indexer</a></li><li class="chapter-item "><a href="../operations/jobs/csv-remote-settings.html"><strong aria-hidden="true">6.7.3.</strong> Remote Settings CSV Uploader</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item expanded "><a href="../adr/index.html"><strong aria-hidden="true">7.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">7.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">7.2.</strong> General API Response</a></li><li class="chapter-item expanded "><a href="../adr/0003-test-containers.html" class="active"><strong aria-hidden="true">7.3.</strong> Adopt Testcontainers for Integration Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="streamline-test-coverage-of-third-party-integrations"><a class="header" href="#streamline-test-coverage-of-third-party-integrations">Streamline Test Coverage of Third-Party Integrations</a></h1>
<ul>
<li><strong>Status:</strong> Accepted</li>
<li><strong>Deciders:</strong> Nan Jiang &amp; Katrina Anderson</li>
<li><strong>Date:</strong> 2024-01-24</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>In 2024, it is anticipated that Merino will expand to be consumed by a greater set of Firefox
surfaces and to include more content providers. This will challenge the current feature test
strategy, which has shown weakness in detecting incompatibilities with third-party integrations.
Examples:</p>
<ol>
<li><a href="https://docs.google.com/document/d/1hQKTro1ulxrurPBybUVHguVGgt7xCPED-ZJAOtlDqsU/edit#">Weather Incident with Redis Integration</a></li>
<li><a href="https://github.com/mozilla-services/merino-py/pull/467">Navigation Suggestions Error with GCP Integration</a></li>
</ol>
<p>The current test approach uses a combination of unit, integration, and contract feature tests,
where third-party integrations such as cloud services, data storage services, and external API
integrations are <a href="https://martinfowler.com/articles/mocksArentStubs.html#TheDifferenceBetweenMocksAndStubs">test doubled</a> in the unit and integration tests and emulated with Docker
containers in contract tests. While test doubles might be easier to work with, they lack the
accuracy of working with real dependencies in terms of matching the production environment and
covering all the integration surfaces and concerns in tests.</p>
<p>Despite the potential to test with third-party integrations in contract tests, developers have
refrained due to their lack of familiarity with Docker and CI tooling, as well as their belief
in a poor return on investment for the time and effort required to create and maintain contract
tests for experimental features.</p>
<p>Given the Merino service context, which has a rapid development pace and a high risk tolerance,
is there a way to streamline the test strategy while ensuring robustness against third-party
integrations?</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<p><strong>1. Usability &amp; Skill Transferability</strong></p>
<p>Ease-of-use is the key criterion when we assess a tool for testing. The test strategy should
prefer tools that require less effort and time to acquire proficiency. It should be easy to
learn and work with. Ideally, any skills or knowledge acquired should be applicable across
current contexts or for future scenarios.</p>
<p><strong>2. Maturity &amp; Expandability</strong></p>
<p>The test strategy and tooling should be able to handle known third-party Merino dependencies
in tests with a reasonable belief that it will cover future growth. Known third-party
dependencies include: REST APIs, Remote Settings, GCP Cloud Storage, Redis, and Elasticsearch.
Future dependencies include: relational DBMS such as PostgreSQL and other GCP cloud services
such as Pub/Sub.</p>
<p><strong>3. Cost Efficiency</strong></p>
<p>The worker hours and tooling expenditures associated with the implementation and execution of
the test strategy should ensure the profitability of Merino.</p>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li>A. Yes. Expand the Scope of Integration Tests Using Dependency Docker Containers (Testcontainers)</li>
<li>B. Yes. Reduce the Dependency Overhead in Tests Using Development and Stage Environments</li>
<li>C. No. Fulfill the Current Test Strategy with Contract Test Coverage (Status quo)</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p><strong>Chosen option: A</strong></p>
<p>Overall, we believe that increasing the scope of integration tests to verify third-party
integrations with <a href="https://testcontainers.com/">Testcontainers</a> will be the most effective and sustainable way forward.
Testcontainers' &quot;Test dependencies as code&quot; approach best fulfills the Usability &amp; Skill
Transferability and Maturity &amp; Expandability decision drivers and long-term would prove to be
the most Cost Efficient option.</p>
<p>We expect there to be initial labour costs to integrating Testcontainers, but anticipate that
moving more verification responsibility to the integration test layer will be more accessible
for developers and will reduce bugs found between Merino and third-party integrations.</p>
<p>Testcontainers is a widely adopted container-based test platform that supports a wide range of
programming languages including Python and Rust, which are popular at Mozilla and there is
indication that Testcontainers would have applicability across services in PXI. Given the success
of Rapid Release and other experiments in Merino, it's a good candidate to use in Merino first as
a pilot test. Should we find any issues or unsoundness about it, we can always revert the decision
in the future.</p>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2>
<h3 id="a-yes-expand-the-scope-of-integration-tests-using-dependency-docker-containers-testcontainers"><a class="header" href="#a-yes-expand-the-scope-of-integration-tests-using-dependency-docker-containers-testcontainers">A. Yes. Expand the Scope of Integration Tests Using Dependency Docker Containers (Testcontainers)</a></h3>
<p>A preference for the unit and integration feature test layers in Merino has emerged over time.
These test layers are white-box, which means developers can more easily set up program environments
to test either happy paths or edge cases. In addition, tooling for debugging and measuring code
coverage is readily available in these layers.<a href="https://testcontainers.com/">Testcontainers</a> can be used to increase the scope
of integration tests, covering the backend layer logic and network communication with third-party
integrations, the current test strategy's point of weakness.</p>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>Testcontainers works with any Docker image and has numerous pre-built modules. Almost all the
existing dependencies (or their close emulators) of Merino can be run as Docker containers. As a
result, we can use real dependencies in Merino's tests as opposed to test doubles</li>
<li>Testcontainers allows developers to programmatically manage the lifecycle of containers in the
test code. This simplifies its usage for developers, who will not need to run any Docker commands
separately for testing</li>
<li>Testcontainers, which has <a href="https://www.docker.com/blog/docker-whale-comes-atomicjar-maker-of-testcontainers/">recently been acquired by Docker</a>, is fairly mature and supports
many popular programming languages. There are also a large number of community maintained clients
available for popular services such as PostgreSQL, Redis, Elasticsearch, etc.</li>
<li>Testcontainers is lightweight and sandboxed, meaning service resources aren't shared and are
cleaned up automatically, promoting test isolation and parallelization</li>
<li>Docker-compose is also supported by Testcontainers, facilitating use of multiple dependency
containers for more complex test cases</li>
<li>Testcontainers supports Python, Rust and Javascript languages and works well with their respective
test frameworks <a href="https://docs.pytest.org/en/7.4.x/">PyTest</a>, <a href="https://doc.rust-lang.org/cargo/guide/tests.html">Cargo-Test</a> and <a href="https://jestjs.io/">Jest</a></li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>A Docker runtime is required to run all the tests that depend on Testcontainers. Docker is
already setup in CI, but developers may need to install a Docker runtime locally</li>
<li>Integration tests cannot be run completely offline as Docker images need to be downloaded first</li>
<li>Developers will need to understand more about how to configure and work with dependency
containers. The development community has many popular services out of the box, but developers
would still need to know and do more than what's required when using test doubles</li>
<li>It could be challenging to provision test fixtures for the underlying containers. Feeding the
fixture data into the containers could be complex</li>
<li>Developers need to ensure version consistency across the development, testing, and production
environments in the integration test layer</li>
<li>For third-party API integrations, if the provider doesn't provide a Docker image for their API,
Testcontainers alone will not help us much. It's possible to use fake API container generators,
such as <a href="https://wiremock.org/">Wiremock</a>, but it comes with its own complexities</li>
<li>Implementation of Testcontainers would require refactoring of integration tests, including the
removal of mocks and fixtures</li>
</ul>
<h3 id="b-yes-reduce-the-dependency-overhead-in-tests-using-development-and-stage-environments"><a class="header" href="#b-yes-reduce-the-dependency-overhead-in-tests-using-development-and-stage-environments">B. Yes. Reduce the Dependency Overhead in Tests Using Development and Stage Environments</a></h3>
<p>Using Merino's staging environment and third-party development resources in tests has been
considered. This would effectively cover the current test strategy's weakness with third-party
integrations without the cost and complexity involved with setting up test doubles or dependency
containers. However, this approach has a key challenge in how to share the stage environment
across all the test consumers (devs &amp; CI) as most of the services do not support multi-tenant
usage and would require a significant amount of effort to support resource isolation.</p>
<h4 id="pros-1"><a class="header" href="#pros-1">Pros</a></h4>
<ul>
<li>Best matches the production environment</li>
<li>Doesn't need extra effort to create test doubles or dependencies for testing</li>
</ul>
<h4 id="cons-1"><a class="header" href="#cons-1">Cons</a></h4>
<ul>
<li>Tests cannot be run offline since they would require a network connection to interact with
development and stage environments</li>
<li>This option breaks the <a href="https://github.com/mozilla-services/merino-py/blob/disco-2704/CONTRIBUTING.md#testing-guidelines--best-practices">Testing Guidelines &amp; Best Practices</a> for Merino, which require tests
to be isolated and repeatable. A dependency on shared network resources will almost certainly
lead to test flake, reducing the confidence in the test suite</li>
<li>Test execution speeds would be negatively impacted, due to the lack of sandboxing, which enables
parallel test runs</li>
</ul>
<h3 id="c-no-fulfill-the-current-test-strategy-with-contract-test-coverage-status-quo"><a class="header" href="#c-no-fulfill-the-current-test-strategy-with-contract-test-coverage-status-quo">C. No. Fulfill the Current Test Strategy with Contract Test Coverage (Status quo)</a></h3>
<p>The current test strategy, which relies on the contract tests to verify the interface between
Merino and third-party dependencies, has not been fully implemented as designed. The missing
coverage explains the current test strategy's weakness.
Examples:</p>
<ol>
<li><a href="https://mozilla-hub.atlassian.net/browse/DISCO-2032">DISCO-2032: Weather Contract Tests</a></li>
<li><a href="https://mozilla-hub.atlassian.net/browse/DISCO-2324">DISCO-2324: Add a merino-py contract test that interacts with a real Redis instance</a></li>
<li><a href="https://mozilla-hub.atlassian.net/browse/DISCO-2055">DISCO-2055: Dynamic Wikipedia Contract Tests</a></li>
</ol>
<h4 id="pros-2"><a class="header" href="#pros-2">Pros</a></h4>
<ul>
<li>The most cost-effective solution, at least in the short term, since the test framework and Docker
dependencies are set up and integrated into CI</li>
<li>The unit and integration feature test layers remain simple by using test doubles</li>
</ul>
<h4 id="cons-2"><a class="header" href="#cons-2">Cons</a></h4>
<ul>
<li>The black-box nature of contract tests makes it harder to set up the environmental conditions
required to enable testing edge cases</li>
<li>Adding dependency containers is complex, often requiring developers to have advanced knowledge
of Docker and CI vendors (e.g. CircleCI)</li>
<li>There is a high level of redundancy between unit, integration, and contract tests that negatively
impacts development pace</li>
</ul>
<h2 id="open-questions"><a class="header" href="#open-questions">Open Questions</a></h2>
<ul>
<li>How to test 3rd party API integrations? We have two options for consideration: Either use
generic API mocking frameworks or keep status quo and rely on other means (e.g. observerbility)
to capture API breakages. They both have pros and cons and warrant a separate ADR to discuss
in detail</li>
</ul>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://mozilla-hub.atlassian.net/browse/DISCO-2055">DISCO-2704 - Use Testcontainer for Merino</a></li>
</ul>
<!-- References -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../adr/0002-merino-general-response.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../adr/0002-merino-general-response.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
