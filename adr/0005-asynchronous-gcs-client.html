<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Adopt Asynchronous Python Google Cloud Storage Client - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../manifest.html"><strong aria-hidden="true">2.</strong> Working with the Manifest file</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">3.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item "><a href="../social-contract.html"><strong aria-hidden="true">5.</strong> Social contract</a></li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">6.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">6.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">6.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">6.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">6.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">6.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">6.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">6.7.</strong> Profiling</a></li><li class="chapter-item "><a href="../testing/index.html"><strong aria-hidden="true">6.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/unit-tests.html"><strong aria-hidden="true">6.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../testing/integration-tests.html"><strong aria-hidden="true">6.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="../testing/load-tests.html"><strong aria-hidden="true">6.8.3.</strong> Load Tests</a></li></ol></li></ol></li><li class="chapter-item "><a href="../operations/index.html"><strong aria-hidden="true">7.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">7.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">7.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">7.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">7.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">7.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">7.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../operations/jobs.html"><strong aria-hidden="true">7.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">7.7.1.</strong> Navigational Suggestions</a></li><li class="chapter-item "><a href="../operations/jobs/dynamic-wiki-indexer.html"><strong aria-hidden="true">7.7.2.</strong> Dynamic Wikipedia Indexer</a></li><li class="chapter-item "><a href="../operations/jobs/csv-remote-settings.html"><strong aria-hidden="true">7.7.3.</strong> Remote Settings CSV Uploader</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item expanded "><a href="../adr/index.html"><strong aria-hidden="true">8.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">8.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">8.2.</strong> General API Response</a></li><li class="chapter-item "><a href="../adr/0003-test-containers.html"><strong aria-hidden="true">8.3.</strong> Adopt Testcontainers for Integration Testing</a></li><li class="chapter-item "><a href="../adr/0004-default-load-tests.html"><strong aria-hidden="true">8.4.</strong> Default Load Tests</a></li><li class="chapter-item expanded "><a href="../adr/0005-asynchronous-gcs-client.html" class="active"><strong aria-hidden="true">8.5.</strong> Adopt Asynchronous Python Google Cloud Storage Client</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="asycnchronous-python-google-cloud-storage-client"><a class="header" href="#asycnchronous-python-google-cloud-storage-client">Asycnchronous Python Google Cloud Storage Client</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Deciders: Nan Jiang, Herraj Luhano</li>
<li>Date: 2025-02-04</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>The Merino application has expanded to include the <code>/manifest</code> endpoint that interacts with a Google Cloud Storage (GCS) bucket. Currently, Merino relies on the official Google Cloud Python client (<code>google-cloud-storage</code>) for interacting with GCS for weekly job runs, but this client is synchronous.</p>
<p>Since the <code>/manifest</code> endpoint handles requests in an asynchronous web environment, using a synchronous client would block the main thread, leading to performance issues. To work around this, we currently offload GCS operations to thread pool dedicated for running synchronous workloads, but this adds unnecessary complexity.</p>
<p>To simplify the implementation and fully leverage asynchronous capabilities, we are considering adopting <code>talkiq/gcloud-aio-storage</code>, a community-supported asynchronous Python client for Google Cloud Storage. This would allow us to perform GCS operations without blocking the main thread, leading to cleaner and more efficient code.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ol>
<li>Deteriorated performance due to <code>/manifest</code> requests blocking the main thread.</li>
<li>Additional complexity due to implementing custom logic for background tasks.</li>
</ol>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li>A. <code>gcloud-aio-storage</code>.</li>
<li>B. <code>google-cloud-storage</code> (Existing official synchronous Python client).</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option:</p>
<p><strong>A</strong>. <code>gcloud-aio-storage</code></p>
<p><code>gcloud-aio-storage</code> appears to be the most widely used community-supported async client for Google Cloud Storage. It has fairly decent documentation, is easy to set up and use, and aligns well with Merino’s asynchronous architecture. Adopting it will simplify integration while ensuring non-blocking GCS interactions in the <code>/manifest</code> endpoint.</p>
<h3 id="positive-consequences"><a class="header" href="#positive-consequences">Positive Consequences</a></h3>
<ul>
<li><strong>Seamless integration</strong> with existing implementation and logic. As an async client, it comes with native async APIs to GCS, which substantially simplifies the usage of GCS in Merino. Particularly, no more offloading synchronous calls over to the thread pool.</li>
<li><strong>Easy authentication</strong> -- No extra steps needed for authentication. Uses the same logic as the exisiting sync client.</li>
<li><strong>Provides other asynch clients as well</strong> -- <code>gcloud-aio</code> library has modules for other Google Cloud entities such as <code>BigQuery</code>, <code>PubSub</code>, e.t.c, which will be useful in the future.</li>
</ul>
<h3 id="negative-consequences"><a class="header" href="#negative-consequences">Negative Consequences</a></h3>
<ul>
<li><strong>The SDK api is slightly different to the official one</strong> --  When it comes to wrapper classes and return types. Although, it supports the basic wrapper classes for entities such as <code>Blob</code> and <code>Bucket</code>, some of the types are more raw / basic. This could be seen as allowing for implementation flexibility, however, it does introduce some verbosity.</li>
<li><strong>Not officially supported by Google</strong> -- Relying on community contributors for support and updates. Will have to migrate to the official async one if/when Google releases one.</li>
<li><strong>Two GCS clients</strong> -- Merino will use both the async client for the web app mode, and the official sync client for Merino jobs, which might cause confusion.</li>
</ul>
<h2 id="pros-and-cons-of-the-synchronous-client"><a class="header" href="#pros-and-cons-of-the-synchronous-client">Pros and Cons of the Synchronous Client</a></h2>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>
<p><strong>Officially Supported by Google</strong> – Maintained and supported by Google, ensuring long-term reliability, security updates, and compatibility with GCS features.</p>
</li>
<li>
<p><strong>Official Documentation &amp; Large User Base</strong> – Extensive official documentation and a large user base, making it easier to find solutions to issues.</p>
</li>
<li>
<p><strong>Consistent with Existing Usage</strong> – Already used in Merino’s jobs component, reducing the need to maintain multiple clients for the same service.</p>
</li>
<li>
<p><strong>No Additional Dependencies</strong> – Avoids adding a third-party dependency, reducing potential maintenance overhead.</p>
</li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>
<p><strong>Blocks the Main Thread</strong> – The client is synchronous, which can lead to performance issues in Merino’s <code>/manifest</code> endpoint by blocking request handling.</p>
</li>
<li>
<p><strong>Workarounds Add Complexity</strong> – Using background tasks to offload GCS operations introduces unnecessary complexity and potential race conditions.</p>
</li>
<li>
<p><strong>Inconsistent with Merino’s Async Architecture</strong> – Merino is built to be asynchronous, and using a sync client requires special handling, breaking architectural consistency.</p>
</li>
<li>
<p><strong>Potential Scalability Issues</strong> – Blocking I/O operations can slow down request processing under high load, reducing overall efficiency.</p>
</li>
<li>
<p><strong>Misses Out on Async Benefits</strong> – Async clients improve responsiveness and throughput by allowing other tasks to execute while waiting for network responses.</p>
</li>
</ul>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://github.com/talkiq/gcloud-aio">Github repo for talkiq/gcloud-aio</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../adr/0004-default-load-tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../adr/0004-default-load-tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
