<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Default Load Tests - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../manifest.html"><strong aria-hidden="true">2.</strong> Working with the Manifest file</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">3.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item "><a href="../social-contract.html"><strong aria-hidden="true">5.</strong> Social contract</a></li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">6.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">6.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">6.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">6.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">6.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">6.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">6.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">6.7.</strong> Profiling</a></li><li class="chapter-item "><a href="../testing/index.html"><strong aria-hidden="true">6.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/unit-tests.html"><strong aria-hidden="true">6.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../testing/integration-tests.html"><strong aria-hidden="true">6.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="../testing/load-tests.html"><strong aria-hidden="true">6.8.3.</strong> Load Tests</a></li></ol></li></ol></li><li class="chapter-item "><a href="../operations/index.html"><strong aria-hidden="true">7.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">7.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">7.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">7.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">7.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">7.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">7.6.</strong> Elasticsearch</a></li><li class="chapter-item "><a href="../operations/jobs.html"><strong aria-hidden="true">7.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">7.7.1.</strong> Navigational Suggestions</a></li><li class="chapter-item "><a href="../operations/jobs/dynamic-wiki-indexer.html"><strong aria-hidden="true">7.7.2.</strong> Dynamic Wikipedia Indexer</a></li><li class="chapter-item "><a href="../operations/jobs/csv-remote-settings.html"><strong aria-hidden="true">7.7.3.</strong> Remote Settings CSV Uploader</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item expanded "><a href="../adr/index.html"><strong aria-hidden="true">8.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">8.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">8.2.</strong> General API Response</a></li><li class="chapter-item "><a href="../adr/0003-test-containers.html"><strong aria-hidden="true">8.3.</strong> Adopt Testcontainers for Integration Testing</a></li><li class="chapter-item expanded "><a href="../adr/0004-default-load-tests.html" class="active"><strong aria-hidden="true">8.4.</strong> Default Load Tests</a></li><li class="chapter-item "><a href="../adr/0005-asynchronous-gcs-client.html"><strong aria-hidden="true">8.5.</strong> Adopt Asynchronous Python Google Cloud Storage Client</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="assure-endpoint-functionality-and-load-test-suite-integrity-with-default-load-tests"><a class="header" href="#assure-endpoint-functionality-and-load-test-suite-integrity-with-default-load-tests">Assure Endpoint Functionality and Load Test Suite Integrity with Default Load Tests</a></h1>
<ul>
<li><strong>Status:</strong> Accepted</li>
<li><strong>Deciders:</strong> Katrina Anderson &amp; Nan Jiang</li>
<li><strong>Date:</strong> 2024-11-04</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Currently, load tests for the Merino service are executed on an opt-in basis, requiring contributors
to use their judgement to execute load tests as part of a deployment to production. Contributors
opt-in to load testing by including the <code>[load test: (abort|warn)]</code> substring in their commit
message. The <code>abort</code> option prevents a production deployment if the load testing fails, while the
<code>warn</code> option provides a warning via Slack and allows the deployment to continue in the event of
failure.</p>
<p>This strategy has several drawbacks:</p>
<ul>
<li>Load tests are run infrequently, making it difficult to establish performance trends or trace
regressions to specific changes</li>
<li>Relying on contributors to decide when to run load tests has proven unreliable. Developers
occasionally introduce changes that silently break the load testing suite, particularly when
new dependencies are added (Example: <a href="https://mozilla-hub.atlassian.net/browse/DISCO-3026">DISCO-3026</a>)</li>
<li>The SRE team currently lacks the capacity to implement a weekly load test build (Example:
<a href="https://mozilla-hub.atlassian.net/browse/SVCSE-2236">SVCSE-2236</a>)
<ul>
<li>On a related note, due to the same capacity issues, the SRE team has indicated that a smoke
test suite can't be integrated into the CD pipeline until Merino moves from GCP v1 to GCP v2,
leaving a gap in coverage (Example <a href="https://mozilla-hub.atlassian.net/browse/DISCO-2861?focusedCommentId=910707">DISCO-2861</a>)</li>
</ul>
</li>
</ul>
<p>Given these drawbacks, is there a way to provide greater consistency and more reliable feedback on
the performance of Merino's API endpoints and the health of its load test suite?</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<p><strong>Resource Consumption</strong><br />
The solution should ensure API quotas with third-party providers, such as AccuWeather, are
respected.</p>
<p><strong>Load Test Break Detection</strong><br />
The solution should notify contributors when they introduce changes that break the load tests.</p>
<p><strong>Performance Trending</strong><br />
The solution should enable the establishment of consistent and reliable performance trends for
Merino-py endpoints, allowing contributors to quickly identify regressions.</p>
<p><strong>Deployment Efficiency</strong><br />
The solution should minimize delays in the deployment process while ensuring that critical issues
are flagged promptly.</p>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li>A. Turn on <code>[load test: warn]</code> by default with opt-out option</li>
<li>B. Turn on <code>[load test: abort]</code> by default with opt-out option</li>
<li>C. Weekly manual execution of load tests</li>
<li>D. Status quo: Keep current strategy</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p><strong>Chosen option: A. Turn on <code>[load test: warn]</code> by default with opt-out option</strong></p>
<p>Until a weekly load test run and smoke tests can be incorporated into the CD pipeline, the decision
is to turn on <code>[load test: warn]</code> by default and add an opt-out option, <code>[load test: skip]</code>. This
will provide much-needed insight into the performance and health of Merino’s API endpoints, while
giving contributors early feedback on the integrity of the load test suite. Additionally, this
approach will pave the way for the deprecation of Contract Tests, reducing overall test maintenance.</p>
<p><strong>Note:</strong> The policy for documenting load test results in the <a href="https://docs.google.com/spreadsheets/d/1SAO3QYIrbxDRxzmYIab-ebZXA1dF06W1lT4I1h2R3a8/edit?gid=0#gid=0">Merino Load Test spreadsheet</a> will
remain unchanged. Contributors may decide when it's necessary to do so, for example when a load test
fails.</p>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2>
<h3 id="a-turn-on-load-test-warn-by-default-with-opt-out-option"><a class="header" href="#a-turn-on-load-test-warn-by-default-with-opt-out-option">A. Turn on <code>[load test: warn]</code> by default with opt-out option</a></h3>
<p>This option would ensure that load tests run automatically during deployments, with failures
generating warnings but not blocking the deployment. Contributors would have the ability to opt-out
of load tests using a new option, <code>[load test: skip]</code>.</p>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>Load tests would run more frequently, providing consistent feedback on Merino API endpoints and
acting as a lightweight smoke test</li>
<li>Contributors would receive early warnings if their changes break the load test suite, allowing
issues to be traced back to specific pull requests</li>
<li>The work required to implement this change is minimal and includes:
<ul>
<li>Modifying the smoke load test curve to minimize runtime and API resource consumption</li>
<li>Updating the CircleCI configuration</li>
<li>Updating documentation</li>
</ul>
</li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>This approach would increase deployment time by approximately 10 minutes and could worsen an
existing issue where concurrent merges to the main branch do not queue as expected, resulting in
simultaneous deployments that may invalidate load tests</li>
<li>If production deployments were to increase dramatically, there is potential to exceed
3rd party API quotas</li>
</ul>
<h3 id="b-turn-on-load-test-abort-by-default-with-opt-out-option"><a class="header" href="#b-turn-on-load-test-abort-by-default-with-opt-out-option">B. Turn on <code>[load test: abort]</code> by default with opt-out option</a></h3>
<p>This option would also ensure that load tests run automatically during deployments, but production
deployments would be blocked if the load tests fail. Contributors would have the option to opt-out
of load tests with a new option, <code>[load test: skip]</code>.</p>
<h4 id="pros-1"><a class="header" href="#pros-1">Pros</a></h4>
<p><em>Includes the Pros from Option A, plus:</em></p>
<ul>
<li>Ensures that broken API endpoints are not deployed to users, maintaining the integrity of the
service</li>
</ul>
<h4 id="cons-1"><a class="header" href="#cons-1">Cons</a></h4>
<p><em>Includes the Cons from Option A, plus:</em></p>
<ul>
<li>Critical features and fixes may be delayed if the load tests themselves are broken, leading to
unnecessary deployment blockages</li>
</ul>
<h3 id="c-weekly-manual-execution-of-load-tests"><a class="header" href="#c-weekly-manual-execution-of-load-tests">C. Weekly manual execution of load tests</a></h3>
<p>This option involves a member of the DISCO team manually triggering a load test on a weekly basis.
The load test could be triggered via PR or manually via a bash script.</p>
<h4 id="pros-2"><a class="header" href="#pros-2">Pros</a></h4>
<ul>
<li>Regular load testing would allow the team to establish meaningful performance trends</li>
<li>Breaks in the load test suite would be detected within a reasonable timeframe, making them easier
to trace</li>
</ul>
<h4 id="cons-2"><a class="header" href="#cons-2">Cons</a></h4>
<ul>
<li>This approach does not address the coverage gap for API endpoint verification during deployment</li>
<li>It is time-consuming for the DISCO team, and depending on the trigger technique, it may be
error-prone
<ul>
<li>For example, if a DISCO team member triggers the load test via bash script and forgets to tear
down the GCP cluster after use, unnecessary costs will be incurred</li>
</ul>
</li>
</ul>
<h3 id="d-status-quo-keep-current-strategy"><a class="header" href="#d-status-quo-keep-current-strategy">D. Status quo: Keep current strategy</a></h3>
<p>This option involves continuing with the current opt-in approach, where load tests are only run if
contributors explicitly include them in their deployment process, until the SRE team can prioritize
test strategy changes.</p>
<h4 id="pros-3"><a class="header" href="#pros-3">Pros</a></h4>
<ul>
<li>Requires no additional work or changes to the current setup.</li>
</ul>
<h4 id="cons-3"><a class="header" href="#cons-3">Cons</a></h4>
<ul>
<li>Breakages in the load testing suite due to environmental, configuration, or dependency changes
will continue to go undetected</li>
<li>The lack of regular load tests prevents contributors from gathering sufficient data to establish
meaningful performance trends</li>
</ul>
<!-- References -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../adr/0003-test-containers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../adr/0005-asynchronous-gcs-client.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../adr/0003-test-containers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../adr/0005-asynchronous-gcs-client.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
