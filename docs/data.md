# Data collection

This page should list all metrics and logs that Merino is expected to emit in
production, including what should be done about them, if anything.

## Logs

This list does not include any `DEBUG` level events, since those are not logged
by default in production. The level and type of the log is listed.

Any log containing sensitive data must include a boolean field `sensitive`
that is set to `true` to exempt it from flowing to the generally accessible
log inspection interfaces.

### Merino APIs

- `INFO web.suggest.request` - A suggestion request is being processed. This
  event will include fields for all relevant details of the request. **Fields:**

  - `sensitive` - Always set to true to ensure proper routing.
  - `query` - If query logging is enabled, the text the user typed. Otherwise an
    empty string.
  - `country` - The country the request came from.
  - `region` - The first country subdivision the request came from.
  - `city` - The city the request came from.
  - `dma` - A US-only location description that is larger than city and smaller
    than states, but does not align to political borders.
  - `agent` - The original user agent.
  - `os_family` - Parsed from the user agent. One of "windows", "macos",
    "linux", "ios", "android", "chrome os", "blackberry", or "other".
  - `form_factor` - Parsed from the user agent. One of "desktop", "phone",
    "tablet", or "other"
  - `browser` - The browser and possibly version detected. Either "Firefox(XX)"
    where XX is the version, or "Other".
  - `rid` - The request ID.
  - WIP `accepts_english` - True if the user's Accept-Language header includes an
    English locale, false otherwise.
  - `requested_providers` - A comma separated list of providers requested via
    the query string, or an empty string if none were requested (in which case
    the default values would be used).
  - `client_variants` - Any client variants sent to Merino in the query string.
  - `session_id` - A UUID generated by the client for each search session.
  - `sequence_no` -  A client-side event counter (0-based) that records the query
    sequence within each search session.

- `INFO request.summary` - The application request summary that follows the [MozLog][]
  convention. This log is recorded for all incoming HTTP requests except for the
  suggest API endpoint.

[Mozlog]: https://wiki.mozilla.org/Firefox/Services/Logging

- `ERROR dockerflow.error_endpoint` - The `__error__` endpoint of the server was
  called. This is used to test our error reporting system. It is not a cause for
  concern, unless we receive a large amount of these records, in which case some
  outside service is likely malicious or misconfigured.

### Merino Middleware Logs

#### Geolocation

- `WARNING merino.middleware.geolocation` - There was an error with a geolocation lookup.

### Merino Cron Tasks

- `WARNING merino.cron` - There was an error while executing a cron task.

### Merino Feature Flags

- `ERROR merino.featureflags` - There was an error while attempting to assign a
  feature flag for a suggest API request.

## Metrics

> A note on timers: Statsd timers are measured in milliseconds, and are reported
> as integers (at least in Cadence). Milliseconds are often not precise enough
> for the tasks we want to measure in Merino. Instead we use generic histograms
> to record microsecond times. Metrics recorded in this way should have `-us`
> appended to their name, to mark the units used (since we shouldn't put the
> proper unit Î¼s in metric names).

- `merino.providers.initialize` - A timer to measure the overall initialization
  duration (in ms) for _all_ providers.

- `merino.providers.initialize.<provider>` - A timer to measure the initialization
  duration (in ms) for the given `<provider>`.

  **Example**:
  `merino.providers.initialize.adm`

- `<http_method>.<url_path>.status_codes.<status_code>` - A counter to measure
  the status codes of an HTTP method for the `<url_path>`.

  **Example**:
  `get.api.v1.suggest.status_codes.200`

- `<http_method>.<url_path>.timing` - A timer to measure the duration (in ms)
  of an HTTP method for a URL path.

  **Example**:
  `get.api.v1.suggest.timing`

- `<provider_module>.query` - A timer to measure the query duration (in ms) of
  a certain suggestion provider.

  **Example**:
  `merino.provider.adm.query`
