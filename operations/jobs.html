<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Jobs - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Intro</a></li><li class="chapter-item affix "><li class="part-title">General Documentation</li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item "><a href="../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item "><a href="../data.html"><strong aria-hidden="true">3.</strong> Data collection</a></li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">4.</strong> Working on the Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/content-moderation.html"><strong aria-hidden="true">4.1.</strong> Content Moderation</a></li><li class="chapter-item "><a href="../dev/dependencies.html"><strong aria-hidden="true">4.2.</strong> Dependencies</a></li><li class="chapter-item "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">4.3.</strong> Logging and Metrics</a></li><li class="chapter-item "><a href="../dev/middlewares.html"><strong aria-hidden="true">4.4.</strong> Middlewares</a></li><li class="chapter-item "><a href="../dev/feature_flags.html"><strong aria-hidden="true">4.5.</strong> Feature Flags</a></li><li class="chapter-item "><a href="../dev/release-process.html"><strong aria-hidden="true">4.6.</strong> Release Process</a></li><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">4.7.</strong> Profiling</a></li><li class="chapter-item "><a href="../testing/index.html"><strong aria-hidden="true">4.8.</strong> Testing & Test Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/unit-tests.html"><strong aria-hidden="true">4.8.1.</strong> Unit Tests</a></li><li class="chapter-item "><a href="../testing/integration-tests.html"><strong aria-hidden="true">4.8.2.</strong> Integration Tests</a></li><li class="chapter-item "><a href="../testing/load-tests.html"><strong aria-hidden="true">4.8.3.</strong> Load Tests</a></li><li class="chapter-item "><a href="../testing/contract-tests/index.html"><strong aria-hidden="true">4.8.4.</strong> Contract Tests</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../testing/contract-tests/kinto-setup.html"><strong aria-hidden="true">4.8.4.1.</strong> Kinto Setup</a></li><li class="chapter-item "><a href="../testing/contract-tests/client.html"><strong aria-hidden="true">4.8.4.2.</strong> Client</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../operations/index.html"><strong aria-hidden="true">5.</strong> Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">5.1.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/blocklist-nav-suggestions.html"><strong aria-hidden="true">5.2.</strong> Modify Navigational Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/blocklist-wikipedia.html"><strong aria-hidden="true">5.3.</strong> Modify Wikipedia Suggestions Blocklist</a></li><li class="chapter-item "><a href="../operations/testfailures.html"><strong aria-hidden="true">5.4.</strong> Test Failures in CI</a></li><li class="chapter-item "><a href="../operations/configs.html"><strong aria-hidden="true">5.5.</strong> Configs</a></li><li class="chapter-item "><a href="../operations/elasticsearch.html"><strong aria-hidden="true">5.6.</strong> Elasticsearch</a></li><li class="chapter-item expanded "><a href="../operations/jobs.html" class="active"><strong aria-hidden="true">5.7.</strong> Jobs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/jobs/navigational_suggestions.html"><strong aria-hidden="true">5.7.1.</strong> Navigational Suggestions</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="../adr/index.html"><strong aria-hidden="true">6.</strong> Archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../adr/0001-locust-vs-k6-merino-py-performance-test-framework.html"><strong aria-hidden="true">6.1.</strong> Load Test Framework: Locust VS K6</a></li><li class="chapter-item "><a href="../adr/0002-merino-general-response.html"><strong aria-hidden="true">6.2.</strong> General API Response</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino-jobs-operations"><a class="header" href="#merino-jobs-operations">Merino Jobs Operations</a></h1>
<h2 id="dynamic-wikipedia"><a class="header" href="#dynamic-wikipedia">Dynamic Wikipedia</a></h2>
<p>Merino currently builds the Elasticsearch indexing job that runs in Airflow.
Airflow takes the <code>latest</code> image built as the base image.
The reasons to keep the job code close to the application code are:</p>
<ol>
<li>Data models can be shared between the indexing job and application more easily. 
This means that data migrations will be simpler.</li>
<li>All the logic regarding Merino functionality can be found in one place.</li>
<li>Eliminates unintended differences in functionality due to dependency mismatch.</li>
</ol>
<h3 id="where-to-find-and-modify-the-jobs"><a class="header" href="#where-to-find-and-modify-the-jobs">Where to find and modify the jobs</a></h3>
<p>The job is configured in <a href="https://github.com/mozilla/telemetry-airflow"><code>telemetry-airflow</code></a>.</p>
<p>You can access the job in the 
<a href="https://workflow.telemetry.mozilla.org/dags/merino_jobs/grid?search=merino_jobs">Airflow Console</a>.</p>
<h2 id="csv-remote-settings-uploader"><a class="header" href="#csv-remote-settings-uploader">CSV remote settings uploader</a></h2>
<p>The CSV remote settings uploader is a job that uploads suggestions data in a CSV
file to remote settings. It takes two inputs:</p>
<ol>
<li>A CSV file. The first row in the file is assumed to be a header that names
the fields (columns) in the data.</li>
<li>A Python module that validates the CSV contents and describes how to convert
it into suggestions JSON.</li>
</ol>
<p>If you're uploading suggestions from a Google sheet, you can export a CSV file
from File &gt; Download &gt; Comma Separated Values (.csv). Make sure the first row in
the sheet is a header that names the columns.</p>
<h3 id="uploading-suggestions-step-by-step"><a class="header" href="#uploading-suggestions-step-by-step">Uploading suggestions (Step by step)</a></h3>
<p>If you're uploading a type of suggestion that the uploader already supports,
skip to <a href="#running-the-uploader">Running the uploader</a> below. If you're not sure
whether it's supported, check in the <code>merino/jobs/csv_rs_uploader/</code> directory
for a file named similarly to the type.</p>
<p>To upload a new type of suggestion, follow the steps below. In summary, first
you'll create a Python module that implements a model for the suggestion type,
and then you'll run the uploader.</p>
<h4 id="1-create-a-python-model-module-for-the-new-suggestion-type"><a class="header" href="#1-create-a-python-model-module-for-the-new-suggestion-type">1. Create a Python model module for the new suggestion type</a></h4>
<p>Add a Python module to <code>merino/jobs/csv_rs_uploader/</code>. It's probably easiest to
copy an existing model module like <code>mdn.py</code>, follow along with the steps here,
and modify it for the new suggestion type. Name the file according to the
suggestion type.</p>
<p>This file will define the model of the new suggestion type as it will be
serialized in the output JSON, perform validation and conversion of the input
data in the CSV, and define how the input data should map to the output JSON.</p>
<h4 id="2-add-the-suggestion-class"><a class="header" href="#2-add-the-suggestion-class">2. Add the <code>Suggestion</code> class</a></h4>
<p>In the module, implement a class called <code>Suggestion</code> that derives from
<code>BaseSuggestion</code> in <code>merino.jobs.csv_rs_uploader.base</code>. This class will be the
model of the new suggestion type. <code>BaseSuggestion</code> itself derives from
Pydantic's <code>BaseModel</code>, so the validation the class will perform will be based
on <a href="https://docs.pydantic.dev/latest/usage/models/">Pydantic</a>, which is used throughout Merino. <code>BaseSuggestion</code> is
implemented in <code>base.py</code>.</p>
<h4 id="3-add-suggestion-fields-to-the-class"><a class="header" href="#3-add-suggestion-fields-to-the-class">3. Add suggestion fields to the class</a></h4>
<p>Add a field to the class for each property that should appear in the output JSON
(except <code>score</code>, which the uploader will add automatically). Name each field as
you would like it to be named in the JSON. Give each field a type so that
Pydantic can validate it. For URL fields, use <code>HttpUrl</code> from the <code>pydantic</code>
module.</p>
<h4 id="4-add-validator-methods-to-the-class"><a class="header" href="#4-add-validator-methods-to-the-class">4. Add validator methods to the class</a></h4>
<p>Add a method annotated with Pydanyic's <code>@field_validator</code> decorator for each field.
Each validator method should transform its field's input value into an appropriate output value and raise a <code>ValueError</code> if the input value is invalid.
Pydantic will call these methods automatically as it performs validation.
Their return values will be used as the values in the output JSON.</p>
<p><code>BaseSuggestion</code> implements two helpers you should use:</p>
<ul>
<li><code>_validate_str()</code> - Validates a string value and returns the validated value.
Leading and trailing whitespace is stripped, and all whitespace is replaced
with spaces and collapsed. Returns the validated value.</li>
<li><code>_validate_keywords()</code> - The uploader assumes that lists of keywords are
serialized in the input data as comma-delimited strings. This helper method
takes a comma-delimited string and splits it into individual keyword strings.
Each keyword is converted to lowercase, some non-ASCII characters are replaced
with ASCII equivalents that users are more likely to type, leading and
trailing whitespace is stripped, and all whitespace is replaced with spaces
and collapsed. Returns the list of keyword strings.</li>
</ul>
<h4 id="5-implement-the-csv_to_json-class-method"><a class="header" href="#5-implement-the-csv_to_json-class-method">5. Implement the <code>csv_to_json()</code> class method</a></h4>
<p>Add a <code>@classmethod</code> to <code>Suggestion</code> called <code>csv_to_json()</code>. It should return a
<code>dict</code> that maps from field (column) names in the input CSV to property names in
the output JSON.</p>
<h4 id="6-add-a-test"><a class="header" href="#6-add-a-test">6. Add a test</a></h4>
<p>Add a test file to <code>tests/unit/jobs/csv_rs_uploader/</code>. See <code>test_mdn.py</code> as an
example. The test should perform a successful upload as well as uploads that
fail due to validation errors and missing fields (columns) in the input CSV.</p>
<p><code>utils.py</code> in the same directory implements helpers that your test should use:</p>
<ul>
<li><code>do_csv_test()</code> - Makes sure the uploader works correctly during a successful
upload. It takes either a path to a CSV file or a <code>list[dict]</code> that will be
used to create a file object (<code>StringIO</code>) for an in-memory CSV file. Prefer
passing in a <code>list[dict]</code> instead of creating a file and passing a path, since
it's simpler.</li>
<li><code>do_error_test()</code> - Makes sure a given error is raised when expected. Use
<code>ValidationError</code> from the <code>pydantic</code> module to check validation errors and
<code>MissingFieldError</code> from <code>merino.jobs.csv_rs_uploader</code> to check input CSV that
is missing an expected field (column).</li>
</ul>
<h4 id="7-run-the-test"><a class="header" href="#7-run-the-test">7. Run the test</a></h4>
<pre><code>$ MERINO_ENV=testing poetry run pytest tests/unit/jobs/csv_rs_uploader/test_foo.py
</code></pre>
<p>See also the main Merino development documentation for running unit tests.</p>
<h4 id="8-submit-a-pr"><a class="header" href="#8-submit-a-pr">8. Submit a PR</a></h4>
<p>Once your test is passing, submit a PR with your changes so that the new
suggestion type is committed to the repo. This step isn't necessary to run the
uploader and upload your suggestions, so you can come back to it later.</p>
<h4 id="9-upload"><a class="header" href="#9-upload">9. Upload!</a></h4>
<p>See <a href="#running-the-uploader">Running the uploader</a>.</p>
<h3 id="running-the-uploader"><a class="header" href="#running-the-uploader">Running the uploader</a></h3>
<p>Run the following from the repo's root directory to see documentation for all
options and their defaults. Note that the <code>upload</code> command is the only command
in the <code>csv-rs-uploader</code> job.</p>
<pre><code>poetry run merino-jobs csv-rs-uploader upload --help`
</code></pre>
<p>The uploader takes a CSV file as input, so you'll need to download or create one
first.</p>
<p>Here's an example that uploads suggestions in <code>foo.csv</code> to the remote settings
dev server:</p>
<pre><code>poetry run merino-jobs csv-rs-uploader upload \
  --server &quot;https://remote-settings-dev.allizom.org/v1&quot; \
  --bucket main-workspace \
  --csv-path foo.csv \
  --model-name foo \
  --record-type foo-suggestions \
  --auth &quot;Bearer ...&quot;
</code></pre>
<p>Let's break down each command-line option in this example:</p>
<ul>
<li><code>--server</code> - Suggestions will be uploaded to the remote settings dev server</li>
<li><code>--bucket</code> - The <code>main-workspace</code> bucket will be used</li>
<li><code>--csv-path</code> - The CSV input file is <code>foo.csv</code></li>
<li><code>--model-name</code> - The model module is named <code>foo</code>. Its path within the repo
would be <code>merino/jobs/csv_rs_uploader/foo.py</code></li>
<li><code>--record-type</code> - The <code>type</code> in the remote settings records created for these
suggestions will be set to <code>foo-suggestions</code>. This argument is optional and
defaults to <code>&quot;{model_name}-suggestions&quot;</code></li>
<li><code>--auth</code> - Your authentication header string from the server. To get a header,
log in to the server dashboard (don't forget to log in to the Mozilla VPN
first) and click the small clipboard icon near the top-right of the page,
after the text that shows your username and server URL. The page will show a
&quot;Header copied to clipboard&quot; toast notification if successful.</li>
</ul>
<h4 id="setting-suggestion-scores"><a class="header" href="#setting-suggestion-scores">Setting suggestion scores</a></h4>
<p>By default all uploaded suggestions will have a <code>score</code> property whose value is
defined in the <code>remote_settings</code> section of the Merino config. This default can
be overridden using <code>--score &lt;number&gt;</code>. The number should be a float between 0
and 1 inclusive.</p>
<h4 id="other-useful-options"><a class="header" href="#other-useful-options">Other useful options</a></h4>
<ul>
<li><code>--dry-run</code> - Log the output suggestions but don't upload them. The uploader
will still authenticate with the server, so <code>--auth</code> must still be given.</li>
</ul>
<h3 id="structure-of-the-remote-settings-data"><a class="header" href="#structure-of-the-remote-settings-data">Structure of the remote settings data</a></h3>
<p>The uploader uses <code>merino/jobs/utils/chunked_rs_uploader.py</code> to upload the
output suggestions. In short, suggestions will be chunked, and each chunk will
have a corresponding remote settings record with an attachment. The record's ID
will be generated from the <code>--record-type</code> option, and its type will be set to
<code>--record-type</code> exactly. The attachment will contain a JSON array of suggestion
objects in the chunk.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../operations/elasticsearch.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../operations/jobs/navigational_suggestions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../operations/elasticsearch.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../operations/jobs/navigational_suggestions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
